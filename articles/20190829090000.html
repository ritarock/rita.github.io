<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>docker-compose で Rails と Mysql を使う</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.b2562460c774f5a57980.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" as="script"/><link rel="preload" href="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" as="script"/></head><body><div id="__next"><div><div><div><h1>Ghostの囁き</h1><hr color="black"/></div><h2>docker-compose で Rails と Mysql を使う</h2><h2>ディレクトリ構成</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>./
</span>├── Dockerfile
<!-- -->├── docker-compose.yml
<!-- -->├── db_volume/
<!-- -->├── mysql-confd/
<!-- -->│   └── default_authentication.cnf
<!-- -->└── src/
<!-- -->    ├── Gemfile
<!-- -->    └── Gemfile.lock
</code></pre><h2>ファイルの説明</h2><h3>Dockerfile</h3><p>Rails のアプリ用の Dockerfile を定義する。
MySQL と連携するために mysql-client をインストールしている。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>FROM ruby:latest
</span>
<!-- -->RUN apt-get update -qq &amp;&amp; \
<!-- -->    apt-get install -y build-essential &amp;&amp; \
<!-- -->    apt-get install -y libpq-dev &amp;&amp; \
<!-- -->    apt-get install -y mysql-client &amp;&amp; \
<!-- -->    apt-get install -y nodejs
<!-- -->
<!-- -->RUN mkdir /myapp
<!-- -->ENV APP_ROOT /myapp
<!-- -->WORKDIR $APP_ROOT
<!-- -->ADD ./src/Gemfile $APP_ROOT/Gemfile
<!-- -->ADD ./src/Gemfile.lock $APP_ROOT/Gemfile.lock
<!-- -->
<!-- -->RUN bundle install
<!-- -->ADD ./src/ $APP_ROOT
</code></pre><h3>docker-compose</h3><p>MySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする。
また <code>./db_volume:/var/lib/mysql</code> で DB を永続化している。</p><p><a href="https://qiita.com/yensaki/items/9e453b7320ca2d0461c7">参考</a></p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yaml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">version</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&#x27;3&#x27;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">services</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">db</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> mysql</span><span class="token" style="color:#5F6364">:</span><span>latest
</span><span>    </span><span class="token key" style="color:#1990b8">volumes</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> ./mysql</span><span class="token" style="color:#5F6364">-</span><span>confd</span><span class="token" style="color:#5F6364">:</span><span>/etc/mysql/conf.d
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> ./db_volume</span><span class="token" style="color:#5F6364">:</span><span>/var/lib/mysql
</span><span>    </span><span class="token key" style="color:#1990b8">environment</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token key" style="color:#1990b8">MYSQL_ROOT_PASSWORD</span><span class="token" style="color:#5F6364">:</span><span> root
</span><span>      </span><span class="token key" style="color:#1990b8">MYSQL_DATABASE</span><span class="token" style="color:#5F6364">:</span><span> root
</span><span>    </span><span class="token key" style="color:#1990b8">ports</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3306:3306&quot;</span><span>
</span>
<span>  </span><span class="token key" style="color:#1990b8">web</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span> .
</span><span>    </span><span class="token key" style="color:#1990b8">command</span><span class="token" style="color:#5F6364">:</span><span> bundle exec rails s </span><span class="token" style="color:#5F6364">-</span><span>p 3000 </span><span class="token" style="color:#5F6364">-</span><span>b &#x27;0.0.0.0&#x27;
</span><span>    </span><span class="token key" style="color:#1990b8">volumes</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> ./src</span><span class="token" style="color:#5F6364">:</span><span>/myapp
</span><span>    </span><span class="token key" style="color:#1990b8">ports</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3000:3000&quot;</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">links</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> db</span></code></pre><h3>default_authentication.cnf</h3><p>認証用の設定ファイル。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-default_authentication.cnf" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>[mysqld]
</span>default_authentication_plugin= mysql_native_password
</code></pre><h3>Gemfile</h3><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Gemfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>source &#x27;https://rubygems.org&#x27;
</span>gem &#x27;rails&#x27;, &#x27;5.1.6&#x27;
</code></pre><p>Gemfile.lock も作成しておく(中身は空)。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ </span><span class="token" style="color:#2f9c0a">touch</span><span> ./src/Gemfile.lock</span></code></pre><h2>プロジェクトの構築</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker-compose run web rails new </span><span class="token" style="color:#1990b8">.</span><span> --force --database</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span>mysql --skip-bundle</span></code></pre><p><code>--skip-bundle</code> で gem のインストールを回避。
実行後 <code>./src</code> 配下に新しいアプリケーションが作成されている。</p><h2>データベースに接続</h2><p><code>./src/config/database.yml</code> の password と host を docker-compose で定義した内容に変更。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yaml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">default</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#e90;font-weight:normal">&amp;default</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">adapter</span><span class="token" style="color:#5F6364">:</span><span> mysql2
</span><span>  </span><span class="token key" style="color:#1990b8">encoding</span><span class="token" style="color:#5F6364">:</span><span> utf8
</span><span>  </span><span class="token key" style="color:#1990b8">pool</span><span class="token" style="color:#5F6364">:</span><span> &lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) </span><span class="token" style="color:#5F6364">{</span><span> </span><span class="token" style="color:#c92c2c">5</span><span> </span><span class="token" style="color:#5F6364">}</span><span> %</span><span class="token" style="color:#5F6364">&gt;</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">username</span><span class="token" style="color:#5F6364">:</span><span> root
</span><span>  </span><span class="token key" style="color:#1990b8">password</span><span class="token" style="color:#5F6364">:</span><span> root
</span><span>  </span><span class="token key" style="color:#1990b8">host</span><span class="token" style="color:#5F6364">:</span><span> db</span></code></pre><h2>dockerの起動</h2><p>ビルド。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker-compose build</span></code></pre><p>起動。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker-compose up</span></code></pre><h2>DBの作成</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker-compose run web rails db:create</span></code></pre><h2>確認</h2><p>ブラウザで<a href="javascript:void(0)">localhost:3000</a>にアクセス。</p><p>rails のコンテナにアクセスして DB との接続確認。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker </span><span class="token" style="color:#1990b8">exec</span><span> -it コンテナID /bin/bash</span></code></pre><p>接続したコンテナから DB に接続。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ rails dbconsole</span></code></pre><div><p><a href="/">TOPへ戻る</a></p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"articleData":{"id":"20190829090000","contentHtml":"\n## ディレクトリ構成\n```bash\n./\n├── Dockerfile\n├── docker-compose.yml\n├── db_volume/\n├── mysql-confd/\n│   └── default_authentication.cnf\n└── src/\n    ├── Gemfile\n    └── Gemfile.lock\n```\n\n## ファイルの説明\n### Dockerfile\nRails のアプリ用の Dockerfile を定義する。\nMySQL と連携するために mysql-client をインストールしている。\n```Dockerfile\nFROM ruby:latest\n\nRUN apt-get update -qq \u0026\u0026 \\\n    apt-get install -y build-essential \u0026\u0026 \\\n    apt-get install -y libpq-dev \u0026\u0026 \\\n    apt-get install -y mysql-client \u0026\u0026 \\\n    apt-get install -y nodejs\n\nRUN mkdir /myapp\nENV APP_ROOT /myapp\nWORKDIR $APP_ROOT\nADD ./src/Gemfile $APP_ROOT/Gemfile\nADD ./src/Gemfile.lock $APP_ROOT/Gemfile.lock\n\nRUN bundle install\nADD ./src/ $APP_ROOT\n```\n\n### docker-compose\nMySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする。\nまた `./db_volume:/var/lib/mysql` で DB を永続化している。\n\n[参考](https://qiita.com/yensaki/items/9e453b7320ca2d0461c7)  \n```yaml\nversion: '3'\nservices:\n  db:\n    image: mysql:latest\n    volumes:\n      - ./mysql-confd:/etc/mysql/conf.d\n      - ./db_volume:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: root\n    ports:\n      - \"3306:3306\"\n\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - ./src:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n```\n\n### default_authentication.cnf\n認証用の設定ファイル。\n```default_authentication.cnf\n[mysqld]\ndefault_authentication_plugin= mysql_native_password\n```\n\n### Gemfile\n```Gemfile\nsource 'https://rubygems.org'\ngem 'rails', '5.1.6'\n```\n\nGemfile.lock も作成しておく(中身は空)。\n```bash\n$ touch ./src/Gemfile.lock\n```\n\n## プロジェクトの構築\n```bash\n$ docker-compose run web rails new . --force --database=mysql --skip-bundle\n```\n\n`--skip-bundle` で gem のインストールを回避。\n実行後 `./src` 配下に新しいアプリケーションが作成されている。\n\n## データベースに接続\n`./src/config/database.yml` の password と host を docker-compose で定義した内容に変更。\n```yaml\ndefault: \u0026default\n  adapter: mysql2\n  encoding: utf8\n  pool: \u003c%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %\u003e\n  username: root\n  password: root\n  host: db\n```\n\n## dockerの起動\nビルド。\n```bash\n$ docker-compose build\n```\n\n起動。\n```bash\n$ docker-compose up\n```\n\n## DBの作成\n```bash\n$ docker-compose run web rails db:create\n```\n\n## 確認\nブラウザで[localhost:3000](localhost:3000)にアクセス。\n\nrails のコンテナにアクセスして DB との接続確認。\n```bash\n$ docker exec -it コンテナID /bin/bash\n```\n\n接続したコンテナから DB に接続。\n```bash\n$ rails dbconsole\n```\n","title":"docker-compose で Rails と Mysql を使う","date":20190829090000,"tags":["Docker","Rails","環境構築"]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"20190829090000"},"buildId":"QWc8DHS-uq54py8kpn7M8","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" async=""></script><script src="/_next/static/chunks/commons.b2562460c774f5a57980.js" async=""></script><script src="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" async=""></script><script src="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" async=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" async=""></script><script src="/_next/static/QWc8DHS-uq54py8kpn7M8/_buildManifest.js" async=""></script><script src="/_next/static/QWc8DHS-uq54py8kpn7M8/_ssgManifest.js" async=""></script></body></html>