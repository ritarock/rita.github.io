<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e5069c53c645de81365c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e5069c53c645de81365c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-189c53927ffd3caf09c3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework-2f612445bd50b211f15a.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-c8b51cc0a92c3008cd1b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7163558e7d92093a94d2.js" as="script"/><link rel="preload" href="/_next/static/chunks/996-109927db333074874af4.js" as="script"/><link rel="preload" href="/_next/static/chunks/394-1ac6c205f84cbd1b2925.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/articles/%5Bid%5D-6ddac1fc6283bcb21133.js" as="script"/></head><body><div id="__next"><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->Golang の 並列 / 並行 処理でいろいろ</b></h1><h2>並列 / 並行 処理</h2>
<ul>
<li>並列処理<!-- -->
<ul>
<li>Parallelism<!-- -->
<ul>
<li>同時に同じ処理が複数走る</li>
</ul>
</li>
</ul>
</li>
<li>並行処理<!-- -->
<ul>
<li>Concurrency<!-- -->
<ul>
<li>同時に色々な処理が走る</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>channel を使う</h2>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">process</span><span class="hljs-function hljs-params">(num </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, str </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; num; i++ {
</span><span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span>		fmt.Println(i, str)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Start&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;A&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;B&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;C&quot;</span><span>)
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Finish&quot;</span><span>)
</span>}
<!-- -->
<span></span><span style="color:#75715e">// Start</span><span>
</span><span></span><span style="color:#75715e">// 0 A</span><span>
</span><span></span><span style="color:#75715e">// 1 A</span><span>
</span><span></span><span style="color:#75715e">// 0 B</span><span>
</span><span></span><span style="color:#75715e">// 1 B</span><span>
</span><span></span><span style="color:#75715e">// 0 C</span><span>
</span><span></span><span style="color:#75715e">// 1 C</span><span>
</span><span></span><span style="color:#75715e">// Finish</span><span>
</span><span></span><span style="color:#75715e">// </span><span>
</span><span></span><span style="color:#75715e">// ________________________________________________________</span><span>
</span><span></span><span style="color:#75715e">// Executed in    6.30 secs      fish           external</span><span>
</span><span></span><span style="color:#75715e">//    usr time  192.00 millis  172.00 micros  191.83 millis</span><span>
</span><span></span><span style="color:#75715e">//    sys time  201.91 millis  759.00 micros  201.15 millis</span></code></div></pre>
<p>process の処理を並列化する。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">process</span><span class="hljs-function hljs-params">(num </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, str </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; num; i++ {
</span><span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span>		fmt.Println(i, str)
<!-- -->	}
<!-- -->}
<!-- -->
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	chA := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	chB := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	chC := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Start&quot;</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;A&quot;</span><span>)
</span><span>		chA &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;B&quot;</span><span>)
</span><span>		chB &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;C&quot;</span><span>)
</span><span>		chC &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<!-- -->	&lt;-chA
<!-- -->	&lt;-chB
<!-- -->	&lt;-chC
<!-- -->
<span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Finish&quot;</span><span>)
</span>}
<!-- -->
<span></span><span style="color:#75715e">// Start</span><span>
</span><span></span><span style="color:#75715e">// 0 B</span><span>
</span><span></span><span style="color:#75715e">// 0 A</span><span>
</span><span></span><span style="color:#75715e">// 0 C</span><span>
</span><span></span><span style="color:#75715e">// 1 C</span><span>
</span><span></span><span style="color:#75715e">// 1 A</span><span>
</span><span></span><span style="color:#75715e">// 1 B</span><span>
</span><span></span><span style="color:#75715e">// Finish</span><span>
</span><span></span><span style="color:#75715e">// </span><span>
</span><span></span><span style="color:#75715e">// ________________________________________________________</span><span>
</span><span></span><span style="color:#75715e">// Executed in    2.29 secs      fish           external</span><span>
</span><span></span><span style="color:#75715e">//    usr time  194.02 millis  178.00 micros  193.84 millis</span><span>
</span><span></span><span style="color:#75715e">//    sys time  207.43 millis  862.00 micros  206.57 millis</span></code></div></pre>
<h2>sync.WaitGroup を使う</h2>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Item </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	Id   </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Name </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">execLoop</span><span class="hljs-function hljs-params">(list []Item)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, item := </span><span style="color:#f92672;font-weight:bold">range</span><span> list {
</span>		doSomething(item)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">doSomething</span><span class="hljs-function hljs-params">(item Item)</span><span> {
</span><span>	item.Id += </span><span class="hljs-number">10</span><span>
</span>	fmt.Println(item)
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span>	list := []Item{
<span>		{Id: </span><span class="hljs-number">1</span><span>, Name: </span><span style="color:#a6e22e">&quot;item1&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">2</span><span>, Name: </span><span style="color:#a6e22e">&quot;item2&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">3</span><span>, Name: </span><span style="color:#a6e22e">&quot;item3&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">4</span><span>, Name: </span><span style="color:#a6e22e">&quot;item4&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">5</span><span>, Name: </span><span style="color:#a6e22e">&quot;item5&quot;</span><span>},
</span>	}
<!-- -->
<!-- -->	execLoop(list)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// {11 item1}</span><span>
</span><span></span><span style="color:#75715e">// {12 item2}</span><span>
</span><span></span><span style="color:#75715e">// {13 item3}</span><span>
</span><span></span><span style="color:#75715e">// {14 item4}</span><span>
</span><span></span><span style="color:#75715e">// {15 item5}</span></code></div></pre>
<p>ループ内の処理を並列化する。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Item </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	Id   </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Name </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">execLoop</span><span class="hljs-function hljs-params">(list []Item)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, item := </span><span style="color:#f92672;font-weight:bold">range</span><span> list {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(item2 Item)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span>			doSomething(item2)
<!-- -->		}(item)
<!-- -->	}
<!-- -->	wg.Wait()
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">doSomething</span><span class="hljs-function hljs-params">(item Item)</span><span> {
</span><span>	item.Id += </span><span class="hljs-number">10</span><span>
</span>	fmt.Println(item)
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span>	list := []Item{
<span>		{Id: </span><span class="hljs-number">1</span><span>, Name: </span><span style="color:#a6e22e">&quot;item1&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">2</span><span>, Name: </span><span style="color:#a6e22e">&quot;item2&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">3</span><span>, Name: </span><span style="color:#a6e22e">&quot;item3&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">4</span><span>, Name: </span><span style="color:#a6e22e">&quot;item4&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">5</span><span>, Name: </span><span style="color:#a6e22e">&quot;item5&quot;</span><span>},
</span>	}
<!-- -->
<!-- -->	execLoop(list)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// {15 item5}</span><span>
</span><span></span><span style="color:#75715e">// {11 item1}</span><span>
</span><span></span><span style="color:#75715e">// {14 item4}</span><span>
</span><span></span><span style="color:#75715e">// {13 item3}</span><span>
</span><span></span><span style="color:#75715e">// {12 item2}</span></code></div></pre>
<h2>sync.Mutex を使う</h2>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>		tmpObj.AttributeName = myObj.AttributeName
<span>		destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>	}
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 100</span></code></div></pre>
<p>sync.WaitGroup を使う。(ダメな例)
append はスレッドセーフではないので件数が減る。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(myObj2 myClass)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span><span>			</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>			tmpObj.AttributeName = myObj2.AttributeName
<span>			destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>		}(myObj)
<!-- -->	}
<!-- -->	wg.Wait()
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 75</span></code></div></pre>
<p><em><strong>-race</strong></em> を付けることで競合のチェックができる。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ go run -race main.go
</span>
<!-- -->~~ 省略 ~~
<!-- -->==================
<!-- -->97
</code></div></pre>
<p>sync.Mutex を使う。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span>	mu := &amp;sync.Mutex{}
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(myObj2 myClass)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span><span>			</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>			tmpObj.AttributeName = myObj2.AttributeName
<!-- -->			mu.Lock()
<span>			destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>			mu.Unlock()
<!-- -->		}(myObj)
<!-- -->	}
<!-- -->	wg.Wait()
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 100</span></code></div></pre>
<h2>ポーリング</h2>
<p><em><strong>len(q)</strong></em> は溜まったバッファ数を返す。<br/>
<em><strong>make</strong></em> で作るときはバッファ数を 2 以上で作らないと <em><strong>len(q)</strong></em> は常に 0 を返す。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	q := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">struct</span><span>{}, </span><span class="hljs-number">2</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		</span><span style="color:#75715e">// 重たい処理</span><span>
</span><span>		time.Sleep(</span><span class="hljs-number">3</span><span> * time.Second)
</span><span>		q &lt;- </span><span style="color:#f92672;font-weight:bold">struct</span><span>{}{}
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">if</span><span> </span><span style="color:#a6e22e">len</span><span>(q) &gt; </span><span class="hljs-number">0</span><span> {
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;完了&quot;</span><span>)
</span><span>			</span><span style="color:#f92672;font-weight:bold">break</span><span>
</span>		}
<span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span><span>		fmt.Println(</span><span style="color:#a6e22e">&quot;実行中&quot;</span><span>)
</span>	}
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 完了</span></code></div></pre>
<h2>ワーカー</h2>
<p><em><strong>close(q)</strong></em> されたら <em><strong>str, ok := &lt;- q</strong></em> の <em><strong>ok</strong></em> が <em><strong>false</strong></em> になる。</p>
<pre><div class="text-xs" node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">printString</span><span class="hljs-function hljs-params">(wg *sync.WaitGroup, q </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">chan</span><span class="hljs-function hljs-params"> </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span>		str, ok := &lt;-q
<span>		</span><span style="color:#f92672;font-weight:bold">if</span><span> !ok {
</span><span>			</span><span style="color:#f92672;font-weight:bold">return</span><span>
</span>		}
<!-- -->
<!-- -->		fmt.Println(str)
<span>		time.Sleep(</span><span class="hljs-number">3</span><span> * time.Second)
</span>	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">const</span><span> workerNum = </span><span class="hljs-number">3</span><span>
</span><span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	q := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">string</span><span>, </span><span class="hljs-number">5</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; workerNum; i++ {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> printString(&amp;wg, q)
</span>	}
<!-- -->
<span>	q &lt;- </span><span style="color:#a6e22e">&quot;test1&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test2&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test3&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test4&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test5&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">close</span><span>(q)
</span>	wg.Wait()
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// test2</span><span>
</span><span></span><span style="color:#75715e">// test1</span><span>
</span><span></span><span style="color:#75715e">// test3</span><span>
</span><span></span><span style="color:#75715e">// test5</span><span>
</span><span></span><span style="color:#75715e">// test4</span></code></div></pre></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"id":"20210429182820","fileContents":"{\n  \"title\": \"Golang の 並列 / 並行 処理でいろいろ\",\n  \"date\": 20210429182820,\n  \"tags\": [\n    \"golang\"\n  ],\n  \"bodyContent\": \"## 並列 / 並行 処理\\n- 並列処理\\n  - Parallelism\\n    - 同時に同じ処理が複数走る\\n- 並行処理\\n  - Concurrency\\n    - 同時に色々な処理が走る\\n\\n## channel を使う\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"time\\\"\\n)\\n\\nfunc process(num int, str string) {\\n\\tfor i := 0; i \u003c num; i++ {\\n\\t\\ttime.Sleep(1 * time.Second)\\n\\t\\tfmt.Println(i, str)\\n\\t}\\n}\\n\\nfunc main() {\\n\\tfmt.Println(\\\"Start\\\")\\n\\tprocess(2, \\\"A\\\")\\n\\tprocess(2, \\\"B\\\")\\n\\tprocess(2, \\\"C\\\")\\n\\tfmt.Println(\\\"Finish\\\")\\n}\\n\\n// Start\\n// 0 A\\n// 1 A\\n// 0 B\\n// 1 B\\n// 0 C\\n// 1 C\\n// Finish\\n// \\n// ________________________________________________________\\n// Executed in    6.30 secs      fish           external\\n//    usr time  192.00 millis  172.00 micros  191.83 millis\\n//    sys time  201.91 millis  759.00 micros  201.15 millis\\n```\\n\\nprocess の処理を並列化する。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"time\\\"\\n)\\n\\nfunc process(num int, str string) {\\n\\tfor i := 0; i \u003c num; i++ {\\n\\t\\ttime.Sleep(1 * time.Second)\\n\\t\\tfmt.Println(i, str)\\n\\t}\\n}\\n\\n\\nfunc main() {\\n\\tchA := make(chan bool)\\n\\tchB := make(chan bool)\\n\\tchC := make(chan bool)\\n\\tfmt.Println(\\\"Start\\\")\\n\\n\\tgo func() {\\n\\t\\tprocess(2, \\\"A\\\")\\n\\t\\tchA \u003c- true\\n\\t}()\\n\\n\\tgo func() {\\n\\t\\tprocess(2, \\\"B\\\")\\n\\t\\tchB \u003c- true\\n\\t}()\\n\\n\\tgo func() {\\n\\t\\tprocess(2, \\\"C\\\")\\n\\t\\tchC \u003c- true\\n\\t}()\\n\\n\\t\u003c-chA\\n\\t\u003c-chB\\n\\t\u003c-chC\\n\\n\\tfmt.Println(\\\"Finish\\\")\\n}\\n\\n// Start\\n// 0 B\\n// 0 A\\n// 0 C\\n// 1 C\\n// 1 A\\n// 1 B\\n// Finish\\n// \\n// ________________________________________________________\\n// Executed in    2.29 secs      fish           external\\n//    usr time  194.02 millis  178.00 micros  193.84 millis\\n//    sys time  207.43 millis  862.00 micros  206.57 millis\\n```\\n\\n## sync.WaitGroup を使う\\n```go\\npackage main\\n\\nimport \\\"fmt\\\"\\n\\ntype Item struct {\\n\\tId   int\\n\\tName string\\n}\\n\\nfunc execLoop(list []Item) {\\n\\tfor _, item := range list {\\n\\t\\tdoSomething(item)\\n\\t}\\n}\\n\\nfunc doSomething(item Item) {\\n\\titem.Id += 10\\n\\tfmt.Println(item)\\n}\\n\\nfunc main() {\\n\\tlist := []Item{\\n\\t\\t{Id: 1, Name: \\\"item1\\\"},\\n\\t\\t{Id: 2, Name: \\\"item2\\\"},\\n\\t\\t{Id: 3, Name: \\\"item3\\\"},\\n\\t\\t{Id: 4, Name: \\\"item4\\\"},\\n\\t\\t{Id: 5, Name: \\\"item5\\\"},\\n\\t}\\n\\n\\texecLoop(list)\\n}\\n\\n// {11 item1}\\n// {12 item2}\\n// {13 item3}\\n// {14 item4}\\n// {15 item5}\\n```\\n\\nループ内の処理を並列化する。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"sync\\\"\\n)\\n\\ntype Item struct {\\n\\tId   int\\n\\tName string\\n}\\n\\nfunc execLoop(list []Item) {\\n\\tvar wg sync.WaitGroup\\n\\tfor _, item := range list {\\n\\t\\twg.Add(1)\\n\\t\\tgo func(item2 Item) {\\n\\t\\t\\tdefer wg.Done()\\n\\t\\t\\tdoSomething(item2)\\n\\t\\t}(item)\\n\\t}\\n\\twg.Wait()\\n}\\n\\nfunc doSomething(item Item) {\\n\\titem.Id += 10\\n\\tfmt.Println(item)\\n}\\n\\nfunc main() {\\n\\tlist := []Item{\\n\\t\\t{Id: 1, Name: \\\"item1\\\"},\\n\\t\\t{Id: 2, Name: \\\"item2\\\"},\\n\\t\\t{Id: 3, Name: \\\"item3\\\"},\\n\\t\\t{Id: 4, Name: \\\"item4\\\"},\\n\\t\\t{Id: 5, Name: \\\"item5\\\"},\\n\\t}\\n\\n\\texecLoop(list)\\n}\\n\\n// {15 item5}\\n// {11 item1}\\n// {14 item4}\\n// {13 item3}\\n// {12 item2}\\n```\\n\\n## sync.Mutex を使う\\n```go\\npackage main\\n\\nimport \\\"fmt\\\"\\n\\ntype myClass struct {\\n\\tAttributeName string\\n}\\n\\nfunc main() {\\n\\tsourceSlice := make([]myClass, 100)\\n\\tdestSlice := make([]myClass, 0)\\n\\n\\tfor _, myObj := range sourceSlice {\\n\\t\\tvar tmpObj myClass\\n\\t\\ttmpObj.AttributeName = myObj.AttributeName\\n\\t\\tdestSlice = append(destSlice, tmpObj)\\n\\t}\\n\\tfmt.Println(len(destSlice))\\n}\\n\\n// 100\\n```\\n\\nsync.WaitGroup を使う。(ダメな例)\\nappend はスレッドセーフではないので件数が減る。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"sync\\\"\\n)\\n\\ntype myClass struct {\\n\\tAttributeName string\\n}\\n\\nfunc main() {\\n\\tsourceSlice := make([]myClass, 100)\\n\\tdestSlice := make([]myClass, 0)\\n\\n\\tvar wg sync.WaitGroup\\n\\tfor _, myObj := range sourceSlice {\\n\\t\\twg.Add(1)\\n\\t\\tgo func(myObj2 myClass) {\\n\\t\\t\\tdefer wg.Done()\\n\\t\\t\\tvar tmpObj myClass\\n\\t\\t\\ttmpObj.AttributeName = myObj2.AttributeName\\n\\t\\t\\tdestSlice = append(destSlice, tmpObj)\\n\\t\\t}(myObj)\\n\\t}\\n\\twg.Wait()\\n\\tfmt.Println(len(destSlice))\\n}\\n\\n// 75\\n```\\n\\n***-race*** を付けることで競合のチェックができる。\\n```bash\\n$ go run -race main.go\\n\\n~~ 省略 ~~\\n==================\\n97\\n```\\n\\nsync.Mutex を使う。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"sync\\\"\\n)\\n\\ntype myClass struct {\\n\\tAttributeName string\\n}\\n\\nfunc main() {\\n\\tsourceSlice := make([]myClass, 100)\\n\\tdestSlice := make([]myClass, 0)\\n\\n\\tvar wg sync.WaitGroup\\n\\tmu := \u0026sync.Mutex{}\\n\\tfor _, myObj := range sourceSlice {\\n\\t\\twg.Add(1)\\n\\t\\tgo func(myObj2 myClass) {\\n\\t\\t\\tdefer wg.Done()\\n\\t\\t\\tvar tmpObj myClass\\n\\t\\t\\ttmpObj.AttributeName = myObj2.AttributeName\\n\\t\\t\\tmu.Lock()\\n\\t\\t\\tdestSlice = append(destSlice, tmpObj)\\n\\t\\t\\tmu.Unlock()\\n\\t\\t}(myObj)\\n\\t}\\n\\twg.Wait()\\n\\tfmt.Println(len(destSlice))\\n}\\n\\n// 100\\n```\\n\\n## ポーリング\\n***len(q)*** は溜まったバッファ数を返す。  \\n***make*** で作るときはバッファ数を 2 以上で作らないと ***len(q)*** は常に 0 を返す。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"time\\\"\\n)\\n\\nfunc main() {\\n\\tq := make(chan struct{}, 2)\\n\\n\\tgo func() {\\n\\t\\t// 重たい処理\\n\\t\\ttime.Sleep(3 * time.Second)\\n\\t\\tq \u003c- struct{}{}\\n\\t}()\\n\\n\\tfor {\\n\\t\\tif len(q) \u003e 0 {\\n\\t\\t\\tfmt.Println(\\\"完了\\\")\\n\\t\\t\\tbreak\\n\\t\\t}\\n\\t\\ttime.Sleep(1 * time.Second)\\n\\t\\tfmt.Println(\\\"実行中\\\")\\n\\t}\\n}\\n\\n// 実行中\\n// 実行中\\n// 実行中\\n// 完了\\n```\\n\\n## ワーカー\\n***close(q)*** されたら ***str, ok := \u003c- q*** の ***ok*** が ***false*** になる。\\n```go\\npackage main\\n\\nimport (\\n\\t\\\"fmt\\\"\\n\\t\\\"sync\\\"\\n\\t\\\"time\\\"\\n)\\n\\nfunc printString(wg *sync.WaitGroup, q chan string) {\\n\\tdefer wg.Done()\\n\\n\\tfor {\\n\\t\\tstr, ok := \u003c-q\\n\\t\\tif !ok {\\n\\t\\t\\treturn\\n\\t\\t}\\n\\n\\t\\tfmt.Println(str)\\n\\t\\ttime.Sleep(3 * time.Second)\\n\\t}\\n}\\n\\nfunc main() {\\n\\tconst workerNum = 3\\n\\tvar wg sync.WaitGroup\\n\\tq := make(chan string, 5)\\n\\n\\tfor i := 0; i \u003c workerNum; i++ {\\n\\t\\twg.Add(1)\\n\\t\\tgo printString(\u0026wg, q)\\n\\t}\\n\\n\\tq \u003c- \\\"test1\\\"\\n\\tq \u003c- \\\"test2\\\"\\n\\tq \u003c- \\\"test3\\\"\\n\\tq \u003c- \\\"test4\\\"\\n\\tq \u003c- \\\"test5\\\"\\n\\tclose(q)\\n\\twg.Wait()\\n}\\n\\n// test2\\n// test1\\n// test3\\n// test5\\n// test4\\n```\",\n  \"bodyHtml\": \"\u003ch2\u003e並列 / 並行 処理\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e並列処理\\n\u003cul\u003e\\n\u003cli\u003eParallelism\\n\u003cul\u003e\\n\u003cli\u003e同時に同じ処理が複数走る\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003cli\u003e並行処理\\n\u003cul\u003e\\n\u003cli\u003eConcurrency\\n\u003cul\u003e\\n\u003cli\u003e同時に色々な処理が走る\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2\u003echannel を使う\u003c/h2\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;time\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003eprocess\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(num \u003cspan class=\\\"hljs-keyword\\\"\u003eint\u003c/span\u003e, str \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e i := \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e; i \u0026lt; num; i++ {\\n\\t\\ttime.Sleep(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e * time.Second)\\n\\t\\tfmt.Println(i, str)\\n\\t}\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;Start\u0026quot;\u003c/span\u003e)\\n\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;A\u0026quot;\u003c/span\u003e)\\n\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;B\u0026quot;\u003c/span\u003e)\\n\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;C\u0026quot;\u003c/span\u003e)\\n\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;Finish\u0026quot;\u003c/span\u003e)\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Start\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 A\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 A\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 B\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 B\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 C\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 C\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Finish\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// \u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// ________________________________________________________\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Executed in    6.30 secs      fish           external\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e//    usr time  192.00 millis  172.00 micros  191.83 millis\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e//    sys time  201.91 millis  759.00 micros  201.15 millis\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eprocess の処理を並列化する。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;time\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003eprocess\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(num \u003cspan class=\\\"hljs-keyword\\\"\u003eint\u003c/span\u003e, str \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e i := \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e; i \u0026lt; num; i++ {\\n\\t\\ttime.Sleep(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e * time.Second)\\n\\t\\tfmt.Println(i, str)\\n\\t}\\n}\\n\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tchA := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003ebool\u003c/span\u003e)\\n\\tchB := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003ebool\u003c/span\u003e)\\n\\tchC := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003ebool\u003c/span\u003e)\\n\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;Start\u0026quot;\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\t\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;A\u0026quot;\u003c/span\u003e)\\n\\t\\tchA \u0026lt;- \u003cspan class=\\\"hljs-literal\\\"\u003etrue\u003c/span\u003e\\n\\t}()\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\t\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;B\u0026quot;\u003c/span\u003e)\\n\\t\\tchB \u0026lt;- \u003cspan class=\\\"hljs-literal\\\"\u003etrue\u003c/span\u003e\\n\\t}()\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\t\\tprocess(\u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;C\u0026quot;\u003c/span\u003e)\\n\\t\\tchC \u0026lt;- \u003cspan class=\\\"hljs-literal\\\"\u003etrue\u003c/span\u003e\\n\\t}()\\n\\n\\t\u0026lt;-chA\\n\\t\u0026lt;-chB\\n\\t\u0026lt;-chC\\n\\n\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;Finish\u0026quot;\u003c/span\u003e)\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Start\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 B\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 A\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 0 C\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 C\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 A\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 1 B\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Finish\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// \u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// ________________________________________________________\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// Executed in    2.29 secs      fish           external\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e//    usr time  194.02 millis  178.00 micros  193.84 millis\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e//    sys time  207.43 millis  862.00 micros  206.57 millis\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003esync.WaitGroup を使う\u003c/h2\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e Item \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e {\\n\\tId   \u003cspan class=\\\"hljs-keyword\\\"\u003eint\u003c/span\u003e\\n\\tName \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003eexecLoop\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(list []Item)\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e _, item := \u003cspan class=\\\"hljs-keyword\\\"\u003erange\u003c/span\u003e list {\\n\\t\\tdoSomething(item)\\n\\t}\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003edoSomething\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(item Item)\u003c/span\u003e\u003c/span\u003e {\\n\\titem.Id += \u003cspan class=\\\"hljs-number\\\"\u003e10\u003c/span\u003e\\n\\tfmt.Println(item)\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tlist := []Item{\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item1\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item2\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e3\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item3\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e4\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item4\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e5\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item5\u0026quot;\u003c/span\u003e},\\n\\t}\\n\\n\\texecLoop(list)\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {11 item1}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {12 item2}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {13 item3}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {14 item4}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {15 item5}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eループ内の処理を並列化する。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;sync\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e Item \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e {\\n\\tId   \u003cspan class=\\\"hljs-keyword\\\"\u003eint\u003c/span\u003e\\n\\tName \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003eexecLoop\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(list []Item)\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e wg sync.WaitGroup\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e _, item := \u003cspan class=\\\"hljs-keyword\\\"\u003erange\u003c/span\u003e list {\\n\\t\\twg.Add(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e)\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(item2 Item)\u003c/span\u003e\u003c/span\u003e {\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003edefer\u003c/span\u003e wg.Done()\\n\\t\\t\\tdoSomething(item2)\\n\\t\\t}(item)\\n\\t}\\n\\twg.Wait()\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003edoSomething\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(item Item)\u003c/span\u003e\u003c/span\u003e {\\n\\titem.Id += \u003cspan class=\\\"hljs-number\\\"\u003e10\u003c/span\u003e\\n\\tfmt.Println(item)\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tlist := []Item{\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item1\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item2\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e3\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item3\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e4\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item4\u0026quot;\u003c/span\u003e},\\n\\t\\t{Id: \u003cspan class=\\\"hljs-number\\\"\u003e5\u003c/span\u003e, Name: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;item5\u0026quot;\u003c/span\u003e},\\n\\t}\\n\\n\\texecLoop(list)\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {15 item5}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {11 item1}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {14 item4}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {13 item3}\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// {12 item2}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003esync.Mutex を使う\u003c/h2\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e myClass \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e {\\n\\tAttributeName \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tsourceSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e100\u003c/span\u003e)\\n\\tdestSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e _, myObj := \u003cspan class=\\\"hljs-keyword\\\"\u003erange\u003c/span\u003e sourceSlice {\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e tmpObj myClass\\n\\t\\ttmpObj.AttributeName = myObj.AttributeName\\n\\t\\tdestSlice = \u003cspan class=\\\"hljs-built_in\\\"\u003eappend\u003c/span\u003e(destSlice, tmpObj)\\n\\t}\\n\\tfmt.Println(\u003cspan class=\\\"hljs-built_in\\\"\u003elen\u003c/span\u003e(destSlice))\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 100\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003esync.WaitGroup を使う。(ダメな例)\\nappend はスレッドセーフではないので件数が減る。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;sync\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e myClass \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e {\\n\\tAttributeName \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tsourceSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e100\u003c/span\u003e)\\n\\tdestSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e wg sync.WaitGroup\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e _, myObj := \u003cspan class=\\\"hljs-keyword\\\"\u003erange\u003c/span\u003e sourceSlice {\\n\\t\\twg.Add(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e)\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(myObj2 myClass)\u003c/span\u003e\u003c/span\u003e {\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003edefer\u003c/span\u003e wg.Done()\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e tmpObj myClass\\n\\t\\t\\ttmpObj.AttributeName = myObj2.AttributeName\\n\\t\\t\\tdestSlice = \u003cspan class=\\\"hljs-built_in\\\"\u003eappend\u003c/span\u003e(destSlice, tmpObj)\\n\\t\\t}(myObj)\\n\\t}\\n\\twg.Wait()\\n\\tfmt.Println(\u003cspan class=\\\"hljs-built_in\\\"\u003elen\u003c/span\u003e(destSlice))\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 75\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cem\u003e\u003cstrong\u003e-race\u003c/strong\u003e\u003c/em\u003e を付けることで競合のチェックができる。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e$ go run -race main.go\\n\\n~~ 省略 ~~\\n==================\\n97\u003c/code\u003e\u003c/pre\u003e\u003cp\u003esync.Mutex を使う。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;sync\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e myClass \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e {\\n\\tAttributeName \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tsourceSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e100\u003c/span\u003e)\\n\\tdestSlice := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e([]myClass, \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e wg sync.WaitGroup\\n\\tmu := \u0026amp;sync.Mutex{}\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e _, myObj := \u003cspan class=\\\"hljs-keyword\\\"\u003erange\u003c/span\u003e sourceSlice {\\n\\t\\twg.Add(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e)\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(myObj2 myClass)\u003c/span\u003e\u003c/span\u003e {\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003edefer\u003c/span\u003e wg.Done()\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e tmpObj myClass\\n\\t\\t\\ttmpObj.AttributeName = myObj2.AttributeName\\n\\t\\t\\tmu.Lock()\\n\\t\\t\\tdestSlice = \u003cspan class=\\\"hljs-built_in\\\"\u003eappend\u003c/span\u003e(destSlice, tmpObj)\\n\\t\\t\\tmu.Unlock()\\n\\t\\t}(myObj)\\n\\t}\\n\\twg.Wait()\\n\\tfmt.Println(\u003cspan class=\\\"hljs-built_in\\\"\u003elen\u003c/span\u003e(destSlice))\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 100\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eポーリング\u003c/h2\u003e\\n\u003cp\u003e\u003cem\u003e\u003cstrong\u003elen(q)\u003c/strong\u003e\u003c/em\u003e は溜まったバッファ数を返す。\u003cbr\u003e\\n\u003cem\u003e\u003cstrong\u003emake\u003c/strong\u003e\u003c/em\u003e で作るときはバッファ数を 2 以上で作らないと \u003cem\u003e\u003cstrong\u003elen(q)\u003c/strong\u003e\u003c/em\u003e は常に 0 を返す。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;time\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\tq := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e{}, \u003cspan class=\\\"hljs-number\\\"\u003e2\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e \u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\t\\t\u003cspan class=\\\"hljs-comment\\\"\u003e// 重たい処理\u003c/span\u003e\\n\\t\\ttime.Sleep(\u003cspan class=\\\"hljs-number\\\"\u003e3\u003c/span\u003e * time.Second)\\n\\t\\tq \u0026lt;- \u003cspan class=\\\"hljs-keyword\\\"\u003estruct\u003c/span\u003e{}{}\\n\\t}()\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e {\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003eif\u003c/span\u003e \u003cspan class=\\\"hljs-built_in\\\"\u003elen\u003c/span\u003e(q) \u0026gt; \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e {\\n\\t\\t\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;完了\u0026quot;\u003c/span\u003e)\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ebreak\u003c/span\u003e\\n\\t\\t}\\n\\t\\ttime.Sleep(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e * time.Second)\\n\\t\\tfmt.Println(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;実行中\u0026quot;\u003c/span\u003e)\\n\\t}\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 実行中\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 実行中\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 実行中\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// 完了\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eワーカー\u003c/h2\u003e\\n\u003cp\u003e\u003cem\u003e\u003cstrong\u003eclose(q)\u003c/strong\u003e\u003c/em\u003e されたら \u003cem\u003e\u003cstrong\u003estr, ok := \u0026lt;- q\u003c/strong\u003e\u003c/em\u003e の \u003cem\u003e\u003cstrong\u003eok\u003c/strong\u003e\u003c/em\u003e が \u003cem\u003e\u003cstrong\u003efalse\u003c/strong\u003e\u003c/em\u003e になる。\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003epackage\u003c/span\u003e main\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e (\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;fmt\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;sync\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;time\u0026quot;\u003c/span\u003e\\n)\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003eprintString\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e(wg *sync.WaitGroup, q \u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003edefer\u003c/span\u003e wg.Done()\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e {\\n\\t\\tstr, ok := \u0026lt;-q\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003eif\u003c/span\u003e !ok {\\n\\t\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e\\n\\t\\t}\\n\\n\\t\\tfmt.Println(str)\\n\\t\\ttime.Sleep(\u003cspan class=\\\"hljs-number\\\"\u003e3\u003c/span\u003e * time.Second)\\n\\t}\\n}\\n\\n\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003efunc\u003c/span\u003e \u003cspan class=\\\"hljs-title\\\"\u003emain\u003c/span\u003e\u003cspan class=\\\"hljs-params\\\"\u003e()\u003c/span\u003e\u003c/span\u003e {\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e workerNum = \u003cspan class=\\\"hljs-number\\\"\u003e3\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003evar\u003c/span\u003e wg sync.WaitGroup\\n\\tq := \u003cspan class=\\\"hljs-built_in\\\"\u003emake\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003echan\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003estring\u003c/span\u003e, \u003cspan class=\\\"hljs-number\\\"\u003e5\u003c/span\u003e)\\n\\n\\t\u003cspan class=\\\"hljs-keyword\\\"\u003efor\u003c/span\u003e i := \u003cspan class=\\\"hljs-number\\\"\u003e0\u003c/span\u003e; i \u0026lt; workerNum; i++ {\\n\\t\\twg.Add(\u003cspan class=\\\"hljs-number\\\"\u003e1\u003c/span\u003e)\\n\\t\\t\u003cspan class=\\\"hljs-keyword\\\"\u003ego\u003c/span\u003e printString(\u0026amp;wg, q)\\n\\t}\\n\\n\\tq \u0026lt;- \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;test1\u0026quot;\u003c/span\u003e\\n\\tq \u0026lt;- \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;test2\u0026quot;\u003c/span\u003e\\n\\tq \u0026lt;- \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;test3\u0026quot;\u003c/span\u003e\\n\\tq \u0026lt;- \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;test4\u0026quot;\u003c/span\u003e\\n\\tq \u0026lt;- \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;test5\u0026quot;\u003c/span\u003e\\n\\t\u003cspan class=\\\"hljs-built_in\\\"\u003eclose\u003c/span\u003e(q)\\n\\twg.Wait()\\n}\\n\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// test2\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// test1\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// test3\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// test5\u003c/span\u003e\\n\u003cspan class=\\\"hljs-comment\\\"\u003e// test4\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\",\n  \"dir\": \"articles\",\n  \"base\": \"20210429182820.json\",\n  \"ext\": \".json\",\n  \"sourceBase\": \"20210429182820.md\",\n  \"sourceExt\": \".md\"\n}"}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"20210429182820"},"buildId":"IqmH55iomhQEvZjK-5scu","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-7b08e4c67f4f1b892f4b.js"></script><script src="/_next/static/chunks/webpack-189c53927ffd3caf09c3.js" async=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" async=""></script><script src="/_next/static/chunks/main-c8b51cc0a92c3008cd1b.js" async=""></script><script src="/_next/static/chunks/pages/_app-7163558e7d92093a94d2.js" async=""></script><script src="/_next/static/chunks/996-109927db333074874af4.js" async=""></script><script src="/_next/static/chunks/394-1ac6c205f84cbd1b2925.js" async=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-6ddac1fc6283bcb21133.js" async=""></script><script src="/_next/static/IqmH55iomhQEvZjK-5scu/_buildManifest.js" async=""></script><script src="/_next/static/IqmH55iomhQEvZjK-5scu/_ssgManifest.js" async=""></script></body></html>