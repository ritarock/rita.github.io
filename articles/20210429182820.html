<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Golang の 並列 / 並行 処理でいろいろ</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.b2562460c774f5a57980.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" as="script"/><link rel="preload" href="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" as="script"/></head><body><div id="__next"><div><div><div><h1>Ghostの囁き</h1><hr color="black"/></div><h2>Golang の 並列 / 並行 処理でいろいろ</h2><h2>並列 / 並行 処理</h2><ul><li>並列処理<ul><li>Parallelism<ul><li>同時に同じ処理が複数走る</li></ul></li></ul></li><li>並行処理<ul><li>Concurrency<ul><li>同時に色々な処理が走る</li></ul></li></ul></li></ul><h2>channel を使う</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;time&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span>num </span><span class="token" style="color:#2f9c0a">int</span><span class="token" style="color:#5F6364">,</span><span> str </span><span class="token" style="color:#2f9c0a">string</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">;</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span> num</span><span class="token" style="color:#5F6364">;</span><span> i</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">++</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		time</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Sleep</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span> time</span><span class="token" style="color:#5F6364">.</span><span>Second</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span>i</span><span class="token" style="color:#5F6364">,</span><span> str</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;Start&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;A&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;B&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;C&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;Finish&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// Start</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 A</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 A</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 B</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 B</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 C</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 C</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// Finish</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// </span><span>
</span><span></span><span class="token" style="color:#7D8B99">// ________________________________________________________</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// Executed in    6.30 secs      fish           external</span><span>
</span><span></span><span class="token" style="color:#7D8B99">//    usr time  192.00 millis  172.00 micros  191.83 millis</span><span>
</span><span></span><span class="token" style="color:#7D8B99">//    sys time  201.91 millis  759.00 micros  201.15 millis</span></code></pre><p>process の処理を並列化する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;time&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span>num </span><span class="token" style="color:#2f9c0a">int</span><span class="token" style="color:#5F6364">,</span><span> str </span><span class="token" style="color:#2f9c0a">string</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">;</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span> num</span><span class="token" style="color:#5F6364">;</span><span> i</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">++</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		time</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Sleep</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span> time</span><span class="token" style="color:#5F6364">.</span><span>Second</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span>i</span><span class="token" style="color:#5F6364">,</span><span> str</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<!-- -->
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	chA </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#2f9c0a">bool</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	chB </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#2f9c0a">bool</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	chC </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#2f9c0a">bool</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;Start&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;A&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		chA </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#c92c2c">true</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;B&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		chB </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#c92c2c">true</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#2f9c0a">process</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;C&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		chC </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#c92c2c">true</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span>chA
</span><span>	</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span>chB
</span><span>	</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span>chC
</span>
<span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;Finish&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// Start</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 B</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 A</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 0 C</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 C</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 A</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 1 B</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// Finish</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// </span><span>
</span><span></span><span class="token" style="color:#7D8B99">// ________________________________________________________</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// Executed in    2.29 secs      fish           external</span><span>
</span><span></span><span class="token" style="color:#7D8B99">//    usr time  194.02 millis  178.00 micros  193.84 millis</span><span>
</span><span></span><span class="token" style="color:#7D8B99">//    sys time  207.43 millis  862.00 micros  206.57 millis</span></code></pre><h2>sync.WaitGroup を使う</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">type</span><span> Item </span><span class="token" style="color:#1990b8">struct</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	Id   </span><span class="token" style="color:#2f9c0a">int</span><span>
</span><span>	Name </span><span class="token" style="color:#2f9c0a">string</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">execLoop</span><span class="token" style="color:#5F6364">(</span><span>list </span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>Item</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#c92c2c">_</span><span class="token" style="color:#5F6364">,</span><span> item </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#1990b8">range</span><span> list </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#2f9c0a">doSomething</span><span class="token" style="color:#5F6364">(</span><span>item</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">doSomething</span><span class="token" style="color:#5F6364">(</span><span>item Item</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	item</span><span class="token" style="color:#5F6364">.</span><span>Id </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">+=</span><span> </span><span class="token" style="color:#c92c2c">10</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span>item</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	list </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>Item</span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item1&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item2&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">3</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item3&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">4</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item4&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">5</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item5&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span>	</span><span class="token" style="color:#2f9c0a">execLoop</span><span class="token" style="color:#5F6364">(</span><span>list</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// {11 item1}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {12 item2}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {13 item3}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {14 item4}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {15 item5}</span></code></pre><p>ループ内の処理を並列化する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;sync&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">type</span><span> Item </span><span class="token" style="color:#1990b8">struct</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	Id   </span><span class="token" style="color:#2f9c0a">int</span><span>
</span><span>	Name </span><span class="token" style="color:#2f9c0a">string</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">execLoop</span><span class="token" style="color:#5F6364">(</span><span>list </span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>Item</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">var</span><span> wg sync</span><span class="token" style="color:#5F6364">.</span><span>WaitGroup
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#c92c2c">_</span><span class="token" style="color:#5F6364">,</span><span> item </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#1990b8">range</span><span> list </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Add</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span>item2 Item</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">defer</span><span> wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Done</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			</span><span class="token" style="color:#2f9c0a">doSomething</span><span class="token" style="color:#5F6364">(</span><span>item2</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span>item</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Wait</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">doSomething</span><span class="token" style="color:#5F6364">(</span><span>item Item</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	item</span><span class="token" style="color:#5F6364">.</span><span>Id </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">+=</span><span> </span><span class="token" style="color:#c92c2c">10</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span>item</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	list </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>Item</span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item1&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item2&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">3</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item3&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">4</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item4&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">{</span><span>Id</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">5</span><span class="token" style="color:#5F6364">,</span><span> Name</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;item5&quot;</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span>	</span><span class="token" style="color:#2f9c0a">execLoop</span><span class="token" style="color:#5F6364">(</span><span>list</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// {15 item5}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {11 item1}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {14 item4}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {13 item3}</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// {12 item2}</span></code></pre><h2>sync.Mutex を使う</h2><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">type</span><span> myClass </span><span class="token" style="color:#1990b8">struct</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	AttributeName </span><span class="token" style="color:#2f9c0a">string</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	sourceSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">100</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#c92c2c">_</span><span class="token" style="color:#5F6364">,</span><span> myObj </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#1990b8">range</span><span> sourceSlice </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">var</span><span> tmpObj myClass
</span><span>		tmpObj</span><span class="token" style="color:#5F6364">.</span><span>AttributeName </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> myObj</span><span class="token" style="color:#5F6364">.</span><span>AttributeName
</span><span>		destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> </span><span class="token" style="color:#2f9c0a">append</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">,</span><span> tmpObj</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">len</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">)</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// 100</span></code></pre><p>sync.WaitGroup を使う。(ダメな例)
append はスレッドセーフではないので件数が減る。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;sync&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">type</span><span> myClass </span><span class="token" style="color:#1990b8">struct</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	AttributeName </span><span class="token" style="color:#2f9c0a">string</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	sourceSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">100</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">var</span><span> wg sync</span><span class="token" style="color:#5F6364">.</span><span>WaitGroup
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#c92c2c">_</span><span class="token" style="color:#5F6364">,</span><span> myObj </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#1990b8">range</span><span> sourceSlice </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Add</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span>myObj2 myClass</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">defer</span><span> wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Done</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">var</span><span> tmpObj myClass
</span><span>			tmpObj</span><span class="token" style="color:#5F6364">.</span><span>AttributeName </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> myObj2</span><span class="token" style="color:#5F6364">.</span><span>AttributeName
</span><span>			destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> </span><span class="token" style="color:#2f9c0a">append</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">,</span><span> tmpObj</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span>myObj</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Wait</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">len</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">)</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// 75</span></code></pre><p><code>-race</code> を付けることで競合のチェックができる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ go run -race main.go
</span>
<!-- -->~~ 省略 ~~
<span></span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">==</span><span>
</span><span></span><span class="token" style="color:#c92c2c">97</span></code></pre><p>sync.Mutex を使う。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;sync&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">type</span><span> myClass </span><span class="token" style="color:#1990b8">struct</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	AttributeName </span><span class="token" style="color:#2f9c0a">string</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	sourceSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">100</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#5F6364">]</span><span>myClass</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">var</span><span> wg sync</span><span class="token" style="color:#5F6364">.</span><span>WaitGroup
</span><span>	mu </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&amp;</span><span>sync</span><span class="token" style="color:#5F6364">.</span><span>Mutex</span><span class="token" style="color:#5F6364">{</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#c92c2c">_</span><span class="token" style="color:#5F6364">,</span><span> myObj </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#1990b8">range</span><span> sourceSlice </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Add</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span>myObj2 myClass</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">defer</span><span> wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Done</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">var</span><span> tmpObj myClass
</span><span>			tmpObj</span><span class="token" style="color:#5F6364">.</span><span>AttributeName </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> myObj2</span><span class="token" style="color:#5F6364">.</span><span>AttributeName
</span><span>			mu</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Lock</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			destSlice </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> </span><span class="token" style="color:#2f9c0a">append</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">,</span><span> tmpObj</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			mu</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Unlock</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span>myObj</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Wait</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">len</span><span class="token" style="color:#5F6364">(</span><span>destSlice</span><span class="token" style="color:#5F6364">)</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// 100</span></code></pre><h2>ポーリング</h2><p><code>len(q)</code> は溜まったバッファ数を返す。<br/><code>make</code> で作るときはバッファ数を 2 以上で作らないと <code>len(q)</code> は常に 0 を返す。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;time&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#1990b8">struct</span><span class="token" style="color:#5F6364">{</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">2</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#1990b8">func</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#7D8B99">// 重たい処理</span><span>
</span><span>		time</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Sleep</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">3</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span> time</span><span class="token" style="color:#5F6364">.</span><span>Second</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#1990b8">struct</span><span class="token" style="color:#5F6364">{</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">{</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">if</span><span> </span><span class="token" style="color:#2f9c0a">len</span><span class="token" style="color:#5F6364">(</span><span>q</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span><span> </span><span class="token" style="color:#c92c2c">0</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>			fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;完了&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">break</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">}</span><span>
</span><span>		time</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Sleep</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span> time</span><span class="token" style="color:#5F6364">.</span><span>Second</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#2f9c0a">&quot;実行中&quot;</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// 実行中</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 実行中</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 実行中</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// 完了</span></code></pre><h2>ワーカー</h2><p><code>close(q)</code> されたら <code>str, ok := &lt;- q</code> の <code>ok</code> が <code>false</code> になる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-go" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#1990b8">package</span><span> main
</span>
<span></span><span class="token" style="color:#1990b8">import</span><span> </span><span class="token" style="color:#5F6364">(</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;fmt&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;sync&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">&quot;time&quot;</span><span>
</span><span></span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">printString</span><span class="token" style="color:#5F6364">(</span><span>wg </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span>sync</span><span class="token" style="color:#5F6364">.</span><span>WaitGroup</span><span class="token" style="color:#5F6364">,</span><span> q </span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#2f9c0a">string</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">defer</span><span> wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Done</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">for</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		str</span><span class="token" style="color:#5F6364">,</span><span> ok </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span>q
</span><span>		</span><span class="token" style="color:#1990b8">if</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">!</span><span>ok </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>			</span><span class="token" style="color:#1990b8">return</span><span>
</span><span>		</span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span>		fmt</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Println</span><span class="token" style="color:#5F6364">(</span><span>str</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		time</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Sleep</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">3</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">*</span><span> time</span><span class="token" style="color:#5F6364">.</span><span>Second</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#1990b8">func</span><span> </span><span class="token" style="color:#2f9c0a">main</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">const</span><span> workerNum </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span><span> </span><span class="token" style="color:#c92c2c">3</span><span>
</span><span>	</span><span class="token" style="color:#1990b8">var</span><span> wg sync</span><span class="token" style="color:#5F6364">.</span><span>WaitGroup
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#2f9c0a">make</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#1990b8">chan</span><span> </span><span class="token" style="color:#2f9c0a">string</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#c92c2c">5</span><span class="token" style="color:#5F6364">)</span><span>
</span>
<span>	</span><span class="token" style="color:#1990b8">for</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">:=</span><span> </span><span class="token" style="color:#c92c2c">0</span><span class="token" style="color:#5F6364">;</span><span> i </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span> workerNum</span><span class="token" style="color:#5F6364">;</span><span> i</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">++</span><span> </span><span class="token" style="color:#5F6364">{</span><span>
</span><span>		wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Add</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#c92c2c">1</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>		</span><span class="token" style="color:#1990b8">go</span><span> </span><span class="token" style="color:#2f9c0a">printString</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&amp;</span><span>wg</span><span class="token" style="color:#5F6364">,</span><span> q</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	</span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;test1&quot;</span><span>
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;test2&quot;</span><span>
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;test3&quot;</span><span>
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;test4&quot;</span><span>
</span><span>	q </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;test5&quot;</span><span>
</span><span>	</span><span class="token" style="color:#2f9c0a">close</span><span class="token" style="color:#5F6364">(</span><span>q</span><span class="token" style="color:#5F6364">)</span><span>
</span><span>	wg</span><span class="token" style="color:#5F6364">.</span><span class="token" style="color:#2f9c0a">Wait</span><span class="token" style="color:#5F6364">(</span><span class="token" style="color:#5F6364">)</span><span>
</span><span></span><span class="token" style="color:#5F6364">}</span><span>
</span>
<span></span><span class="token" style="color:#7D8B99">// test2</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// test1</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// test3</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// test5</span><span>
</span><span></span><span class="token" style="color:#7D8B99">// test4</span></code></pre><div><p><a href="/">TOPへ戻る</a></p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"articleData":{"id":"20210429182820","contentHtml":"\n## 並列 / 並行 処理\n- 並列処理\n  - Parallelism\n    - 同時に同じ処理が複数走る\n- 並行処理\n  - Concurrency\n    - 同時に色々な処理が走る\n\n## channel を使う\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc process(num int, str string) {\n\tfor i := 0; i \u003c num; i++ {\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(i, str)\n\t}\n}\n\nfunc main() {\n\tfmt.Println(\"Start\")\n\tprocess(2, \"A\")\n\tprocess(2, \"B\")\n\tprocess(2, \"C\")\n\tfmt.Println(\"Finish\")\n}\n\n// Start\n// 0 A\n// 1 A\n// 0 B\n// 1 B\n// 0 C\n// 1 C\n// Finish\n// \n// ________________________________________________________\n// Executed in    6.30 secs      fish           external\n//    usr time  192.00 millis  172.00 micros  191.83 millis\n//    sys time  201.91 millis  759.00 micros  201.15 millis\n```\n\nprocess の処理を並列化する。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc process(num int, str string) {\n\tfor i := 0; i \u003c num; i++ {\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(i, str)\n\t}\n}\n\n\nfunc main() {\n\tchA := make(chan bool)\n\tchB := make(chan bool)\n\tchC := make(chan bool)\n\tfmt.Println(\"Start\")\n\n\tgo func() {\n\t\tprocess(2, \"A\")\n\t\tchA \u003c- true\n\t}()\n\n\tgo func() {\n\t\tprocess(2, \"B\")\n\t\tchB \u003c- true\n\t}()\n\n\tgo func() {\n\t\tprocess(2, \"C\")\n\t\tchC \u003c- true\n\t}()\n\n\t\u003c-chA\n\t\u003c-chB\n\t\u003c-chC\n\n\tfmt.Println(\"Finish\")\n}\n\n// Start\n// 0 B\n// 0 A\n// 0 C\n// 1 C\n// 1 A\n// 1 B\n// Finish\n// \n// ________________________________________________________\n// Executed in    2.29 secs      fish           external\n//    usr time  194.02 millis  178.00 micros  193.84 millis\n//    sys time  207.43 millis  862.00 micros  206.57 millis\n```\n\n## sync.WaitGroup を使う\n```go\npackage main\n\nimport \"fmt\"\n\ntype Item struct {\n\tId   int\n\tName string\n}\n\nfunc execLoop(list []Item) {\n\tfor _, item := range list {\n\t\tdoSomething(item)\n\t}\n}\n\nfunc doSomething(item Item) {\n\titem.Id += 10\n\tfmt.Println(item)\n}\n\nfunc main() {\n\tlist := []Item{\n\t\t{Id: 1, Name: \"item1\"},\n\t\t{Id: 2, Name: \"item2\"},\n\t\t{Id: 3, Name: \"item3\"},\n\t\t{Id: 4, Name: \"item4\"},\n\t\t{Id: 5, Name: \"item5\"},\n\t}\n\n\texecLoop(list)\n}\n\n// {11 item1}\n// {12 item2}\n// {13 item3}\n// {14 item4}\n// {15 item5}\n```\n\nループ内の処理を並列化する。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype Item struct {\n\tId   int\n\tName string\n}\n\nfunc execLoop(list []Item) {\n\tvar wg sync.WaitGroup\n\tfor _, item := range list {\n\t\twg.Add(1)\n\t\tgo func(item2 Item) {\n\t\t\tdefer wg.Done()\n\t\t\tdoSomething(item2)\n\t\t}(item)\n\t}\n\twg.Wait()\n}\n\nfunc doSomething(item Item) {\n\titem.Id += 10\n\tfmt.Println(item)\n}\n\nfunc main() {\n\tlist := []Item{\n\t\t{Id: 1, Name: \"item1\"},\n\t\t{Id: 2, Name: \"item2\"},\n\t\t{Id: 3, Name: \"item3\"},\n\t\t{Id: 4, Name: \"item4\"},\n\t\t{Id: 5, Name: \"item5\"},\n\t}\n\n\texecLoop(list)\n}\n\n// {15 item5}\n// {11 item1}\n// {14 item4}\n// {13 item3}\n// {12 item2}\n```\n\n## sync.Mutex を使う\n```go\npackage main\n\nimport \"fmt\"\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tfor _, myObj := range sourceSlice {\n\t\tvar tmpObj myClass\n\t\ttmpObj.AttributeName = myObj.AttributeName\n\t\tdestSlice = append(destSlice, tmpObj)\n\t}\n\tfmt.Println(len(destSlice))\n}\n\n// 100\n```\n\nsync.WaitGroup を使う。(ダメな例)\nappend はスレッドセーフではないので件数が減る。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tvar wg sync.WaitGroup\n\tfor _, myObj := range sourceSlice {\n\t\twg.Add(1)\n\t\tgo func(myObj2 myClass) {\n\t\t\tdefer wg.Done()\n\t\t\tvar tmpObj myClass\n\t\t\ttmpObj.AttributeName = myObj2.AttributeName\n\t\t\tdestSlice = append(destSlice, tmpObj)\n\t\t}(myObj)\n\t}\n\twg.Wait()\n\tfmt.Println(len(destSlice))\n}\n\n// 75\n```\n\n`-race` を付けることで競合のチェックができる。\n```bash\n$ go run -race main.go\n\n~~ 省略 ~~\n==================\n97\n```\n\nsync.Mutex を使う。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tvar wg sync.WaitGroup\n\tmu := \u0026sync.Mutex{}\n\tfor _, myObj := range sourceSlice {\n\t\twg.Add(1)\n\t\tgo func(myObj2 myClass) {\n\t\t\tdefer wg.Done()\n\t\t\tvar tmpObj myClass\n\t\t\ttmpObj.AttributeName = myObj2.AttributeName\n\t\t\tmu.Lock()\n\t\t\tdestSlice = append(destSlice, tmpObj)\n\t\t\tmu.Unlock()\n\t\t}(myObj)\n\t}\n\twg.Wait()\n\tfmt.Println(len(destSlice))\n}\n\n// 100\n```\n\n## ポーリング\n`len(q)` は溜まったバッファ数を返す。  \n`make` で作るときはバッファ数を 2 以上で作らないと `len(q)` は常に 0 を返す。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\tq := make(chan struct{}, 2)\n\n\tgo func() {\n\t\t// 重たい処理\n\t\ttime.Sleep(3 * time.Second)\n\t\tq \u003c- struct{}{}\n\t}()\n\n\tfor {\n\t\tif len(q) \u003e 0 {\n\t\t\tfmt.Println(\"完了\")\n\t\t\tbreak\n\t\t}\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(\"実行中\")\n\t}\n}\n\n// 実行中\n// 実行中\n// 実行中\n// 完了\n```\n\n## ワーカー\n`close(q)` されたら `str, ok := \u003c- q` の `ok` が `false` になる。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n\t\"time\"\n)\n\nfunc printString(wg *sync.WaitGroup, q chan string) {\n\tdefer wg.Done()\n\n\tfor {\n\t\tstr, ok := \u003c-q\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\n\t\tfmt.Println(str)\n\t\ttime.Sleep(3 * time.Second)\n\t}\n}\n\nfunc main() {\n\tconst workerNum = 3\n\tvar wg sync.WaitGroup\n\tq := make(chan string, 5)\n\n\tfor i := 0; i \u003c workerNum; i++ {\n\t\twg.Add(1)\n\t\tgo printString(\u0026wg, q)\n\t}\n\n\tq \u003c- \"test1\"\n\tq \u003c- \"test2\"\n\tq \u003c- \"test3\"\n\tq \u003c- \"test4\"\n\tq \u003c- \"test5\"\n\tclose(q)\n\twg.Wait()\n}\n\n// test2\n// test1\n// test3\n// test5\n// test4\n```\n","title":"Golang の 並列 / 並行 処理でいろいろ","date":20210429182820,"tags":["Golang"]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"20210429182820"},"buildId":"8VPh2w0QwyWiuxlWI8Hxt","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" async=""></script><script src="/_next/static/chunks/commons.b2562460c774f5a57980.js" async=""></script><script src="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" async=""></script><script src="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" async=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" async=""></script><script src="/_next/static/8VPh2w0QwyWiuxlWI8Hxt/_buildManifest.js" async=""></script><script src="/_next/static/8VPh2w0QwyWiuxlWI8Hxt/_ssgManifest.js" async=""></script></body></html>