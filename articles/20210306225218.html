<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Docker と docker-compose のまとめ</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1c3d6ee91fcccc28a7c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.b2562460c774f5a57980.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" as="script"/><link rel="preload" href="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" as="script"/></head><body><div id="__next"><div><div><div><h1>Ghostの囁き</h1><hr color="black"/></div><h2>Docker と docker-compose のまとめ</h2><h2>Docker</h2><h3>build</h3><p>Dockerfile が存在するディレクトリで実行。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker build </span><span class="token" style="color:#1990b8">.</span></code></pre><p><code>-f</code> オプションを付けることでパスを指定できる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker build -f /path/to/Dockerfile </span><span class="token" style="color:#1990b8">.</span></code></pre><p><code>-t</code> オプションを付けることでリポジトリとタグを指定できる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>$ docker build -t shukes/myapp </span><span class="token" style="color:#1990b8">.</span></code></pre><h3>FROM</h3><p>ベースイメージを指定。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>FROM &lt;image&gt;[:&lt;tag&gt;][AS &lt;name&gt;]</span></code></pre><h3>RUN</h3><p>シェルとして実行される。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>RUN /bin/bash -c &#x27;source $HOME/.bashrc;&#x27; \
</span>echo $HOME
</code></pre><p>1 行で書く場合。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>RUN /bin/bash -c &#x27;source $HOME/.bashrc; echo $HOME&#x27;</span></code></pre><p><code>/bash/sh</code> 以外の別のシェルを使う場合は exec 形式でシェルに引数を渡す。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>RUN [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;echo hello&quot;]</span></code></pre><p>exec 形式で書く場合は json 配列として扱われるので <code>&quot;&quot;</code> で囲む必要がある。</p><h3>CMD</h3><p>Dockerfile 内で CMD 命令は 1 つのみ。
複数あっても最後の CMD 命令のみが実行される。</p><p><strong>CMD の主目的はコンテナ実行時のデフォルト処理を指定する</strong></p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-Dockerfile" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>FROM ubuntu
</span>CMD [&quot;/usr/bin/wc&quot;, &quot;--help&quot;]
</code></pre><h3>ADD / COPY</h3><p><code>&lt;src&gt;</code> で指定したファイル、ディレクトリをコンテナ内の <code>&lt;dest&gt;</code> にコピーする。</p><p>ADD はリモートファイルをコピー可能で圧縮ファイルの解凍する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-bash" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>ADD </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span>src</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span>dest</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span><span>
</span><span>COPY </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span>src</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span><span> </span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&lt;</span><span>dest</span><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span></code></pre><h2>docker-compose</h2><h2>build</h2><p>構築時のオプションを指定。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">version</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3.8&quot;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">services</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">webapp</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span> ./dir</span></code></pre><p><code>context</code> で <code>Dockerfile</code> や <code>args</code> を指定できる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">version</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3.8&quot;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">services</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">webapp</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token key" style="color:#1990b8">context</span><span class="token" style="color:#5F6364">:</span><span> ./dir
</span><span>      </span><span class="token key" style="color:#1990b8">dockerfile</span><span class="token" style="color:#5F6364">:</span><span> Dockerfile</span><span class="token" style="color:#5F6364">-</span><span>alternate
</span><span>      </span><span class="token key" style="color:#1990b8">args</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>        </span><span class="token key" style="color:#1990b8">buildno</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">1</span></code></pre><p><code>image</code> を指定してイメージ名とタグをアタッチできる。</p><p>イメージ名が webapp 、タグが tag の場合。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span> ./dir
</span><span></span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> webapp</span><span class="token" style="color:#5F6364">:</span><span>tag</span></code></pre><h3>context</h3><p>Dockerfile を含むディレクトリかリポジトリ URL を指定する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">context</span><span class="token" style="color:#5F6364">:</span><span> ./dir</span></code></pre><h3>dockerfile</h3><p>別の Dockerfile を指定する。ビルドパスと同時に指定する必要がある。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">context</span><span class="token" style="color:#5F6364">:</span><span> .
</span><span>  </span><span class="token key" style="color:#1990b8">dockerfile</span><span class="token" style="color:#5F6364">:</span><span> Dockerfile</span><span class="token" style="color:#5F6364">-</span><span>alternate</span></code></pre><h3>args</h3><p>ビルド引数を追加する。環境変数となりビルド処理の間のみ使用される。
Dockerfile 内ではじめにビルド引数を指定する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span>ARG buildno
</span>ARG gitcommithash
<!-- -->
<span></span><span class="token key" style="color:#1990b8">RUN echo &quot;Build number</span><span class="token" style="color:#5F6364">:</span><span> $buildno&quot;
</span><span></span><span class="token key" style="color:#1990b8">RUN echo &quot;Based on commit</span><span class="token" style="color:#5F6364">:</span><span> $gitcommithash&quot;</span></code></pre><p><code>build</code> キーをもとにその引数を指定する。</p><p>個々をマッピングするか、リスト形式で書く。
ブール値の場合はクォートで囲む必要がある。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">context</span><span class="token" style="color:#5F6364">:</span><span> .
</span><span>  </span><span class="token key" style="color:#1990b8">args</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">1</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">gitcommithash</span><span class="token" style="color:#5F6364">:</span><span> cdc3b19</span></code></pre><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">context</span><span class="token" style="color:#5F6364">:</span><span> .
</span><span>  </span><span class="token key" style="color:#1990b8">args</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token" style="color:#5F6364">-</span><span> buildno=1
</span><span>    </span><span class="token" style="color:#5F6364">-</span><span> gitcommithash=cdc3b19</span></code></pre><h3>command</h3><p>デフォルトコマンドを上書きする。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">command</span><span class="token" style="color:#5F6364">:</span><span> build exec thin </span><span class="token" style="color:#5F6364">-</span><span>p 3000</span></code></pre><p>Dockerfile と同じリスト形式でも書ける。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">command</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#5F6364">[</span><span class="token" style="color:#2f9c0a">&quot;build&quot;</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;exec&quot;</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;thin&quot;</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;-p&quot;</span><span class="token" style="color:#5F6364">,</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3000&quot;</span><span class="token" style="color:#5F6364">]</span></code></pre><h3>depends_on</h3><p>サービス間の依存関係を表す。
<code>docker-compose up</code> は依存関係順にサービスを起動する。</p><p>以下の場合だと、 db と Redis を起動したあとに web を起動する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">version</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3.8&quot;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">services</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">web</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">build</span><span class="token" style="color:#5F6364">:</span><span> .
</span><span>    </span><span class="token key" style="color:#1990b8">depends_on</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> db
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> redis
</span><span>  </span><span class="token key" style="color:#1990b8">redis</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> redis
</span><span>  </span><span class="token key" style="color:#1990b8">db</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> postgres</span></code></pre><h3>environment</h3><p>環境変数を追加する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">environment</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">RACK_ENV</span><span class="token" style="color:#5F6364">:</span><span> development
</span><span>  </span><span class="token key" style="color:#1990b8">SHOW</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&#x27;true&#x27;</span></code></pre><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">environment</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> RACK_ENV=development
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> SHOW=&#x27;true&#x27;</span></code></pre><h3>expose</h3><p>ホストマシンにはポートを公開せずにポートを expose する。
リンクされたサービスのみアクセス可能になる。内部のポートのみ指定可能。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">expose</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3000&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;8000&quot;</span></code></pre><h3>ports</h3><p>公開用のポートを指定する。</p><p>ホスト側とコンテナ側のポートを指定する( <code>HOST:CONTAINER</code> )。
もしくは、コンテナ側のポートを指定する。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">ports</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3000&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3000-3005&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;8000:8000&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;9090-9091:8080-8081&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;49100:22&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;127.0.0.1:8001:8001&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;127.0.0.1:5000-5010:5000-5010&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;6060:6060/udp&quot;</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;12400-12500:1240&quot;</span></code></pre><p>追加項目がある場合。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">ports</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token key" style="color:#1990b8">target</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">80</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">published</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#c92c2c">8080</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">protocol</span><span class="token" style="color:#5F6364">:</span><span> tcp
</span><span>    </span><span class="token key" style="color:#1990b8">mode</span><span class="token" style="color:#5F6364">:</span><span> host</span></code></pre><h3>links</h3><p>他のサービスのコンテナをリンクさせる。
リンクされたコンテナは、ホスト名より到達可能になる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">web</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">links</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;db&quot;</span><span>
</span><span>    </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;db:database&quot;</span><span>
</span><span>    </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;redis&quot;</span></code></pre><h3>volumes</h3><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">version</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;3.8&quot;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">services</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">web</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> nginx</span><span class="token" style="color:#5F6364">:</span><span>alpine
</span><span>    </span><span class="token key" style="color:#1990b8">volumes</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token key" style="color:#1990b8">type</span><span class="token" style="color:#5F6364">:</span><span> volume
</span><span>        </span><span class="token key" style="color:#1990b8">source</span><span class="token" style="color:#5F6364">:</span><span> mydata
</span><span>        </span><span class="token key" style="color:#1990b8">target</span><span class="token" style="color:#5F6364">:</span><span> /data
</span><span>        </span><span class="token key" style="color:#1990b8">volume</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>          </span><span class="token key" style="color:#1990b8">nocopy</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#e90;font-weight:normal">true</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token key" style="color:#1990b8">type</span><span class="token" style="color:#5F6364">:</span><span> bind
</span><span>        </span><span class="token key" style="color:#1990b8">source</span><span class="token" style="color:#5F6364">:</span><span> ./static
</span><span>        </span><span class="token key" style="color:#1990b8">target</span><span class="token" style="color:#5F6364">:</span><span> /opt/app/static
</span><span>  </span><span class="token key" style="color:#1990b8">db</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>    </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> postgres</span><span class="token" style="color:#5F6364">:</span><span>latest
</span><span>    </span><span class="token key" style="color:#1990b8">volumes</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;/var/run/postgres.sock:/var/run/postgres/postgres.sock&quot;</span><span>
</span><span>      </span><span class="token" style="color:#5F6364">-</span><span> </span><span class="token" style="color:#2f9c0a">&quot;dbdata:/var/lib/postgresql/data&quot;</span><span>
</span><span></span><span class="token key" style="color:#1990b8">volumes</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">mydata</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  database</span><span class="token" style="color:#5F6364">:</span></code></pre><p>短い書き方では <code>[SOURCE:]TARGET[:MODE]</code> と書ける。</p><p>ro は readonly 。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token" style="color:#5F6364">-</span><span> ./cache</span><span class="token" style="color:#5F6364">:</span><span>/tmp/cache</span><span class="token" style="color:#5F6364">:</span><span>ro</span></code></pre><h3>変数の置換</h3><p>シェル環境に <code>POSTGRES_VERSION=9.3</code> が定義されていると postgres のバージョンは 9.3 になる。</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code class="language-yml" style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto"><span class="token key" style="color:#1990b8">db</span><span class="token" style="color:#5F6364">:</span><span>
</span><span>  </span><span class="token key" style="color:#1990b8">image</span><span class="token" style="color:#5F6364">:</span><span> </span><span class="token" style="color:#2f9c0a">&quot;postgres:${POSTGRES_VERSION}&quot;</span></code></pre><p>環境変数が何も設定されていない場合は空文字になる。
環境変数のデフォルト値は <code>.env</code> ファイルに設定しておくことができる。</p><ul><li>${VARIABLE:-default} は VARIABLE がセットされていないか空文字のときに <code>default</code> として評価される</li><li>${VARIABLE-default} は VARIABLE がセットされていないときのみ <code>default</code> として評価される</li></ul><div><p><a href="/">TOPへ戻る</a></p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"articleData":{"id":"20210306225218","contentHtml":"\n## Docker\n\n### build\nDockerfile が存在するディレクトリで実行。\n```bash\n$ docker build .\n```\n\n`-f` オプションを付けることでパスを指定できる。\n```bash\n$ docker build -f /path/to/Dockerfile .\n```\n\n`-t` オプションを付けることでリポジトリとタグを指定できる。\n```bash\n$ docker build -t shukes/myapp .\n```\n\n### FROM\nベースイメージを指定。\n```Dockerfile\nFROM \u003cimage\u003e[:\u003ctag\u003e][AS \u003cname\u003e]\n```\n\n### RUN\nシェルとして実行される。\n```Dockerfile\nRUN /bin/bash -c 'source $HOME/.bashrc;' \\\necho $HOME\n```\n\n1 行で書く場合。\n```Dockerfile\nRUN /bin/bash -c 'source $HOME/.bashrc; echo $HOME'\n```\n\n`/bash/sh` 以外の別のシェルを使う場合は exec 形式でシェルに引数を渡す。\n```Dockerfile\nRUN [\"/bin/bash\", \"-c\", \"echo hello\"]\n```\n\nexec 形式で書く場合は json 配列として扱われるので `\"\"` で囲む必要がある。\n\n### CMD\nDockerfile 内で CMD 命令は 1 つのみ。\n複数あっても最後の CMD 命令のみが実行される。\n\n**CMD の主目的はコンテナ実行時のデフォルト処理を指定する**\n```Dockerfile\nFROM ubuntu\nCMD [\"/usr/bin/wc\", \"--help\"]\n```\n\n### ADD / COPY\n`\u003csrc\u003e` で指定したファイル、ディレクトリをコンテナ内の `\u003cdest\u003e` にコピーする。\n\nADD はリモートファイルをコピー可能で圧縮ファイルの解凍する。\n```bash\nADD \u003csrc\u003e \u003cdest\u003e\nCOPY \u003csrc\u003e \u003cdest\u003e\n```\n\n## docker-compose\n\n## build\n構築時のオプションを指定。\n```yml\nversion: \"3.8\"\nservices:\n  webapp:\n  build: ./dir\n```\n\n`context` で `Dockerfile` や `args` を指定できる。\n```yml\nversion: \"3.8\"\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1\n```\n\n`image` を指定してイメージ名とタグをアタッチできる。\n\nイメージ名が webapp 、タグが tag の場合。\n```yml\nbuild: ./dir\nimage: webapp:tag\n```\n\n### context\nDockerfile を含むディレクトリかリポジトリ URL を指定する。\n```yml\nbuild:\n  context: ./dir\n```\n\n### dockerfile\n別の Dockerfile を指定する。ビルドパスと同時に指定する必要がある。\n```yml\nbuild:\n  context: .\n  dockerfile: Dockerfile-alternate\n```\n\n### args\nビルド引数を追加する。環境変数となりビルド処理の間のみ使用される。\nDockerfile 内ではじめにビルド引数を指定する。\n```yml\nARG buildno\nARG gitcommithash\n\nRUN echo \"Build number: $buildno\"\nRUN echo \"Based on commit: $gitcommithash\"\n```\n\n`build` キーをもとにその引数を指定する。\n\n個々をマッピングするか、リスト形式で書く。\nブール値の場合はクォートで囲む必要がある。\n```yml\nbuild:\n  context: .\n  args:\n    build: 1\n    gitcommithash: cdc3b19\n```\n\n```yml\nbuild:\n  context: .\n  args:\n    - buildno=1\n    - gitcommithash=cdc3b19\n```\n\n### command\nデフォルトコマンドを上書きする。\n```yml\ncommand: build exec thin -p 3000\n```\n\nDockerfile と同じリスト形式でも書ける。\n```yml\ncommand: [\"build\", \"exec\", \"thin\", \"-p\", \"3000\"]\n```\n\n### depends_on\nサービス間の依存関係を表す。\n`docker-compose up` は依存関係順にサービスを起動する。\n\n以下の場合だと、 db と Redis を起動したあとに web を起動する。\n```yml\nversion: \"3.8\"\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n  redis:\n    image: redis\n  db:\n    image: postgres\n```\n\n### environment\n環境変数を追加する。\n```yml\nenvironment:\n  RACK_ENV: development\n  SHOW: 'true'\n```\n\n```yml\nenvironment:\n  - RACK_ENV=development\n  - SHOW='true'\n```\n\n### expose\nホストマシンにはポートを公開せずにポートを expose する。\nリンクされたサービスのみアクセス可能になる。内部のポートのみ指定可能。\n```yml\nexpose:\n  - \"3000\"\n  - \"8000\"\n```\n\n### ports\n公開用のポートを指定する。\n\nホスト側とコンテナ側のポートを指定する( `HOST:CONTAINER` )。\nもしくは、コンテナ側のポートを指定する。\n```yml\nports:\n  - \"3000\"\n  - \"3000-3005\"\n  - \"8000:8000\"\n  - \"9090-9091:8080-8081\"\n  - \"49100:22\"\n  - \"127.0.0.1:8001:8001\"\n  - \"127.0.0.1:5000-5010:5000-5010\"\n  - \"6060:6060/udp\"\n  - \"12400-12500:1240\"\n```\n\n追加項目がある場合。\n```yml\nports:\n  - target: 80\n    published: 8080\n    protocol: tcp\n    mode: host\n```\n\n### links\n他のサービスのコンテナをリンクさせる。\nリンクされたコンテナは、ホスト名より到達可能になる。\n```yml\nweb:\n  links:\n    - \"db\"\n    - \"db:database\"\n    - \"redis\"\n```\n\n### volumes\n```yml\nversion: \"3.8\"\nservices:\n  web:\n    image: nginx:alpine\n    volumes:\n      - type: volume\n        source: mydata\n        target: /data\n        volume:\n          nocopy: true\n      - type: bind\n        source: ./static\n        target: /opt/app/static\n  db:\n    image: postgres:latest\n    volumes:\n      - \"/var/run/postgres.sock:/var/run/postgres/postgres.sock\"\n      - \"dbdata:/var/lib/postgresql/data\"\nvolumes:\n  mydata:\n  database:\n```\n\n短い書き方では `[SOURCE:]TARGET[:MODE]` と書ける。\n\nro は readonly 。\n```yml\n- ./cache:/tmp/cache:ro\n```\n\n### 変数の置換\nシェル環境に `POSTGRES_VERSION=9.3` が定義されていると postgres のバージョンは 9.3 になる。\n```yml\ndb:\n  image: \"postgres:${POSTGRES_VERSION}\"\n```\n\n環境変数が何も設定されていない場合は空文字になる。\n環境変数のデフォルト値は `.env` ファイルに設定しておくことができる。\n- ${VARIABLE:-default} は VARIABLE がセットされていないか空文字のときに `default` として評価される\n- ${VARIABLE-default} は VARIABLE がセットされていないときのみ `default` として評価される\n","title":"Docker と docker-compose のまとめ","date":20200904095600,"tags":["Docker"]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"20210306225218"},"buildId":"5vzFAZgPfSzIf2JxO_jW7","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-f7ca7a935b246c4edd14.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.d2e6186d001d2275b0af.js" async=""></script><script src="/_next/static/chunks/commons.b2562460c774f5a57980.js" async=""></script><script src="/_next/static/chunks/pages/_app-b63af2e2dfcc0bffd9c0.js" async=""></script><script src="/_next/static/chunks/c5b568cee8545d966ddc8d89f9063461e084494a.c564a02921d697744263.js" async=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-565d4c3adc05a3ed7d91.js" async=""></script><script src="/_next/static/5vzFAZgPfSzIf2JxO_jW7/_buildManifest.js" async=""></script><script src="/_next/static/5vzFAZgPfSzIf2JxO_jW7/_ssgManifest.js" async=""></script></body></html>