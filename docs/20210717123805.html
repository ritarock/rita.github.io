<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/4f6358649898043ee7a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4f6358649898043ee7a7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-42cedee763d16b21c0e8.js" defer=""></script><script src="/_next/static/chunks/408-35579d04b0c1f804c73d.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-217c0c73201253baba1b.js" defer=""></script><script src="/_next/static/3WFwgUBmCIfCHDts5UaWs/_buildManifest.js" defer=""></script><script src="/_next/static/3WFwgUBmCIfCHDts5UaWs/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->Golang の ORM 試した</b></h1><p>試したリポジトリはここ.</p>
<p><a href="https://github.com/ritarock/sandbox/tree/master/golang/sample_gorm">https://github.com/ritarock/sandbox/tree/master/golang/sample_gorm</a></p>
<h2>DB に接続</h2>
<p><code node="[object Object]">gorm.Open(dialect string, args ...interface{})</code> の第一引数は接続するデータベース,第二引数には接続情報.</p>
<p>今回は Docker で実行したのでコンテナが起動しても mysql は起動していない場合があったので 30 秒待つ処理を入れた.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">gormConnect</span><span class="hljs-function hljs-params">()</span><span class="hljs-function"> *</span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">gorm</span><span class="hljs-function">.</span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">DB</span><span> {
</span><span>	DBMS := </span><span style="color:#a6e22e">&quot;mysql&quot;</span><span>
</span><span>	PROTOCOL := </span><span style="color:#a6e22e">&quot;tcp(db:3306)&quot;</span><span>
</span><span>	USER := </span><span style="color:#a6e22e">&quot;user&quot;</span><span>
</span><span>	PASS := </span><span style="color:#a6e22e">&quot;password&quot;</span><span>
</span><span>	DBNAME := </span><span style="color:#a6e22e">&quot;app&quot;</span><span>
</span><span>	CONNECT := USER + </span><span style="color:#a6e22e">&quot;:&quot;</span><span> + PASS + </span><span style="color:#a6e22e">&quot;@&quot;</span><span> + PROTOCOL + </span><span style="color:#a6e22e">&quot;/&quot;</span><span> + DBNAME + </span><span style="color:#a6e22e">&quot;?parseTime=true&quot;</span><span>
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> err error
</span>	db, err := gorm.Open(DBMS, CONNECT)
<span>	</span><span style="color:#f92672;font-weight:bold">if</span><span> err != </span><span style="color:#f92672;font-weight:bold">nil</span><span> {
</span><span>		fmt.Println(</span><span style="color:#a6e22e">&quot;Not ready&quot;</span><span>)
</span>		time.Sleep(time.Second)
<!-- -->		count++
<span>		</span><span style="color:#f92672;font-weight:bold">if</span><span> count &gt; </span><span class="hljs-number">30</span><span> {
</span><span>			</span><span style="color:#a6e22e">panic</span><span>(err.Error())
</span>		}
<span>		</span><span style="color:#f92672;font-weight:bold">return</span><span> gormConnect()
</span>	}
<span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Success connect&quot;</span><span>)
</span><span>	</span><span style="color:#f92672;font-weight:bold">return</span><span> db
</span>}
</code></div></pre>
<h2>モデル</h2>
<p>構造体を定義する.</p>
<p>フィールドの <code node="[object Object]">ID</code> は gorm では主キーとなる. <code node="[object Object]">CreatedAt</code> と <code node="[object Object]">UpdatedAt</code> はレコードの作成時と更新時に自動的で設定される.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">type</span><span> Post </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	ID        </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Content   </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span><span>	Author    </span><span style="color:#f92672;font-weight:bold">string</span><span> </span><span style="color:#a6e22e">`sql:&quot;not null&quot;`</span><span>
</span>	Comments  []Comment
<!-- -->	CreatedAt time.Time
<!-- -->}
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Comment </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	ID        </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Content   </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span><span>	Author    </span><span style="color:#f92672;font-weight:bold">string</span><span> </span><span style="color:#a6e22e">`sql:&quot;not null&quot;`</span><span>
</span><span>	PostId    </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span>	CreatedAt time.Time
<!-- -->}
</code></div></pre>
<p>gorm ではフィールドタグ　<code node="[object Object]">gorm:&quot;&quot;</code> を設定すること制約などの設定を行える.</p>
<p>設定できるものは <a href="https://gorm.io/ja_JP/docs/models.html#Fields-Tags">ここ</a> を参照.</p>
<h2>belongs to</h2>
<p>User は Company に所属している.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">type</span><span> User </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<span>  Name      </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span><span>  CompanyID </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span>  Company   Company
<!-- -->}
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Company </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>  ID   </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>  Name </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
</code></div></pre>
<h2>has one</h2>
<p>別のモデルと 1 対 1 の関係.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">type</span><span> User </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<!-- -->  CreditCard CreditCard
<!-- -->}
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> CreditCard </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<span>  Number </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span><span>  UserID </span><span style="color:#f92672;font-weight:bold">uint</span><span>
</span>}
</code></div></pre>
<h2>has many</h2>
<p>User は CreditCard を複数持っている.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">type</span><span> User </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<!-- -->  CreditCards []CreditCard
<!-- -->}
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> CreditCard </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<span>  Number </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span><span>  UserID </span><span style="color:#f92672;font-weight:bold">uint</span><span>
</span>}
</code></div></pre>
<h2>many to many</h2>
<p>Book は複数の Author を持ち, Author は複数の本を持っている.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">type</span><span> Book </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<span>  Authors []Author </span><span style="color:#a6e22e">`gorm:&quot;many2many:author_books&quot;`</span><span>
</span>}
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Author </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>  gorm.Model
<span>  Books []Book </span><span style="color:#a6e22e">`gorm:&quot;many2many:author_books&quot;`</span><span>
</span>}
</code></div></pre>
<h2>マイグレーション</h2>
<p>足りないカラムの追加,変更,インデックスの作成は行うが,不要になったカラムの削除等は行われない.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span>db.AutoMigrate(&amp;Post{}, &amp;Comment{})</span></code></div></pre></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20210717123805","title":"Golang の ORM 試した","content":"\n試したリポジトリはここ.\n\nhttps://github.com/ritarock/sandbox/tree/master/golang/sample_gorm\n\n\n## DB に接続\n`gorm.Open(dialect string, args ...interface{})` の第一引数は接続するデータベース,第二引数には接続情報.\n\n今回は Docker で実行したのでコンテナが起動しても mysql は起動していない場合があったので 30 秒待つ処理を入れた.\n```go\nfunc gormConnect() *gorm.DB {\n\tDBMS := \"mysql\"\n\tPROTOCOL := \"tcp(db:3306)\"\n\tUSER := \"user\"\n\tPASS := \"password\"\n\tDBNAME := \"app\"\n\tCONNECT := USER + \":\" + PASS + \"@\" + PROTOCOL + \"/\" + DBNAME + \"?parseTime=true\"\n\n\tvar err error\n\tdb, err := gorm.Open(DBMS, CONNECT)\n\tif err != nil {\n\t\tfmt.Println(\"Not ready\")\n\t\ttime.Sleep(time.Second)\n\t\tcount++\n\t\tif count \u003e 30 {\n\t\t\tpanic(err.Error())\n\t\t}\n\t\treturn gormConnect()\n\t}\n\tfmt.Println(\"Success connect\")\n\treturn db\n}\n```\n\n## モデル\n構造体を定義する. \n\nフィールドの `ID` は gorm では主キーとなる. `CreatedAt` と `UpdatedAt` はレコードの作成時と更新時に自動的で設定される.\n```go\ntype Post struct {\n\tID        int\n\tContent   string\n\tAuthor    string `sql:\"not null\"`\n\tComments  []Comment\n\tCreatedAt time.Time\n}\n\ntype Comment struct {\n\tID        int\n\tContent   string\n\tAuthor    string `sql:\"not null\"`\n\tPostId    int\n\tCreatedAt time.Time\n}\n```\n\ngorm ではフィールドタグ　``gorm:\"\"`` を設定すること制約などの設定を行える.\n\n設定できるものは [ここ](https://gorm.io/ja_JP/docs/models.html#Fields-Tags) を参照.\n\n\n## belongs to\nUser は Company に所属している.\n```go\ntype User struct {\n  gorm.Model\n  Name      string\n  CompanyID int\n  Company   Company\n}\n\ntype Company struct {\n  ID   int\n  Name string\n}\n```\n\n## has one\n別のモデルと 1 対 1 の関係.\n```go\ntype User struct {\n  gorm.Model\n  CreditCard CreditCard\n}\n\ntype CreditCard struct {\n  gorm.Model\n  Number string\n  UserID uint\n}\n```\n\n## has many\nUser は CreditCard を複数持っている.\n```go\ntype User struct {\n  gorm.Model\n  CreditCards []CreditCard\n}\n\ntype CreditCard struct {\n  gorm.Model\n  Number string\n  UserID uint\n}\n```\n\n## many to many\nBook は複数の Author を持ち, Author は複数の本を持っている.\n```go\ntype Book struct {\n  gorm.Model\n  Authors []Author `gorm:\"many2many:author_books\"`\n}\ntype Author struct {\n  gorm.Model\n  Books []Book `gorm:\"many2many:author_books\"`\n}\n```\n\n## マイグレーション\n足りないカラムの追加,変更,インデックスの作成は行うが,不要になったカラムの削除等は行われない.\n```go\ndb.AutoMigrate(\u0026Post{}, \u0026Comment{})\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20210717123805"},"buildId":"3WFwgUBmCIfCHDts5UaWs","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>