<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/0675b109fae35ba9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0675b109fae35ba9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-0f8b31729833af61.js" defer=""></script><script src="/_next/static/chunks/main-a89779f987984dde.js" defer=""></script><script src="/_next/static/chunks/pages/_app-eddec6d010f06c43.js" defer=""></script><script src="/_next/static/chunks/548-2da8f2137a34d623.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-3337e28c632a2e4a.js" defer=""></script><script src="/_next/static/hF2Pj5pJ4tC-2zQEJj1vU/_buildManifest.js" defer=""></script><script src="/_next/static/hF2Pj5pJ4tC-2zQEJj1vU/_ssgManifest.js" defer=""></script><script src="/_next/static/hF2Pj5pJ4tC-2zQEJj1vU/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->docker-compose で Rails と Mysql を使う</b></h1><h2>ディレクトリ構成</h2>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>./
</span>├── Dockerfile
<!-- -->├── docker-compose.yml
<!-- -->├── db_volume/
<!-- -->├── mysql-confd/
<!-- -->│   └── default_authentication.cnf
<!-- -->└── src/
<!-- -->    ├── Gemfile
<!-- -->    └── Gemfile.lock
</code></div><p class="h-2"></p></pre>
<h2>ファイルの説明</h2>
<h3>Dockerfile</h3>
<p>Rails のアプリ用の Dockerfile を定義する.
MySQL と連携するために mysql-client をインストールしている.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span style="color:#f92672;font-weight:bold">FROM</span><span> ruby:latest
</span>
<span></span><span style="color:#a6e22e">RUN</span><span> apt-</span><span style="color:#a6e22e">get</span><span> update -qq &amp;&amp; \
</span><span>    apt-</span><span style="color:#a6e22e">get</span><span> install -y build-essential &amp;&amp; \
</span><span>    apt-</span><span style="color:#a6e22e">get</span><span> install -y libpq-dev &amp;&amp; \
</span><span>    apt-</span><span style="color:#a6e22e">get</span><span> install -y mysql-client &amp;&amp; \
</span><span>    apt-</span><span style="color:#a6e22e">get</span><span> install -y nodejs
</span>
<span></span><span style="color:#a6e22e">RUN</span><span> mkdir /myapp
</span>ENV APP_ROOT /myapp
<span>WORKDIR </span><span style="color:#a6e22e">$APP_ROOT</span><span>
</span><span></span><span style="color:#a6e22e">ADD</span><span> ./src/Gemfile </span><span style="color:#a6e22e">$APP_ROOT</span><span>/Gemfile
</span><span></span><span style="color:#a6e22e">ADD</span><span> ./src/Gemfile.lock </span><span style="color:#a6e22e">$APP_ROOT</span><span>/Gemfile.lock
</span>
<span></span><span style="color:#a6e22e">RUN</span><span> bundle install
</span><span></span><span style="color:#a6e22e">ADD</span><span> ./src/ </span><span style="color:#a6e22e">$APP_ROOT</span></code></div><p class="h-2"></p></pre>
<h3>docker-compose</h3>
<p>MySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする.
また <code node="[object Object]">./db_volume:/var/lib/mysql</code> で DB を永続化している.</p>
<p><a href="https://qiita.com/yensaki/items/9e453b7320ca2d0461c7">参考</a></p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">version:</span><span> </span><span style="color:#a6e22e">&#x27;3&#x27;</span><span>
</span><span></span><span class="hljs-attr">services:</span><span>
</span><span>  </span><span class="hljs-attr">db:</span><span>
</span><span>    </span><span class="hljs-attr">image:</span><span> </span><span style="color:#a6e22e">mysql:latest</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./mysql-confd:/etc/mysql/conf.d</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./db_volume:/var/lib/mysql</span><span>
</span><span>    </span><span class="hljs-attr">environment:</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_DATABASE:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>    </span><span class="hljs-attr">ports:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">&quot;3306:3306&quot;</span><span>
</span>
<span>  </span><span class="hljs-attr">web:</span><span>
</span><span>    </span><span class="hljs-attr">build:</span><span> </span><span style="color:#a6e22e">.</span><span>
</span><span>    </span><span class="hljs-attr">command:</span><span> </span><span style="color:#a6e22e">bundle</span><span> </span><span style="color:#a6e22e">exec</span><span> </span><span style="color:#a6e22e">rails</span><span> </span><span style="color:#a6e22e">s</span><span> </span><span style="color:#a6e22e">-p</span><span> </span><span class="hljs-number">3000</span><span> </span><span style="color:#a6e22e">-b</span><span> </span><span style="color:#a6e22e">&#x27;0.0.0.0&#x27;</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./src:/myapp</span><span>
</span><span>    </span><span class="hljs-attr">ports:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">&quot;3000:3000&quot;</span><span>
</span><span>    </span><span class="hljs-attr">links:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">db</span></code></div><p class="h-2"></p></pre>
<h3>default_authentication.cnf</h3>
<p>認証用の設定ファイル.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-default_authentication" style="white-space:pre"><span style="color:#a6e22e;font-weight:bold">[mysqld]</span><span>
</span><span></span><span class="hljs-attr">default_authentication_plugin</span><span>= mysql_native_password</span></code></div><p class="h-2"></p></pre>
<h3>Gemfile</h3>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Gemfile" style="white-space:pre"><span>source </span><span style="color:#bf79db">&#x27;https://rubygems.org</span><span>&#x27;
</span><span>gem </span><span style="color:#bf79db">&#x27;rails</span><span>&#x27;, </span><span style="color:#bf79db">&#x27;5.1.6</span><span>&#x27;</span></code></div><p class="h-2"></p></pre>
<p>Gemfile.lock も作成しておく ( 中身は空 ) .</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ touch ./src/Gemfile.lock</span></code></div><p class="h-2"></p></pre>
<h2>プロジェクトの構築</h2>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker-compose run web rails new . --force --database=mysql --skip-bundle</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">--skip-bundle</code> で gem のインストールを回避.
実行後 <code node="[object Object]">./src</code> 配下に新しいアプリケーションが作成されている.</p>
<h2>データベースに接続</h2>
<p><code node="[object Object]">./src/config/database.yml</code> の password と host を docker-compose で定義した内容に変更.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">default:</span><span> </span><span style="color:#75715e">&amp;default</span><span>
</span><span>  </span><span class="hljs-attr">adapter:</span><span> </span><span style="color:#a6e22e">mysql2</span><span>
</span><span>  </span><span class="hljs-attr">encoding:</span><span> </span><span style="color:#a6e22e">utf8</span><span>
</span><span>  </span><span class="hljs-attr">pool:</span><span> &lt;%=</span><span class="ruby"> ENV.fetch(</span><span class="ruby" style="color:#a6e22e">&quot;RAILS_MAX_THREADS&quot;</span><span class="ruby">) { </span><span class="ruby hljs-number">5</span><span class="ruby"> } </span><span>%&gt;
</span><span>  </span><span class="hljs-attr">username:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>  </span><span class="hljs-attr">password:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>  </span><span class="hljs-attr">host:</span><span> </span><span style="color:#a6e22e">db</span></code></div><p class="h-2"></p></pre>
<h2>dockerの起動</h2>
<p>ビルド.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker-compose build</span></code></div><p class="h-2"></p></pre>
<p>起動.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker-compose up</span></code></div><p class="h-2"></p></pre>
<h2>DBの作成</h2>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker-compose run web rails db:create</span></code></div><p class="h-2"></p></pre>
<h2>確認</h2>
<p>ブラウザで localhost:3000 にアクセス.</p>
<p>Rails のコンテナにアクセスして DB との接続確認.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker </span><span style="color:#a6e22e">exec</span><span> -it コンテナID /bin/bash</span></code></div><p class="h-2"></p></pre>
<p>接続したコンテナから DB に接続.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ rails dbconsole</span></code></div><p class="h-2"></p></pre></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20190829090000","title":"docker-compose で Rails と Mysql を使う","content":"\n## ディレクトリ構成\n```bash\n./\n├── Dockerfile\n├── docker-compose.yml\n├── db_volume/\n├── mysql-confd/\n│   └── default_authentication.cnf\n└── src/\n    ├── Gemfile\n    └── Gemfile.lock\n```\n\n## ファイルの説明\n### Dockerfile\nRails のアプリ用の Dockerfile を定義する.\nMySQL と連携するために mysql-client をインストールしている.\n```Dockerfile\nFROM ruby:latest\n\nRUN apt-get update -qq \u0026\u0026 \\\n    apt-get install -y build-essential \u0026\u0026 \\\n    apt-get install -y libpq-dev \u0026\u0026 \\\n    apt-get install -y mysql-client \u0026\u0026 \\\n    apt-get install -y nodejs\n\nRUN mkdir /myapp\nENV APP_ROOT /myapp\nWORKDIR $APP_ROOT\nADD ./src/Gemfile $APP_ROOT/Gemfile\nADD ./src/Gemfile.lock $APP_ROOT/Gemfile.lock\n\nRUN bundle install\nADD ./src/ $APP_ROOT\n```\n\n### docker-compose\nMySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする.\nまた `./db_volume:/var/lib/mysql` で DB を永続化している.\n\n[参考](https://qiita.com/yensaki/items/9e453b7320ca2d0461c7)  \n```yaml\nversion: '3'\nservices:\n  db:\n    image: mysql:latest\n    volumes:\n      - ./mysql-confd:/etc/mysql/conf.d\n      - ./db_volume:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: root\n    ports:\n      - \"3306:3306\"\n\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - ./src:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n```\n\n### default_authentication.cnf\n認証用の設定ファイル.\n```default_authentication.cnf\n[mysqld]\ndefault_authentication_plugin= mysql_native_password\n```\n\n### Gemfile\n```Gemfile\nsource 'https://rubygems.org'\ngem 'rails', '5.1.6'\n```\n\nGemfile.lock も作成しておく ( 中身は空 ) .\n```bash\n$ touch ./src/Gemfile.lock\n```\n\n## プロジェクトの構築\n```bash\n$ docker-compose run web rails new . --force --database=mysql --skip-bundle\n```\n\n`--skip-bundle` で gem のインストールを回避.\n実行後 `./src` 配下に新しいアプリケーションが作成されている.\n\n## データベースに接続\n`./src/config/database.yml` の password と host を docker-compose で定義した内容に変更.\n```yaml\ndefault: \u0026default\n  adapter: mysql2\n  encoding: utf8\n  pool: \u003c%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %\u003e\n  username: root\n  password: root\n  host: db\n```\n\n## dockerの起動\nビルド.\n```bash\n$ docker-compose build\n```\n\n起動.\n```bash\n$ docker-compose up\n```\n\n## DBの作成\n```bash\n$ docker-compose run web rails db:create\n```\n\n## 確認\nブラウザで localhost:3000 にアクセス.\n\nRails のコンテナにアクセスして DB との接続確認.\n```bash\n$ docker exec -it コンテナID /bin/bash\n```\n\n接続したコンテナから DB に接続.\n```bash\n$ rails dbconsole\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20190829090000"},"buildId":"hF2Pj5pJ4tC-2zQEJj1vU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>