<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/a58c9bb1e05a64ba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a58c9bb1e05a64ba.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-d38be8d96a62f950.js" defer=""></script><script src="/_next/static/chunks/framework-7a7e500878b44665.js" defer=""></script><script src="/_next/static/chunks/main-0a9b5d9f75e3dd77.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/996-7d106c3956878ed2.js" defer=""></script><script src="/_next/static/chunks/706-40509b0ae2cf93bc.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-949e412980dabb58.js" defer=""></script><script src="/_next/static/geyh5Y1CW91u6U4EOGZ3I/_buildManifest.js" defer=""></script><script src="/_next/static/geyh5Y1CW91u6U4EOGZ3I/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><a style="text-decoration:none" href="/"><div style="color:black;font-size:22px;cursor:pointer">MyDocs</div></a></div><p></p><h1><b># <!-- -->docker-compose で Rails と Mysql を使う</b></h1><h2>ディレクトリ構成</h2>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span>./
</span>├── Dockerfile
<!-- -->├── docker-compose.yml
<!-- -->├── db_volume/
<!-- -->├── mysql-confd/
<!-- -->│   └── default_authentication.cnf
<!-- -->└── src/
<!-- -->    ├── Gemfile
<!-- -->    └── Gemfile.lock</code></pre></div></pre>
<h2>ファイルの説明</h2>
<h3>Dockerfile</h3>
<p>Rails のアプリ用の Dockerfile を定義する。
MySQL と連携するために mysql-client をインストールしている。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">Dockerfile</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-markdown" style="white-space:pre"><span>FROM ruby:latest
</span>
<!-- -->RUN apt-get update -qq &amp;&amp; \
<span></span><span style="color:#66d9ef">    apt-get install -y build-essential &amp;&amp; \
</span><span style="color:#66d9ef">    apt-get install -y libpq-dev &amp;&amp; \
</span><span style="color:#66d9ef">    apt-get install -y mysql-client &amp;&amp; \
</span><span style="color:#66d9ef">    apt-get install -y nodejs
</span><span style="color:#66d9ef"></span><span>
</span>RUN mkdir /myapp
<span>ENV APP</span><span style="color:#a6e22e">_ROOT /myapp
</span><span style="color:#a6e22e">WORKDIR $APP_</span><span>ROOT
</span><span>ADD ./src/Gemfile $APP</span><span style="color:#a6e22e">_ROOT/Gemfile
</span><span style="color:#a6e22e">ADD ./src/Gemfile.lock $APP_</span><span>ROOT/Gemfile.lock
</span>
<!-- -->RUN bundle install
<span>ADD ./src/ $APP</span><span style="color:#a6e22e">_ROOT</span></code></pre></div></pre>
<h3>docker-compose</h3>
<p>MySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする。
また <code>./db_volume:/var/lib/mysql</code> で DB を永続化している。</p>
<p><a href="https://qiita.com/yensaki/items/9e453b7320ca2d0461c7">参考</a></p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">yaml</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">version:</span><span> </span><span style="color:#a6e22e">&#x27;3&#x27;</span><span>
</span><span></span><span class="hljs-attr">services:</span><span>
</span><span>  </span><span class="hljs-attr">db:</span><span>
</span><span>    </span><span class="hljs-attr">image:</span><span> </span><span style="color:#a6e22e">mysql:latest</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./mysql-confd:/etc/mysql/conf.d</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./db_volume:/var/lib/mysql</span><span>
</span><span>    </span><span class="hljs-attr">environment:</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_DATABASE:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>    </span><span class="hljs-attr">ports:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">&quot;3306:3306&quot;</span><span>
</span>
<span>  </span><span class="hljs-attr">web:</span><span>
</span><span>    </span><span class="hljs-attr">build:</span><span> </span><span style="color:#a6e22e">.</span><span>
</span><span>    </span><span class="hljs-attr">command:</span><span> </span><span style="color:#a6e22e">bundle</span><span> </span><span style="color:#a6e22e">exec</span><span> </span><span style="color:#a6e22e">rails</span><span> </span><span style="color:#a6e22e">s</span><span> </span><span style="color:#a6e22e">-p</span><span> </span><span class="hljs-number">3000</span><span> </span><span style="color:#a6e22e">-b</span><span> </span><span style="color:#a6e22e">&#x27;0.0.0.0&#x27;</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./src:/myapp</span><span>
</span><span>    </span><span class="hljs-attr">ports:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">&quot;3000:3000&quot;</span><span>
</span><span>    </span><span class="hljs-attr">links:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">db</span></code></pre></div></pre>
<h3>default_authentication.cnf</h3>
<p>認証用の設定ファイル。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">cnf</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-markdown" style="white-space:pre"><span>[mysqld]
</span><span>default</span><span style="color:#a6e22e">_authentication_</span><span>plugin= mysql</span><span style="color:#a6e22e">_native_</span><span>password</span></code></pre></div></pre>
<h3>Gemfile</h3>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">Gemfile</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-markdown" style="white-space:pre"><span>source &#x27;https://rubygems.org&#x27;
</span>gem &#x27;rails&#x27;, &#x27;5.1.6&#x27;</code></pre></div></pre>
<p>Gemfile.lock も作成しておく ( 中身は空 ) 。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> touch ./src/Gemfile.lock</span></code></pre></div></pre>
<h2>プロジェクトの構築</h2>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker-compose run web rails new . --force --database=mysql --skip-bundle</span></code></pre></div></pre>
<p><code>--skip-bundle</code> で gem のインストールを回避。
実行後 <code>./src</code> 配下に新しいアプリケーションが作成されている。</p>
<h2>データベースに接続</h2>
<p><code>./src/config/database.yml</code> の password と host を docker-compose で定義した内容に変更。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">yaml</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">default:</span><span> </span><span style="color:#75715e">&amp;default</span><span>
</span><span>  </span><span class="hljs-attr">adapter:</span><span> </span><span style="color:#a6e22e">mysql2</span><span>
</span><span>  </span><span class="hljs-attr">encoding:</span><span> </span><span style="color:#a6e22e">utf8</span><span>
</span><span>  </span><span class="hljs-attr">pool:</span><span> &lt;%=</span><span class="ruby"> ENV.fetch(</span><span class="ruby" style="color:#a6e22e">&quot;RAILS_MAX_THREADS&quot;</span><span class="ruby">) { </span><span class="ruby hljs-number">5</span><span class="ruby"> } </span><span>%&gt;
</span><span>  </span><span class="hljs-attr">username:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>  </span><span class="hljs-attr">password:</span><span> </span><span style="color:#a6e22e">root</span><span>
</span><span>  </span><span class="hljs-attr">host:</span><span> </span><span style="color:#a6e22e">db</span></code></pre></div></pre>
<h2>dockerの起動</h2>
<p>ビルド。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker-compose build</span></code></pre></div></pre>
<p>起動。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker-compose up</span></code></pre></div></pre>
<h2>DBの作成</h2>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker-compose run web rails db:create</span></code></pre></div></pre>
<h2>確認</h2>
<p>ブラウザで localhost:3000 にアクセス。</p>
<p>Rails のコンテナにアクセスして DB との接続確認。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker </span><span class="bash" style="color:#a6e22e">exec</span><span class="bash"> -it コンテナID /bin/bash</span></code></pre></div></pre>
<p>接続したコンテナから DB に接続。</p>
<pre><div class="sc-bczSft fXnDIL"><div class="sc-gsnScm dAllrj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> rails dbconsole</span></code></pre></div></pre></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"contents":{"id":"20190829090000","title":"docker-compose で Rails と Mysql を使う","body":"\n## ディレクトリ構成\n```bash\n./\n├── Dockerfile\n├── docker-compose.yml\n├── db_volume/\n├── mysql-confd/\n│   └── default_authentication.cnf\n└── src/\n    ├── Gemfile\n    └── Gemfile.lock\n```\n\n## ファイルの説明\n### Dockerfile\nRails のアプリ用の Dockerfile を定義する。\nMySQL と連携するために mysql-client をインストールしている。\n```Dockerfile\nFROM ruby:latest\n\nRUN apt-get update -qq \u0026\u0026 \\\n    apt-get install -y build-essential \u0026\u0026 \\\n    apt-get install -y libpq-dev \u0026\u0026 \\\n    apt-get install -y mysql-client \u0026\u0026 \\\n    apt-get install -y nodejs\n\nRUN mkdir /myapp\nENV APP_ROOT /myapp\nWORKDIR $APP_ROOT\nADD ./src/Gemfile $APP_ROOT/Gemfile\nADD ./src/Gemfile.lock $APP_ROOT/Gemfile.lock\n\nRUN bundle install\nADD ./src/ $APP_ROOT\n```\n\n### docker-compose\nMySQL のバージョンが 8 以上だと認証でエラーになるので設定ファイルをにマウントする。\nまた `./db_volume:/var/lib/mysql` で DB を永続化している。\n\n[参考](https://qiita.com/yensaki/items/9e453b7320ca2d0461c7)  \n```yaml\nversion: '3'\nservices:\n  db:\n    image: mysql:latest\n    volumes:\n      - ./mysql-confd:/etc/mysql/conf.d\n      - ./db_volume:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: root\n    ports:\n      - \"3306:3306\"\n\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - ./src:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n```\n\n### default_authentication.cnf\n認証用の設定ファイル。\n```default_authentication.cnf\n[mysqld]\ndefault_authentication_plugin= mysql_native_password\n```\n\n### Gemfile\n```Gemfile\nsource 'https://rubygems.org'\ngem 'rails', '5.1.6'\n```\n\nGemfile.lock も作成しておく ( 中身は空 ) 。\n```bash\n$ touch ./src/Gemfile.lock\n```\n\n## プロジェクトの構築\n```bash\n$ docker-compose run web rails new . --force --database=mysql --skip-bundle\n```\n\n`--skip-bundle` で gem のインストールを回避。\n実行後 `./src` 配下に新しいアプリケーションが作成されている。\n\n## データベースに接続\n`./src/config/database.yml` の password と host を docker-compose で定義した内容に変更。\n```yaml\ndefault: \u0026default\n  adapter: mysql2\n  encoding: utf8\n  pool: \u003c%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %\u003e\n  username: root\n  password: root\n  host: db\n```\n\n## dockerの起動\nビルド。\n```bash\n$ docker-compose build\n```\n\n起動。\n```bash\n$ docker-compose up\n```\n\n## DBの作成\n```bash\n$ docker-compose run web rails db:create\n```\n\n## 確認\nブラウザで localhost:3000 にアクセス。\n\nRails のコンテナにアクセスして DB との接続確認。\n```bash\n$ docker exec -it コンテナID /bin/bash\n```\n\n接続したコンテナから DB に接続。\n```bash\n$ rails dbconsole\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20190829090000"},"buildId":"geyh5Y1CW91u6U4EOGZ3I","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>