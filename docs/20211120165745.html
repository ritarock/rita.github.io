<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/ec23c38ee66c087d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ec23c38ee66c087d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-f65e66e62fc5ca80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c8629aafccf90c37.js" defer=""></script><script src="/_next/static/chunks/996-9e3c12b77542c098.js" defer=""></script><script src="/_next/static/chunks/711-7d68ff1249d1d375.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-4b3cef17c5260f19.js" defer=""></script><script src="/_next/static/_Oeh_r-o8XR9F2QkwcIjt/_buildManifest.js" defer=""></script><script src="/_next/static/_Oeh_r-o8XR9F2QkwcIjt/_ssgManifest.js" defer=""></script><script src="/_next/static/_Oeh_r-o8XR9F2QkwcIjt/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-10"><h1><b># <!-- -->sql-migrate を試す</b></h1><p><a href="https://github.com/rubenv/sql-migrate">https://github.com/rubenv/sql-migrate</a> を試してみた。</p>
<h2>docker で試す</h2>
<p>通常のアプリを起動する <code>docker-compose.yml</code> とは別に <code>docker-compose.migration.yml</code> を用意した。</p>
<pre><div class="sc-bczRLJ xShwa"><div class="sc-gsnTZi viLYE">yml</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">version:</span><span> </span><span style="color:#a6e22e">&#x27;3&#x27;</span><span>
</span><span></span><span class="hljs-attr">services:</span><span>
</span><span>  </span><span class="hljs-attr">db:</span><span>
</span><span>    </span><span class="hljs-attr">build:</span><span>
</span><span>      </span><span class="hljs-attr">context:</span><span> </span><span style="color:#a6e22e">./docker/database</span><span>
</span><span>    </span><span class="hljs-attr">restart:</span><span> </span><span style="color:#a6e22e">always</span><span>
</span><span>    </span><span class="hljs-attr">environment:</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_DATABASE:</span><span> </span><span style="color:#a6e22e">app</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_USER:</span><span> </span><span style="color:#a6e22e">user</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_PASSWORD:</span><span> </span><span style="color:#a6e22e">pass</span><span>
</span><span>      </span><span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span><span> </span><span style="color:#a6e22e">pass</span><span>
</span><span>    </span><span class="hljs-attr">ports:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span class="hljs-number">3306</span><span style="color:#a6e22e">:3306</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./docker/database/mysql:/var/lib/mysql</span><span>
</span><span>  </span><span class="hljs-attr">migration:</span><span>
</span><span>    </span><span class="hljs-attr">build:</span><span>
</span><span>      </span><span class="hljs-attr">context:</span><span> </span><span style="color:#a6e22e">./docker/migration</span><span>
</span><span>    </span><span class="hljs-attr">volumes:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">./migrations:/work</span><span>
</span><span>    </span><span class="hljs-attr">depends_on:</span><span>
</span><span>      </span><span style="color:#a6e22e">-</span><span> </span><span style="color:#a6e22e">db</span></code></pre></div></pre>
<p>migration 用の Dockerfile はこんな感じ。</p>
<pre><div class="sc-bczRLJ xShwa"><div class="sc-gsnTZi viLYE">Dockerfile</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-markdown" style="white-space:pre"><span>FROM golang:1.17.3
</span>
<!-- -->WORKDIR /work
<!-- -->RUN go get -v github.com/rubenv/sql-migrate/...</code></pre></div></pre>
<p>migration コンテナにマウントしてる <code>./migrations</code> にはマイグレーション用の SQL と <code>dbconfig.yml</code> を置いている。</p>
<p><code>dbconfig.yml</code> では接続する DB の設定を書いておく。</p>
<pre><div class="sc-bczRLJ xShwa"><div class="sc-gsnTZi viLYE">yml</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yaml" style="white-space:pre"><span class="hljs-attr">development:</span><span>
</span><span>    </span><span class="hljs-attr">dialect:</span><span> </span><span style="color:#a6e22e">mysql</span><span>
</span><span>    </span><span class="hljs-attr">datasource:</span><span> </span><span style="color:#a6e22e">user:pass@tcp(db:3306)/app?parseTime=true</span><span>
</span><span>    </span><span class="hljs-attr">dir:</span><span> </span><span style="color:#a6e22e">.</span></code></pre></div></pre>
<p>また sql ファイルには <code>-- +migrate Up</code> と <code>-- +migrate Down</code> の記述が必要。</p>
<pre><div class="sc-bczRLJ xShwa"><div class="sc-gsnTZi viLYE">sql</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-markdown" style="white-space:pre"><span>-- +migrate Up
</span>CREATE TABLE topics (
<!-- -->  id varchar(255),
<!-- -->  title varchar(255),
<!-- -->  detail varchar(255)
<!-- -->);
<!-- -->
<!-- -->-- +migrate Down
<!-- -->DROP TABLE IF EXISTS topics;</code></pre></div></pre>
<h2>実行</h2>
<pre><div class="sc-bczRLJ xShwa"><div class="sc-gsnTZi viLYE">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> docker-compose -f docker-compose.migration.yml run migration bash</span><span>
</span><span></span><span style="color:#75715e">$</span><span class="bash"> sql-migrate up</span></code></pre></div></pre></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20211120165745","title":"sql-migrate を試す","body":"\nhttps://github.com/rubenv/sql-migrate を試してみた。\n\n## docker で試す\n通常のアプリを起動する `docker-compose.yml` とは別に `docker-compose.migration.yml` を用意した。\n```yml\nversion: '3'\nservices:\n  db:\n    build:\n      context: ./docker/database\n    restart: always\n    environment:\n      MYSQL_DATABASE: app\n      MYSQL_USER: user\n      MYSQL_PASSWORD: pass\n      MYSQL_ROOT_PASSWORD: pass\n    ports:\n      - 3306:3306\n    volumes:\n      - ./docker/database/mysql:/var/lib/mysql\n  migration:\n    build:\n      context: ./docker/migration\n    volumes:\n      - ./migrations:/work\n    depends_on:\n      - db\n```\n\nmigration 用の Dockerfile はこんな感じ。\n```Dockerfile\nFROM golang:1.17.3\n\nWORKDIR /work\nRUN go get -v github.com/rubenv/sql-migrate/...\n```\n\nmigration コンテナにマウントしてる `./migrations` にはマイグレーション用の SQL と `dbconfig.yml` を置いている。\n\n`dbconfig.yml` では接続する DB の設定を書いておく。\n```yml\ndevelopment:\n    dialect: mysql\n    datasource: user:pass@tcp(db:3306)/app?parseTime=true\n    dir: .\n```\n\nまた sql ファイルには `-- +migrate Up` と `-- +migrate Down` の記述が必要。\n```sql\n-- +migrate Up\nCREATE TABLE topics (\n  id varchar(255),\n  title varchar(255),\n  detail varchar(255)\n);\n\n-- +migrate Down\nDROP TABLE IF EXISTS topics;\n```\n\n## 実行\n```bash\n$ docker-compose -f docker-compose.migration.yml run migration bash\n$ sql-migrate up\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20211120165745"},"buildId":"_Oeh_r-o8XR9F2QkwcIjt","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>