<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e44854d771c00df0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e44854d771c00df0.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-d98b4a7f39fdfc80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-327d6f89185e0007.js" defer=""></script><script src="/_next/static/chunks/594-14c965e1fcce40c6.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-5449b7016e4923d1.js" defer=""></script><script src="/_next/static/mf1115FoHAIO_24TGLDdK/_buildManifest.js" defer=""></script><script src="/_next/static/mf1115FoHAIO_24TGLDdK/_ssgManifest.js" defer=""></script><script src="/_next/static/mf1115FoHAIO_24TGLDdK/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->sql-migrate を試す</b></h1><p><a href="https://github.com/rubenv/sql-migrate">https://github.com/rubenv/sql-migrate</a> を試してみた。</p>
<h2>docker で試す</h2>
<p>通常のアプリを起動する <code node="[object Object]">docker-compose.yml</code> とは別に <code node="[object Object]">docker-compose.migration.yml</code> を用意した。</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&#x27;3&#x27;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  db:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span>
</span><span></span><span style="color:#bf79db">      context:</span><span> .</span><span class="hljs-meta-keyword">/docker/</span><span>database
</span><span></span><span style="color:#bf79db">    restart:</span><span> always
</span><span></span><span style="color:#bf79db">    environment:</span><span>
</span><span></span><span style="color:#bf79db">      MYSQL_DATABASE:</span><span> app
</span><span></span><span style="color:#bf79db">      MYSQL_USER:</span><span> user
</span><span></span><span style="color:#bf79db">      MYSQL_PASSWORD:</span><span> pass
</span><span></span><span style="color:#bf79db">      MYSQL_ROOT_PASSWORD:</span><span> pass
</span><span></span><span style="color:#bf79db">    ports:</span><span>
</span><span>      - </span><span class="hljs-number">3306</span><span>:</span><span class="hljs-number">3306</span><span>
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span><span>      - .</span><span class="hljs-meta-keyword">/docker/</span><span>database/mysql:</span><span class="hljs-meta-keyword">/var/</span><span>lib/mysql
</span><span></span><span style="color:#bf79db">  migration:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span>
</span><span></span><span style="color:#bf79db">      context:</span><span> .</span><span class="hljs-meta-keyword">/docker/</span><span>migration
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span>      - ./migrations:/work
<span></span><span style="color:#bf79db">    depends_on:</span><span>
</span>      - db
</code></div><p class="h-2"></p></pre>
<p>migration 用の Dockerfile はこんな感じ。</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span style="color:#f92672;font-weight:bold">FROM</span><span> golang:1.17.3
</span>
<!-- -->WORKDIR /work
<span></span><span style="color:#a6e22e">RUN</span><span> go </span><span style="color:#a6e22e">get</span><span> -v github.com/rubenv/sql-migrate/</span><span style="color:#a6e22e">..</span><span>.</span></code></div><p class="h-2"></p></pre>
<p>migration コンテナにマウントしてる <code node="[object Object]">./migrations</code> にはマイグレーション用の SQL と <code node="[object Object]">dbconfig.yml</code> を置いている。</p>
<p><code node="[object Object]">dbconfig.yml</code> では接続する DB の設定を書いておく。</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">development:</span><span>
</span><span></span><span style="color:#bf79db">    dialect:</span><span> mysql
</span><span></span><span style="color:#bf79db">    datasource:</span><span> user:pass@tcp(db:</span><span class="hljs-number">3306</span><span>)/app?parseTime=true
</span><span></span><span style="color:#bf79db">    dir:</span><span> .</span></code></div><p class="h-2"></p></pre>
<p>また sql ファイルには <code node="[object Object]">-- +migrate Up</code> と <code node="[object Object]">-- +migrate Down</code> の記述が必要。</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-sql" style="white-space:pre"><span style="color:#75715e">-- +migrate Up</span><span>
</span><span></span><span style="color:#f92672;font-weight:bold">CREATE</span><span> </span><span style="color:#f92672;font-weight:bold">TABLE</span><span> topics (
</span><span>  id </span><span style="color:#a6e22e;font-weight:bold">varchar</span><span>(</span><span class="hljs-number">255</span><span>),
</span><span>  title </span><span style="color:#a6e22e;font-weight:bold">varchar</span><span>(</span><span class="hljs-number">255</span><span>),
</span><span>  detail </span><span style="color:#a6e22e;font-weight:bold">varchar</span><span>(</span><span class="hljs-number">255</span><span>)
</span>);
<!-- -->
<span></span><span style="color:#75715e">-- +migrate Down</span><span>
</span><span></span><span style="color:#f92672;font-weight:bold">DROP</span><span> </span><span style="color:#f92672;font-weight:bold">TABLE</span><span> IF </span><span style="color:#f92672;font-weight:bold">EXISTS</span><span> topics;</span></code></div><p class="h-2"></p></pre>
<h2>実行</h2>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker-compose -f docker-compose.migration.yml run migration bash
</span>$ sql-migrate up
</code></div><p class="h-2"></p></pre></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20211120165745","title":"sql-migrate を試す","content":"\nhttps://github.com/rubenv/sql-migrate を試してみた。\n\n## docker で試す\n通常のアプリを起動する `docker-compose.yml` とは別に `docker-compose.migration.yml` を用意した。\n```yml\nversion: '3'\nservices:\n  db:\n    build:\n      context: ./docker/database\n    restart: always\n    environment:\n      MYSQL_DATABASE: app\n      MYSQL_USER: user\n      MYSQL_PASSWORD: pass\n      MYSQL_ROOT_PASSWORD: pass\n    ports:\n      - 3306:3306\n    volumes:\n      - ./docker/database/mysql:/var/lib/mysql\n  migration:\n    build:\n      context: ./docker/migration\n    volumes:\n      - ./migrations:/work\n    depends_on:\n      - db\n```\n\nmigration 用の Dockerfile はこんな感じ。\n```Dockerfile\nFROM golang:1.17.3\n\nWORKDIR /work\nRUN go get -v github.com/rubenv/sql-migrate/...\n```\n\nmigration コンテナにマウントしてる `./migrations` にはマイグレーション用の SQL と `dbconfig.yml` を置いている。\n\n`dbconfig.yml` では接続する DB の設定を書いておく。\n```yml\ndevelopment:\n    dialect: mysql\n    datasource: user:pass@tcp(db:3306)/app?parseTime=true\n    dir: .\n```\n\nまた sql ファイルには `-- +migrate Up` と `-- +migrate Down` の記述が必要。\n```sql\n-- +migrate Up\nCREATE TABLE topics (\n  id varchar(255),\n  title varchar(255),\n  detail varchar(255)\n);\n\n-- +migrate Down\nDROP TABLE IF EXISTS topics;\n```\n\n## 実行\n```bash\n$ docker-compose -f docker-compose.migration.yml run migration bash\n$ sql-migrate up\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20211120165745"},"buildId":"mf1115FoHAIO_24TGLDdK","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>