<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/a58c9bb1e05a64ba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a58c9bb1e05a64ba.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-d38be8d96a62f950.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-a0dca5a2ff5035f1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f35537586aa9f5dd.js" defer=""></script><script src="/_next/static/chunks/996-eeb5175dbd5dba8f.js" defer=""></script><script src="/_next/static/chunks/635-77cab1cb386ca7f8.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-f16bc0121a6e0d8a.js" defer=""></script><script src="/_next/static/Pprqt13nm5vtswVY-tT11/_buildManifest.js" defer=""></script><script src="/_next/static/Pprqt13nm5vtswVY-tT11/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><a style="text-decoration:none" href="/"><div style="color:black;font-size:22px;cursor:pointer">MyDocs</div></a></div><p></p><h1><b># <!-- -->Golang の goroutine / channel とか</b></h1><h2>goroutine</h2>
<p>goroutine は軽量なスレッド。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">go</span><span> f(x, y)</span></code></pre></div></pre>
<p>と書くだけ。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">say</span><span class="hljs-function hljs-params">(s </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; </span><span class="hljs-number">5</span><span>; i++ {
</span><span>		time.Sleep(</span><span class="hljs-number">100</span><span> * time.Millisecond)
</span>		fmt.Println(s)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> say(</span><span style="color:#a6e22e">&quot;hello&quot;</span><span>)
</span><span>	say(</span><span style="color:#a6e22e">&quot;world&quot;</span><span>)
</span>}
<!-- -->
<span></span><span style="color:#75715e">// hello</span><span>
</span><span></span><span style="color:#75715e">// world</span><span>
</span><span></span><span style="color:#75715e">// world</span><span>
</span><span></span><span style="color:#75715e">// hello</span><span>
</span><span></span><span style="color:#75715e">// hello</span><span>
</span><span></span><span style="color:#75715e">// world</span><span>
</span><span></span><span style="color:#75715e">// hello</span><span>
</span><span></span><span style="color:#75715e">// world</span><span>
</span><span></span><span style="color:#75715e">// world</span><span>
</span><span></span><span style="color:#75715e">// hello</span></code></pre></div></pre>
<h2>channel</h2>
<p>channel 型は <code>&lt;-</code> を用いて値の送受信を行う。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span>ch &lt;- v </span><span style="color:#75715e">// v をチャネル ch に送信する</span><span>
</span><span>v := &lt;- ch </span><span style="color:#75715e">// チャネル ch から変数を v に割り当てる</span></code></pre></div></pre>
<p>チャネルは <code>make</code> で作る。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span>ch := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>)</span></code></pre></div></pre>
<p>通常、片方の準備ができるまで送受信はブロックされる。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">sum</span><span class="hljs-function hljs-params">(s []</span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, c </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">chan</span><span class="hljs-function hljs-params"> </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	sum := </span><span class="hljs-number">0</span><span>
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, v := </span><span style="color:#f92672;font-weight:bold">range</span><span> s {
</span>		sum += v
<!-- -->	}
<!-- -->	c &lt;- sum
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	s := []</span><span style="color:#f92672;font-weight:bold">int</span><span>{</span><span class="hljs-number">1</span><span>, </span><span class="hljs-number">2</span><span>, </span><span class="hljs-number">3</span><span>, </span><span class="hljs-number">4</span><span>, </span><span class="hljs-number">5</span><span>, </span><span class="hljs-number">6</span><span>, </span><span class="hljs-number">7</span><span>, </span><span class="hljs-number">8</span><span>, </span><span class="hljs-number">9</span><span>, </span><span class="hljs-number">10</span><span>}
</span><span>	c := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> sum(s[:</span><span style="color:#a6e22e">len</span><span>(s)/</span><span class="hljs-number">2</span><span>], c)
</span><span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> sum(s[</span><span style="color:#a6e22e">len</span><span>(s)/</span><span class="hljs-number">2</span><span>:], c)
</span><span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> sum(s, c)
</span>
<!-- -->	x, y := &lt;-c, &lt;-c
<!-- -->	z := &lt;-c
<!-- -->
<!-- -->	fmt.Println(x, y, z)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// 55 15 40</span><span>
</span><span></span><span style="color:#75715e">// 55 40 15</span><span>
</span><span></span><span style="color:#75715e">// 処理終わった順かな？</span></code></pre></div></pre>
<h3>バッファ</h3>
<p>チャネルはバッファとして使える。 make の 2 つ目の引数にバッファの長さを指定できる。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span>ch := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>, </span><span class="hljs-number">10</span><span>)</span></code></pre></div></pre>
<p>バッファ数を超えると deadlock になる。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	ch := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>, </span><span class="hljs-number">2</span><span>)
</span><span>	ch &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span><span>	ch &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	v := &lt;-ch
<span>	ch &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span><span>	</span><span style="color:#75715e">// ch &lt;- true // この行を入れると deadlock</span><span>
</span>
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(ch))
</span>	fmt.Println(&lt;-ch)
<!-- -->	fmt.Println(&lt;-ch)
<!-- -->	fmt.Println(v)
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(ch))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 2</span><span>
</span><span></span><span style="color:#75715e">// true</span><span>
</span><span></span><span style="color:#75715e">// true</span><span>
</span><span></span><span style="color:#75715e">// true</span><span>
</span><span></span><span style="color:#75715e">// 0</span></code></pre></div></pre>
<h3>close</h3>
<p>送信側はチャネルを <code>close</code> できる。
受信側はチャネルを <code>close</code> しているか確認できる。
受信する値はなく、かつチャネルが閉じているなら <code>ok</code> は <code>false</code> になる。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span>v, ok := &lt;- ch</span></code></pre></div></pre>
<p>ループのときはチャネルを使うとチャネルが閉じるまで値を受信し続ける。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">fibonacci</span><span class="hljs-function hljs-params">(n </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, c </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">chan</span><span class="hljs-function hljs-params"> </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	x, y := </span><span class="hljs-number">0</span><span>, </span><span class="hljs-number">1</span><span>
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; n; i++ {
</span>		c &lt;- x
<!-- -->		x, y = y, x+y
<!-- -->	}
<span>	</span><span style="color:#a6e22e">close</span><span>(c)
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	c := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>, </span><span class="hljs-number">10</span><span>)
</span><span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> fibonacci(</span><span style="color:#a6e22e">cap</span><span>(c), c)
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span style="color:#f92672;font-weight:bold">range</span><span> c {
</span>		fmt.Println(i)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// 0</span><span>
</span><span></span><span style="color:#75715e">// 1</span><span>
</span><span></span><span style="color:#75715e">// 1</span><span>
</span><span></span><span style="color:#75715e">// 2</span><span>
</span><span></span><span style="color:#75715e">// 3</span><span>
</span><span></span><span style="color:#75715e">// 5</span><span>
</span><span></span><span style="color:#75715e">// 8</span><span>
</span><span></span><span style="color:#75715e">// 13</span><span>
</span><span></span><span style="color:#75715e">// 21</span><span>
</span><span></span><span style="color:#75715e">// 34</span></code></pre></div></pre>
<h2>select</h2>
<p><code>select</code> は goroutine を複数の通信操作で待たせる。
case の準備ができるまでブロックする。複数の case が準備できている場合、 case はランダムに実行される。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">fibonacci</span><span class="hljs-function hljs-params">(c, quit </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">chan</span><span class="hljs-function hljs-params"> </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	x, y := </span><span class="hljs-number">0</span><span>, </span><span class="hljs-number">1</span><span>
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">select</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">case</span><span> c &lt;- x:
</span>			x, y = y, x+y
<span>		</span><span style="color:#f92672;font-weight:bold">case</span><span> &lt;-quit:
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;quit&quot;</span><span>)
</span><span>			</span><span style="color:#f92672;font-weight:bold">return</span><span>
</span>		}
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	c := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>)
</span><span>	quit := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">int</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; </span><span class="hljs-number">10</span><span>; i++ {
</span>			fmt.Println(&lt;-c)
<!-- -->		}
<span>		quit &lt;- </span><span class="hljs-number">0</span><span>
</span>	}()
<!-- -->	fibonacci(c, quit)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// 0</span><span>
</span><span></span><span style="color:#75715e">// 1</span><span>
</span><span></span><span style="color:#75715e">// 1</span><span>
</span><span></span><span style="color:#75715e">// 2</span><span>
</span><span></span><span style="color:#75715e">// 3</span><span>
</span><span></span><span style="color:#75715e">// 5</span><span>
</span><span></span><span style="color:#75715e">// 8</span><span>
</span><span></span><span style="color:#75715e">// 13</span><span>
</span><span></span><span style="color:#75715e">// 21</span><span>
</span><span></span><span style="color:#75715e">// 34</span><span>
</span><span></span><span style="color:#75715e">// quit</span></code></pre></div></pre>
<h3>default</h3>
<p>ブロックせずに送受信したいときには default を使う。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	tick := time.Tick(</span><span class="hljs-number">100</span><span> * time.Millisecond)
</span><span>	boom := time.Tick(</span><span class="hljs-number">500</span><span> * time.Millisecond)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">select</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">case</span><span> &lt;-tick:
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;tick&quot;</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">case</span><span> &lt;-boom:
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;boom&quot;</span><span>)
</span><span>			</span><span style="color:#f92672;font-weight:bold">return</span><span>
</span><span>		</span><span style="color:#f92672;font-weight:bold">default</span><span>:
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;   .&quot;</span><span>)
</span><span>			time.Sleep(</span><span class="hljs-number">50</span><span> * time.Millisecond)
</span>		}
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">// tick</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">// tick</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">// tick</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">// tick</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">//    .</span><span>
</span><span></span><span style="color:#75715e">// boom</span></code></pre></div></pre>
<h2>sync.Mutex</h2>
<p>コンフリクトを避け、 1 度に 1 つの goroutine だけが変数にアクセスできる。
Golang の標準パッケージは,排他制御を <code>sync.Mutex</code> と <code>Lock</code> 、 <code>Unlock</code> で提供している。</p>
<pre><div class="sc-bcXHqe lmagiH"><div class="sc-gswNZR jJknjO">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> SafeCounter </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span>	mu sync.Mutex
<span>	v  </span><span style="color:#f92672;font-weight:bold">map</span><span>[</span><span style="color:#f92672;font-weight:bold">string</span><span>]</span><span style="color:#f92672;font-weight:bold">int</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function hljs-params">(c *SafeCounter)</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">Inc</span><span class="hljs-function hljs-params">(key </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span>	c.mu.Lock()
<!-- -->	c.v[key]++
<!-- -->	c.mu.Unlock()
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function hljs-params">(c *SafeCounter)</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">Value</span><span class="hljs-function hljs-params">(key </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">int</span><span> {
</span>	c.mu.Lock()
<span>	</span><span style="color:#f92672;font-weight:bold">defer</span><span> c.mu.Unlock()
</span><span>	</span><span style="color:#f92672;font-weight:bold">return</span><span> c.v[key]
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span>	c := SafeCounter{
<span>		v: </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">map</span><span>[</span><span style="color:#f92672;font-weight:bold">string</span><span>]</span><span style="color:#f92672;font-weight:bold">int</span><span>),
</span>	}
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; </span><span class="hljs-number">1000</span><span>; i++ {
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> c.Inc(</span><span style="color:#a6e22e">&quot;somekey&quot;</span><span>)
</span>	}
<!-- -->	time.Sleep(time.Second)
<span>	fmt.Println(c.Value(</span><span style="color:#a6e22e">&quot;somekey&quot;</span><span>))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 1000</span></code></pre></div></pre></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"contents":{"id":"20210429010135","title":"Golang の goroutine / channel とか","body":"\n## goroutine\ngoroutine は軽量なスレッド。\n```go\ngo f(x, y)\n```\nと書くだけ。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc say(s string) {\n\tfor i := 0; i \u003c 5; i++ {\n\t\ttime.Sleep(100 * time.Millisecond)\n\t\tfmt.Println(s)\n\t}\n}\n\nfunc main() {\n\tgo say(\"hello\")\n\tsay(\"world\")\n}\n\n// hello\n// world\n// world\n// hello\n// hello\n// world\n// hello\n// world\n// world\n// hello\n```\n\n## channel\nchannel 型は `\u003c-` を用いて値の送受信を行う。\n```go\nch \u003c- v // v をチャネル ch に送信する\nv := \u003c- ch // チャネル ch から変数を v に割り当てる\n```\n\nチャネルは `make` で作る。\n```go\nch := make(chan int)\n```\n通常、片方の準備ができるまで送受信はブロックされる。\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc sum(s []int, c chan int) {\n\tsum := 0\n\tfor _, v := range s {\n\t\tsum += v\n\t}\n\tc \u003c- sum\n}\n\nfunc main() {\n\ts := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n\tc := make(chan int)\n\n\tgo sum(s[:len(s)/2], c)\n\tgo sum(s[len(s)/2:], c)\n\tgo sum(s, c)\n\n\tx, y := \u003c-c, \u003c-c\n\tz := \u003c-c\n\n\tfmt.Println(x, y, z)\n}\n\n// 55 15 40\n// 55 40 15\n// 処理終わった順かな？\n```\n\n### バッファ\nチャネルはバッファとして使える。 make の 2 つ目の引数にバッファの長さを指定できる。\n```go\nch := make(chan int, 10)\n```\n\nバッファ数を超えると deadlock になる。\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n\tch := make(chan bool, 2)\n\tch \u003c- true\n\tch \u003c- true\n\tv := \u003c-ch\n\tch \u003c- true\n\t// ch \u003c- true // この行を入れると deadlock\n\n\tfmt.Println(len(ch))\n\tfmt.Println(\u003c-ch)\n\tfmt.Println(\u003c-ch)\n\tfmt.Println(v)\n\tfmt.Println(len(ch))\n}\n\n// 2\n// true\n// true\n// true\n// 0\n```\n\n### close\n送信側はチャネルを `close` できる。\n受信側はチャネルを `close` しているか確認できる。\n受信する値はなく、かつチャネルが閉じているなら `ok` は `false` になる。\n```go\nv, ok := \u003c- ch\n```\n\nループのときはチャネルを使うとチャネルが閉じるまで値を受信し続ける。\n```go\npackage main\n\nimport \"fmt\"\n\nfunc fibonacci(n int, c chan int) {\n\tx, y := 0, 1\n\tfor i := 0; i \u003c n; i++ {\n\t\tc \u003c- x\n\t\tx, y = y, x+y\n\t}\n\tclose(c)\n}\n\nfunc main() {\n\tc := make(chan int, 10)\n\tgo fibonacci(cap(c), c)\n\tfor i := range c {\n\t\tfmt.Println(i)\n\t}\n}\n\n// 0\n// 1\n// 1\n// 2\n// 3\n// 5\n// 8\n// 13\n// 21\n// 34\n```\n\n## select\n`select` は goroutine を複数の通信操作で待たせる。\ncase の準備ができるまでブロックする。複数の case が準備できている場合、 case はランダムに実行される。\n```go\npackage main\n\nimport \"fmt\"\n\nfunc fibonacci(c, quit chan int) {\n\tx, y := 0, 1\n\tfor {\n\t\tselect {\n\t\tcase c \u003c- x:\n\t\t\tx, y = y, x+y\n\t\tcase \u003c-quit:\n\t\t\tfmt.Println(\"quit\")\n\t\t\treturn\n\t\t}\n\t}\n}\n\nfunc main() {\n\tc := make(chan int)\n\tquit := make(chan int)\n\n\tgo func() {\n\t\tfor i := 0; i \u003c 10; i++ {\n\t\t\tfmt.Println(\u003c-c)\n\t\t}\n\t\tquit \u003c- 0\n\t}()\n\tfibonacci(c, quit)\n}\n\n// 0\n// 1\n// 1\n// 2\n// 3\n// 5\n// 8\n// 13\n// 21\n// 34\n// quit\n```\n\n### default\nブロックせずに送受信したいときには default を使う。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\ttick := time.Tick(100 * time.Millisecond)\n\tboom := time.Tick(500 * time.Millisecond)\n\n\tfor {\n\t\tselect {\n\t\tcase \u003c-tick:\n\t\t\tfmt.Println(\"tick\")\n\t\tcase \u003c-boom:\n\t\t\tfmt.Println(\"boom\")\n\t\t\treturn\n\t\tdefault:\n\t\t\tfmt.Println(\"   .\")\n\t\t\ttime.Sleep(50 * time.Millisecond)\n\t\t}\n\t}\n}\n\n//    .\n//    .\n// tick\n//    .\n//    .\n// tick\n//    .\n//    .\n// tick\n//    .\n//    .\n// tick\n//    .\n//    .\n// boom\n```\n\n## sync.Mutex\nコンフリクトを避け、 1 度に 1 つの goroutine だけが変数にアクセスできる。\nGolang の標準パッケージは,排他制御を `sync.Mutex` と `Lock` 、 `Unlock` で提供している。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n\t\"time\"\n)\n\ntype SafeCounter struct {\n\tmu sync.Mutex\n\tv  map[string]int\n}\n\nfunc (c *SafeCounter) Inc(key string) {\n\tc.mu.Lock()\n\tc.v[key]++\n\tc.mu.Unlock()\n}\n\nfunc (c *SafeCounter) Value(key string) int {\n\tc.mu.Lock()\n\tdefer c.mu.Unlock()\n\treturn c.v[key]\n}\n\nfunc main() {\n\tc := SafeCounter{\n\t\tv: make(map[string]int),\n\t}\n\n\tfor i := 0; i \u003c 1000; i++ {\n\t\tgo c.Inc(\"somekey\")\n\t}\n\ttime.Sleep(time.Second)\n\tfmt.Println(c.Value(\"somekey\"))\n}\n\n// 1000\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20210429010135"},"buildId":"Pprqt13nm5vtswVY-tT11","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>