<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/0675b109fae35ba9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0675b109fae35ba9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-0f8b31729833af61.js" defer=""></script><script src="/_next/static/chunks/main-a89779f987984dde.js" defer=""></script><script src="/_next/static/chunks/pages/_app-eddec6d010f06c43.js" defer=""></script><script src="/_next/static/chunks/548-2da8f2137a34d623.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-3337e28c632a2e4a.js" defer=""></script><script src="/_next/static/GXoiw4l0rQd_zf7dqPS3j/_buildManifest.js" defer=""></script><script src="/_next/static/GXoiw4l0rQd_zf7dqPS3j/_ssgManifest.js" defer=""></script><script src="/_next/static/GXoiw4l0rQd_zf7dqPS3j/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->Docker と docker-compose のまとめ</b></h1><h2>Docker</h2>
<p><code node="[object Object]">Dockerfile</code> を元にイメージを構築する.</p>
<h3>build</h3>
<p><code node="[object Object]">Dockerfile</code> が存在するディレクトリで実行する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker build .</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">-f</code> オプションを使うことで Dockerfile のパスを指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker build -f /path/to/Dockerfile .</span></code></div><p class="h-2"></p></pre>
<h3>FROM</h3>
<p>ベースイメージを指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>FROM &lt;image&gt;[:&lt;tag&gt;][AS &lt;name&gt;]</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">AS &lt;name&gt;</code> でステージに名前を付けて,以降の <code node="[object Object]">FROM</code> と <code node="[object Object]">COPY --from=&lt;name&gt;</code> 命令で構築イメージを参照できる.</p>
<h3>RUN</h3>
<p>シェルとして実行される.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>RUN </span><span style="color:#bf79db">/bin/</span><span>sh -c </span><span style="color:#a6e22e">&#x27;source $HOME/.bashrc;&#x27;</span><span> \
</span><span>echo </span><span style="color:#a6e22e">$HOME</span></code></div><p class="h-2"></p></pre>
<p>1 行で書く場合.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span style="color:#f92672;font-weight:bold">RUN</span><span> /bin/</span><span style="color:#f92672;font-weight:bold">sh</span><span> -c &#x27;source </span><span style="color:#a6e22e">$HOME</span><span>/.bashrc; echo </span><span style="color:#a6e22e">$HOME</span><span>&#x27;</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">bash/sh</code> 以外のシェルを使う場合は <code node="[object Object]">exec</code> 形式でシェルに引数を渡す.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>RUN [</span><span style="color:#a6e22e">&quot;/bin/bash&quot;</span><span>, </span><span style="color:#a6e22e">&quot;-c&quot;</span><span>, </span><span style="color:#a6e22e">&quot;echo hello&quot;</span><span>]</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">exec</code> 形式で書く場合は json 配列として扱わるため <code node="[object Object]">&quot;&quot;</code> で囲む必要がある.</p>
<h3>CMD</h3>
<p><code node="[object Object]">Dockerfile</code> 内の <code node="[object Object]">CMD</code> 命令は 1 つのみ.複数あっても最後の <code node="[object Object]">CMD</code> 命令のみが実行される.
<strong>CMD の目的はコンテナの実行時のデフォルトの処理を指定する</strong></p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>FROM ubuntu
</span><span>CMD [</span><span style="color:#a6e22e">&quot;/usr/bin/wc&quot;</span><span>, </span><span style="color:#a6e22e">&quot;--help&quot;</span><span>]</span></code></div><p class="h-2"></p></pre>
<h3>ADD / COPY</h3>
<p><code node="[object Object]">&lt;src&gt;</code> で指定したファイル,ディレクトリをコンテナ内の <code node="[object Object]">&lt;dest&gt;</code> にコピーする.
ローカルのファイルをコンテナにコピーしたい場合は <code node="[object Object]">COPY</code> を使う.
<code node="[object Object]">ADD</code> はローカルでの圧縮ファイルの展開やリモートファイルの展開したい場面で使う.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>ADD [--chown=</span><span style="color:#bf79db">&lt;ユーザ&gt;</span><span>:</span><span style="color:#bf79db">&lt;グループ&gt;</span><span>] </span><span style="color:#bf79db">&lt;src&gt;</span><span> </span><span style="color:#bf79db">&lt;dest&gt;</span><span>
</span><span>COPY [--chown=</span><span style="color:#bf79db">&lt;ユーザ&gt;</span><span>:</span><span style="color:#bf79db">&lt;グループ&gt;</span><span>] </span><span style="color:#bf79db">&lt;src&gt;</span><span> </span><span style="color:#bf79db">&lt;dest&gt;</span></code></div><p class="h-2"></p></pre>
<h3>EXPOSE</h3>
<p>コンテナが接続するためのリッスンするポートを指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span style="color:#bf79db">EXPOSE</span><span> </span><span class="hljs-number">80</span></code></div><p class="h-2"></p></pre>
<p>実際にはポートの公開は行われない.ドキュメント的な用途として使われる.
実際に公開して使うには, <code node="[object Object]">docker run</code> の際にフラグをつける.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker run --rm -it -p 80:80 &lt;image&gt; bash</span></code></div><p class="h-2"></p></pre>
<h3>ENV</h3>
<p>環境変数の設定をする.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>ENV </span><span style="color:#f92672">&lt;</span><span style="color:#f92672">key</span><span style="color:#f92672">&gt;</span><span>=</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">value</span><span style="color:#f92672">&gt;</span></code></div><p class="h-2"></p></pre>
<p>環境変数は, <code node="[object Object]">Dockerfile</code> 内の変数として使える.
使い方は, <code node="[object Object]">$variable_name</code> もしくは, <code node="[object Object]">${variable_name}</code></p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span style="color:#f92672;font-weight:bold">FROM</span><span> &lt;image&gt;
</span><span></span><span style="color:#f92672;font-weight:bold">ENV</span><span> FOO=/bar
</span><span></span><span style="color:#f92672;font-weight:bold">WORKDIR</span><span class="bash"> </span><span class="bash" style="color:#a6e22e">${FOO}</span><span class="bash"> </span><span class="bash" style="color:#75715e"># WORKDIR /bar</span></code></div><p class="h-2"></p></pre>
<h3>ENTRYPOINT</h3>
<p>最適な使い方はイメージに対してメインのコマンドを設定しておき, <code node="[object Object]">CMD</code> を使ってデフォルトフラグを指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>ENTRYPOINT [</span><span style="color:#a6e22e">&quot;go&quot;</span><span>]
</span><span>CMD [</span><span style="color:#a6e22e">&quot;--help&quot;</span><span>]</span></code></div><p class="h-2"></p></pre>
<p>パラメータを指定して起動することでコマンドの実行ができる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker run &lt;image&gt; run main.go</span></code></div><p class="h-2"></p></pre>
<h3>VOLUME</h3>
<p>コンテナによって作成されるファイルやフォルダの公開に使う.イメージの可変的な部分,ユーザが設定可能な部分について使う.</p>
<h3>USER</h3>
<p>非 root ユーザで実行可能な場合は <code node="[object Object]">USER</code> を使ってユーザの変更する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>USER </span><span style="color:#bf79db">&lt;ユーザ&gt;</span><span>[:</span><span style="color:#bf79db">&lt;グループ&gt;</span><span>]</span></code></div><p class="h-2"></p></pre>
<h3>WORKDIR</h3>
<p>Dockerfile で続く <code node="[object Object]">RUN</code>, <code node="[object Object]">CMD</code>, <code node="[object Object]">ENTRYPOINT</code>, <code node="[object Object]">COPY / ADD</code> の命令の処理時で使う作業ディレクトリを指定する.</p>
<h3>ARG</h3>
<p><code node="[object Object]">build</code> 時にユーザが渡せる変数を定義する.
構築時には <code node="[object Object]">docker build --build-arg &lt;変数名&gt;=&lt;値&gt;</code> を指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>ARG </span><span style="color:#bf79db">&lt;name&gt;</span><span>[=</span><span style="color:#bf79db">&lt;デフォルト値&gt;</span><span>]</span></code></div><p class="h-2"></p></pre>
<h2>docker-compose</h2>
<p>サービスを定義する.</p>
<h3>build</h3>
<p>ビルド時に適用される.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  webapp:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span> ./dir</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">context</code> でパスを指定し, <code node="[object Object]">Dockerfile</code> や <code node="[object Object]">args</code> も指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  webapp:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span>
</span><span></span><span style="color:#bf79db">      context:</span><span> ./dir
</span><span></span><span style="color:#bf79db">      dockerfile:</span><span> Dockerfile-alternate
</span><span></span><span style="color:#bf79db">      args:</span><span>
</span><span></span><span style="color:#bf79db">        buildno:</span><span> </span><span class="hljs-number">1</span></code></div><p class="h-2"></p></pre>
<p><code node="[object Object]">image</code> 名と <code node="[object Object]">tag</code> を指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span> ./dir
</span><span></span><span style="color:#bf79db">image:</span><span> webapp:tag</span></code></div><p class="h-2"></p></pre>
<h3>context</h3>
<p><code node="[object Object]">Dockerfile</code> を含むディレクトリへのパスか, git リポジトリの URL を指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> ./dir</span></code></div><p class="h-2"></p></pre>
<h3>dockerfile</h3>
<p>別の <code node="[object Object]">Dockerfile</code> を指定する.この場合,ビルドパスを同時に指定する必要がある.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> .
</span><span></span><span style="color:#bf79db">  dockerfile:</span><span> Dockerfile-alternate</span></code></div><p class="h-2"></p></pre>
<h3>args</h3>
<p>ビルド時にのみ有効な環境変数を設定する.
個々をマッピングするか,リストで書く.ブール値はクォートで囲む.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> .
</span><span></span><span style="color:#bf79db">  args:</span><span>
</span><span></span><span style="color:#bf79db">    buildno:</span><span> </span><span class="hljs-number">1</span><span>
</span><span></span><span style="color:#bf79db">    gitcommithash:</span><span> abc123</span></code></div><p class="h-2"></p></pre>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>build:
</span>  context: .
<!-- -->  args:
<span>    - </span><span class="hljs-attr">buildno</span><span>=</span><span class="hljs-number">1</span><span>
</span><span>    - </span><span class="hljs-attr">gitcommithash</span><span>=abc123</span></code></div><p class="h-2"></p></pre>
<h3>command</h3>
<p>デフォルトのコマンドを上書きする.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#a6e22e">command</span><span>: bundle </span><span style="color:#a6e22e">exec</span><span> thin -p 3000</span></code></div><p class="h-2"></p></pre>
<p>リスト形式も可能.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>command: [</span><span style="color:#a6e22e">&quot;bundle&quot;</span><span>, </span><span style="color:#a6e22e">&quot;exec&quot;</span><span>, </span><span style="color:#a6e22e">&quot;thin&quot;</span><span>, </span><span style="color:#a6e22e">&quot;-p&quot;</span><span>, </span><span style="color:#a6e22e">&quot;3000&quot;</span><span>]</span></code></div><p class="h-2"></p></pre>
<h3>depends_on</h3>
<p>サービス起動の依存関係を表す.
以下の場合, db と redis の起動後に web が起動する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.9&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  web:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span> .
</span><span></span><span style="color:#bf79db">    depends_on:</span><span>
</span>      - db
<!-- -->      - redis
<span></span><span style="color:#bf79db">  redis:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> redis
</span><span></span><span style="color:#bf79db">  db:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> postgres</span></code></div><p class="h-2"></p></pre>
<h3>entrypoint</h3>
<p>デフォルトのエントリーポイントを上書きする.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>entrypoint: </span><span style="color:#bf79db">/code/</span><span>entrypoint.sh</span></code></div><p class="h-2"></p></pre>
<p>リスト形式も可能.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>entrypoint: [</span><span style="color:#a6e22e">&quot;php&quot;</span><span>, </span><span style="color:#a6e22e">&quot;-d&quot;</span><span>, </span><span style="color:#a6e22e">&quot;memry_limit=1&quot;</span><span>, </span><span style="color:#a6e22e">&quot;vendor/bin/phpunit&quot;</span><span>]</span></code></div><p class="h-2"></p></pre>
<h3>environment</h3>
<p>環境変数を追加する.
個々をマッピングするか,リストで書く.ブール値はクォートで囲む.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">environment:</span><span>
</span><span></span><span style="color:#bf79db">  RACK_ENV:</span><span> development
</span><span></span><span style="color:#bf79db">  SHOW:</span><span> </span><span style="color:#a6e22e">&#x27;true&#x27;</span><span>
</span><span></span><span style="color:#bf79db">  SESSION_SECRET:</span></code></div><p class="h-2"></p></pre>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>environment:
</span><span>  - </span><span class="hljs-attr">RACK_ENV</span><span>=development
</span><span>  - </span><span class="hljs-attr">SHOW</span><span>=</span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>  - SESSION_SECRET
</code></div><p class="h-2"></p></pre>
<h3>expose</h3>
<p>ホストマシンにはポートを公開せずに,ポートを expose する.
リンクされたサービスのみアクセス可能.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>expose:
</span><span>  -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;3000&quot;</span><span class="ruby">
</span><span class="ruby"></span><span>  -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;8000&quot;</span></code></div><p class="h-2"></p></pre>
<h3>external_links</h3>
<p>実行する <code node="[object Object]">docker-compose.yml</code> 以外から起動されたコンテナをリンクする.
コンテナ名とエイリアス名 (CONTAINER:ALIAS) を指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>external_links:
</span><span>  -</span><span class="ruby"> redis_1
</span><span class="ruby"></span><span>  -</span><span class="ruby"> </span><span class="ruby" style="color:#bf79db">project_db_1:</span><span class="ruby">mysql</span></code></div><p class="h-2"></p></pre>
<h3>extra_hosts</h3>
<p>ホスト名をマッピングに追加する.
<code node="[object Object]">/etc/hosts</code> に追加される.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">extra_hosts:</span><span>
</span><span>  - </span><span style="color:#a6e22e">&quot;somehost:162.242.195.82&quot;</span></code></div><p class="h-2"></p></pre>
<h3>ports</h3>
<p>公開用のポートを設定する.
ホスト側とコンテナ側のポートを指定する( <code node="[object Object]">HOST:CONTAINER</code> ).
もしくは,コンテナ側のポートを指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">ports</span><span>:
</span><span>  - &quot;</span><span style="color:#bf79db">3000</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">3000</span><span>-</span><span class="hljs-number">3005</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">8000</span><span>:</span><span class="hljs-number">8000</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">9090</span><span>-</span><span class="hljs-number">9091</span><span>:</span><span class="hljs-number">8080</span><span>-</span><span class="hljs-number">8081</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">49100</span><span>:</span><span class="hljs-number">22</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">127.0.0.1:8001</span><span>:</span><span class="hljs-number">8001</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">127.0.0.1:5000</span><span>-</span><span class="hljs-number">5010</span><span>:</span><span class="hljs-number">5000</span><span>-</span><span class="hljs-number">5010</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">6060</span><span>:</span><span class="hljs-number">6060</span><span>/udp</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">12400</span><span>-</span><span class="hljs-number">12500</span><span>:</span><span class="hljs-number">1240</span><span style="color:#a6e22e">&quot;</span></code></div><p class="h-2"></p></pre>
<h3>volumes</h3>
<p>複数のサービスにわたってボリュームを再利用したい場合,最上位の <code node="[object Object]">volumes</code> キーで名前付きボリュームを定義する.
以下の場合, db サービスのデータディレクトリは, backup サービスのボリュームにも共有させている.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.9&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  db:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> db
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span><span>      - data-volume:</span><span class="hljs-meta-keyword">/var/</span><span>lib/db
</span><span></span><span style="color:#bf79db">  backup:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> backup-service
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span><span>      - data-volume:</span><span class="hljs-meta-keyword">/var/</span><span>lib</span><span class="hljs-meta-keyword">/backup/</span><span>data
</span><span></span><span style="color:#bf79db">volumes:</span><span>
</span>  data-volume:
</code></div><p class="h-2"></p></pre>
<p>短い書き方では, <code node="[object Object]">[SOURCE:]TARGET[:MODE]</code> と書ける. <code node="[object Object]">ro</code> は <code node="[object Object]">readonly</code> .</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>- ./cache:</span><span style="color:#bf79db">/tmp/</span><span>cache:ro</span></code></div><p class="h-2"></p></pre>
<h3>変数の置換</h3>
<p>シェル環境に <code node="[object Object]">POSTGRES_VERSION=9.3</code> が定義されていると, postgres のバージョンは 9.3 になる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">db:</span><span>
</span><span></span><span style="color:#bf79db">  image:</span><span> </span><span style="color:#a6e22e">&quot;postgres:${POSTGRES_VERSION}&quot;</span></code></div><p class="h-2"></p></pre>
<p>環境変数が設定されていない場合は空文字になる.
環境変数のデフォルト値は <code node="[object Object]">.env</code> ファイルに設定しておくことができる.</p>
<ul>
<li>${VARIABLE:-default} は VARIABLE がセットされていないか, 空文字のときに <code node="[object Object]">default</code> として評価される</li>
<li>${VARIABLE-default} は VARIABLE がセットされているときのみ <code node="[object Object]">default</code> として評価される</li>
</ul></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20210306225218","title":"Docker と docker-compose のまとめ","content":"\n## Docker\n`Dockerfile` を元にイメージを構築する.\n\n### build\n`Dockerfile` が存在するディレクトリで実行する.\n```bash\n$ docker build .\n```\n\n`-f` オプションを使うことで Dockerfile のパスを指定できる.\n```bash\n$ docker build -f /path/to/Dockerfile .\n```\n\n### FROM\nベースイメージを指定する.\n```Dockerfile\nFROM \u003cimage\u003e[:\u003ctag\u003e][AS \u003cname\u003e]\n```\n`AS \u003cname\u003e` でステージに名前を付けて,以降の `FROM` と `COPY --from=\u003cname\u003e` 命令で構築イメージを参照できる.\n\n### RUN\nシェルとして実行される.\n```Dockerfile\nRUN /bin/sh -c 'source $HOME/.bashrc;' \\\necho $HOME\n```\n\n1 行で書く場合.\n```Dockerfile\nRUN /bin/sh -c 'source $HOME/.bashrc; echo $HOME'\n```\n\n`bash/sh` 以外のシェルを使う場合は `exec` 形式でシェルに引数を渡す.\n```Dockerfile\nRUN [\"/bin/bash\", \"-c\", \"echo hello\"]\n```\n`exec` 形式で書く場合は json 配列として扱わるため `\"\"` で囲む必要がある.\n\n### CMD\n`Dockerfile` 内の `CMD` 命令は 1 つのみ.複数あっても最後の `CMD` 命令のみが実行される.\n**CMD の目的はコンテナの実行時のデフォルトの処理を指定する**\n```Dockerfile\nFROM ubuntu\nCMD [\"/usr/bin/wc\", \"--help\"]\n```\n\n### ADD / COPY\n`\u003csrc\u003e` で指定したファイル,ディレクトリをコンテナ内の `\u003cdest\u003e` にコピーする.\nローカルのファイルをコンテナにコピーしたい場合は `COPY` を使う.\n`ADD` はローカルでの圧縮ファイルの展開やリモートファイルの展開したい場面で使う.\n```Dockerfile\nADD [--chown=\u003cユーザ\u003e:\u003cグループ\u003e] \u003csrc\u003e \u003cdest\u003e\nCOPY [--chown=\u003cユーザ\u003e:\u003cグループ\u003e] \u003csrc\u003e \u003cdest\u003e\n```\n\n### EXPOSE\nコンテナが接続するためのリッスンするポートを指定する.\n```Dockerfile\nEXPOSE 80\n```\n実際にはポートの公開は行われない.ドキュメント的な用途として使われる.\n実際に公開して使うには, `docker run` の際にフラグをつける.\n```bash\n$ docker run --rm -it -p 80:80 \u003cimage\u003e bash\n```\n\n### ENV\n環境変数の設定をする.\n```Dockerfile\nENV \u003ckey\u003e=\u003cvalue\u003e\n```\n環境変数は, `Dockerfile` 内の変数として使える.\n使い方は, `$variable_name` もしくは, `${variable_name}`\n```Dockerfile\nFROM \u003cimage\u003e\nENV FOO=/bar\nWORKDIR ${FOO} # WORKDIR /bar\n```\n\n### ENTRYPOINT\n最適な使い方はイメージに対してメインのコマンドを設定しておき, `CMD` を使ってデフォルトフラグを指定する.\n```Dockerfile\nENTRYPOINT [\"go\"]\nCMD [\"--help\"]\n```\nパラメータを指定して起動することでコマンドの実行ができる.\n```bash\n$ docker run \u003cimage\u003e run main.go\n```\n\n### VOLUME\nコンテナによって作成されるファイルやフォルダの公開に使う.イメージの可変的な部分,ユーザが設定可能な部分について使う.\n\n### USER\n非 root ユーザで実行可能な場合は `USER` を使ってユーザの変更する.\n```Dockerfile\nUSER \u003cユーザ\u003e[:\u003cグループ\u003e]\n```\n\n### WORKDIR\nDockerfile で続く `RUN`, `CMD`, `ENTRYPOINT`, `COPY / ADD` の命令の処理時で使う作業ディレクトリを指定する.\n\n### ARG\n`build` 時にユーザが渡せる変数を定義する.\n構築時には `docker build --build-arg \u003c変数名\u003e=\u003c値\u003e` を指定する.\n```Dockerfile\nARG \u003cname\u003e[=\u003cデフォルト値\u003e]\n```\n\n## docker-compose\nサービスを定義する.\n\n### build\nビルド時に適用される.\n```yml\nservices:\n  webapp:\n    build: ./dir\n```\n\n`context` でパスを指定し, `Dockerfile` や `args` も指定できる.\n```yml\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1\n```\n\n`image` 名と `tag` を指定できる.\n```yml\nbuild: ./dir\nimage: webapp:tag\n```\n\n### context\n`Dockerfile` を含むディレクトリへのパスか, git リポジトリの URL を指定する.\n```yml\nbuild:\n  context: ./dir\n```\n\n### dockerfile\n別の `Dockerfile` を指定する.この場合,ビルドパスを同時に指定する必要がある.\n```yml\nbuild:\n  context: .\n  dockerfile: Dockerfile-alternate\n```\n\n### args\nビルド時にのみ有効な環境変数を設定する.\n個々をマッピングするか,リストで書く.ブール値はクォートで囲む.\n```yml\nbuild:\n  context: .\n  args:\n    buildno: 1\n    gitcommithash: abc123\n```\n```yml\nbuild:\n  context: .\n  args:\n    - buildno=1\n    - gitcommithash=abc123\n```\n\n### command\nデフォルトのコマンドを上書きする.\n```yml\ncommand: bundle exec thin -p 3000\n```\nリスト形式も可能.\n```yml\ncommand: [\"bundle\", \"exec\", \"thin\", \"-p\", \"3000\"]\n```\n\n### depends_on\nサービス起動の依存関係を表す.\n以下の場合, db と redis の起動後に web が起動する.\n```yml\nversion: \"3.9\"\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n  redis:\n    image: redis\n  db:\n    image: postgres\n```\n\n### entrypoint\nデフォルトのエントリーポイントを上書きする.\n```yml\nentrypoint: /code/entrypoint.sh\n```\nリスト形式も可能.\n```yml\nentrypoint: [\"php\", \"-d\", \"memry_limit=1\", \"vendor/bin/phpunit\"]\n```\n\n### environment\n環境変数を追加する.\n個々をマッピングするか,リストで書く.ブール値はクォートで囲む.\n```yml\nenvironment:\n  RACK_ENV: development\n  SHOW: 'true'\n  SESSION_SECRET:\n```\n```yml\nenvironment:\n  - RACK_ENV=development\n  - SHOW=true\n  - SESSION_SECRET\n```\n\n### expose\nホストマシンにはポートを公開せずに,ポートを expose する.\nリンクされたサービスのみアクセス可能.\n```yml\nexpose:\n  - \"3000\"\n  - \"8000\"\n```\n\n### external_links\n実行する `docker-compose.yml` 以外から起動されたコンテナをリンクする.\nコンテナ名とエイリアス名 (CONTAINER:ALIAS) を指定する.\n```yml\nexternal_links:\n  - redis_1\n  - project_db_1:mysql\n```\n\n### extra_hosts\nホスト名をマッピングに追加する.\n`/etc/hosts` に追加される.\n```yml\nextra_hosts:\n  - \"somehost:162.242.195.82\"\n```\n\n### ports\n公開用のポートを設定する.\nホスト側とコンテナ側のポートを指定する( `HOST:CONTAINER` ).\nもしくは,コンテナ側のポートを指定する.\n```yml\nports:\n  - \"3000\"\n  - \"3000-3005\"\n  - \"8000:8000\"\n  - \"9090-9091:8080-8081\"\n  - \"49100:22\"\n  - \"127.0.0.1:8001:8001\"\n  - \"127.0.0.1:5000-5010:5000-5010\"\n  - \"6060:6060/udp\"\n  - \"12400-12500:1240\"\n```\n\n### volumes\n複数のサービスにわたってボリュームを再利用したい場合,最上位の `volumes` キーで名前付きボリュームを定義する.\n以下の場合, db サービスのデータディレクトリは, backup サービスのボリュームにも共有させている.\n```yml\nversion: \"3.9\"\nservices:\n  db:\n    image: db\n    volumes:\n      - data-volume:/var/lib/db\n  backup:\n    image: backup-service\n    volumes:\n      - data-volume:/var/lib/backup/data\nvolumes:\n  data-volume:\n```\n短い書き方では, `[SOURCE:]TARGET[:MODE]` と書ける. `ro` は `readonly` .\n```yml\n- ./cache:/tmp/cache:ro\n```\n\n### 変数の置換\nシェル環境に `POSTGRES_VERSION=9.3` が定義されていると, postgres のバージョンは 9.3 になる.\n```yml\ndb:\n  image: \"postgres:${POSTGRES_VERSION}\"\n```\n\n環境変数が設定されていない場合は空文字になる.\n環境変数のデフォルト値は `.env` ファイルに設定しておくことができる.\n- ${VARIABLE:-default} は VARIABLE がセットされていないか, 空文字のときに `default` として評価される\n- ${VARIABLE-default} は VARIABLE がセットされているときのみ `default` として評価される\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20210306225218"},"buildId":"GXoiw4l0rQd_zf7dqPS3j","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>