<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/4f6358649898043ee7a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4f6358649898043ee7a7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-1f2c591c5d3bfcfc95e6.js" defer=""></script><script src="/_next/static/chunks/pages/_app-42cedee763d16b21c0e8.js" defer=""></script><script src="/_next/static/chunks/408-35579d04b0c1f804c73d.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-217c0c73201253baba1b.js" defer=""></script><script src="/_next/static/jMPZ-oWD6b9SVbil7VCD9/_buildManifest.js" defer=""></script><script src="/_next/static/jMPZ-oWD6b9SVbil7VCD9/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div><div class="bg-gray-600 h-10 leading-10 text-2xl"><a class="no-underline text-gray-100 mx-2" href="/">MyDocs</a></div></div><div class="mx-7"><h1><b># <!-- -->Docker と docker-compose のまとめ</b></h1><h2>Docker</h2>
<h2>build</h2>
<p>Dockerfile が存在するディレクトリで実行.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker build .</span></code></div></pre>
<p><code node="[object Object]">-f</code> オプションを付けることでパスを指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker build -f /path/to/Dockerfile .</span></code></div></pre>
<p><code node="[object Object]">-t</code> オプションを付けることでリポジトリとタグを指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>$ docker build -t shukes/myapp .</span></code></div></pre>
<h2>FROM</h2>
<p>ベースイメージを指定.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>FROM &lt;image&gt;[:&lt;tag&gt;][AS &lt;name&gt;]</span></code></div></pre>
<h2>RUN</h2>
<p>シェルとして実行される.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>RUN </span><span style="color:#bf79db">/bin/</span><span>bash -c </span><span style="color:#a6e22e">&#x27;source $HOME/.bashrc;&#x27;</span><span> \
</span><span>echo </span><span style="color:#a6e22e">$HOME</span></code></div></pre>
<p>1 行で書く場合.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>RUN </span><span style="color:#bf79db">/bin/</span><span>bash -c </span><span style="color:#a6e22e">&#x27;source $HOME/.bashrc; echo $HOME&#x27;</span></code></div></pre>
<p><code node="[object Object]">/bash/sh</code> 以外の別のシェルを使う場合は exec 形式でシェルに引数を渡す.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>RUN [</span><span style="color:#a6e22e">&quot;/bin/bash&quot;</span><span>, </span><span style="color:#a6e22e">&quot;-c&quot;</span><span>, </span><span style="color:#a6e22e">&quot;echo hello&quot;</span><span>]</span></code></div></pre>
<p>exec 形式で書く場合は json 配列として扱われるので <code node="[object Object]">&quot;&quot;</code> で囲む必要がある.</p>
<h2>CMD</h2>
<p>Dockerfile 内で CMD 命令は 1 つのみ.
複数あっても最後の CMD 命令のみが実行される.</p>
<p><strong>CMD の主目的はコンテナ実行時のデフォルト処理を指定する</strong></p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-Dockerfile" style="white-space:pre"><span>FROM ubuntu
</span><span>CMD [</span><span style="color:#a6e22e">&quot;/usr/bin/wc&quot;</span><span>, </span><span style="color:#a6e22e">&quot;--help&quot;</span><span>]</span></code></div></pre>
<h2>ADD / COPY</h2>
<p><code node="[object Object]">&lt;src&gt;</code> で指定したファイル,ディレクトリをコンテナ内の <code node="[object Object]">&lt;dest&gt;</code> にコピーする.</p>
<p>ADD はリモートファイルをコピー可能で圧縮ファイルの解凍する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-bash" style="white-space:pre"><span>ADD &lt;src&gt; &lt;dest&gt;
</span>COPY &lt;src&gt; &lt;dest&gt;
</code></div></pre>
<h2>docker-compose</h2>
<h2>build</h2>
<p>構築時のオプションを指定.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.8&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  webapp:</span><span>
</span><span></span><span style="color:#bf79db">  build:</span><span> ./dir</span></code></div></pre>
<p><code node="[object Object]">context</code> で <code node="[object Object]">Dockerfile</code> や <code node="[object Object]">args</code> を指定できる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.8&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  webapp:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span>
</span><span></span><span style="color:#bf79db">      context:</span><span> ./dir
</span><span></span><span style="color:#bf79db">      dockerfile:</span><span> Dockerfile-alternate
</span><span></span><span style="color:#bf79db">      args:</span><span>
</span><span></span><span style="color:#bf79db">        buildno:</span><span> </span><span class="hljs-number">1</span></code></div></pre>
<p><code node="[object Object]">image</code> を指定してイメージ名とタグをアタッチできる.</p>
<p>イメージ名は webapp で, タグが tag の場合.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span> ./dir
</span><span></span><span style="color:#bf79db">image:</span><span> webapp:tag</span></code></div></pre>
<h3>context</h3>
<p>Dockerfile を含むディレクトリかリポジトリ URL を指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> ./dir</span></code></div></pre>
<h3>dockerfile</h3>
<p>別の Dockerfile を指定する.ビルドパスと同時に指定する必要がある.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> .
</span><span></span><span style="color:#bf79db">  dockerfile:</span><span> Dockerfile-alternate</span></code></div></pre>
<h3>args</h3>
<p>ビルド引数を追加する.環境変数となりビルド処理の間のみ使用される.
Dockerfile 内ではじめにビルド引数を指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#f92672;font-weight:bold">ARG</span><span> buildno
</span><span></span><span style="color:#f92672;font-weight:bold">ARG</span><span> gitcommithash
</span>
<span></span><span style="color:#f92672;font-weight:bold">RUN</span><span class="bash"> </span><span class="bash" style="color:#a6e22e">echo</span><span class="bash"> </span><span class="bash" style="color:#a6e22e">&quot;Build number: </span><span class="bash" style="color:#a6e22e">$buildno</span><span class="bash" style="color:#a6e22e">&quot;</span><span>
</span><span></span><span style="color:#f92672;font-weight:bold">RUN</span><span class="bash"> </span><span class="bash" style="color:#a6e22e">echo</span><span class="bash"> </span><span class="bash" style="color:#a6e22e">&quot;Based on commit: </span><span class="bash" style="color:#a6e22e">$gitcommithash</span><span class="bash" style="color:#a6e22e">&quot;</span></code></div></pre>
<p><code node="[object Object]">build</code> キーをもとにその引数を指定する.</p>
<p>個々をマッピングするか,リスト形式で書く.
ブール値の場合はクォートで囲む必要がある.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">build:</span><span>
</span><span></span><span style="color:#bf79db">  context:</span><span> .
</span><span></span><span style="color:#bf79db">  args:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span> </span><span class="hljs-number">1</span><span>
</span><span></span><span style="color:#bf79db">    gitcommithash:</span><span> cdc3b19</span></code></div></pre>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>build:
</span>  context: .
<!-- -->  args:
<span>    - </span><span class="hljs-attr">buildno</span><span>=</span><span class="hljs-number">1</span><span>
</span><span>    - </span><span class="hljs-attr">gitcommithash</span><span>=cdc3b19</span></code></div></pre>
<h2>command</h2>
<p>デフォルトコマンドを上書きする.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#a6e22e">command</span><span>: build </span><span style="color:#a6e22e">exec</span><span> thin -p 3000</span></code></div></pre>
<p>Dockerfile と同じリスト形式でも書ける.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>command: [</span><span style="color:#a6e22e">&quot;build&quot;</span><span>, </span><span style="color:#a6e22e">&quot;exec&quot;</span><span>, </span><span style="color:#a6e22e">&quot;thin&quot;</span><span>, </span><span style="color:#a6e22e">&quot;-p&quot;</span><span>, </span><span style="color:#a6e22e">&quot;3000&quot;</span><span>]</span></code></div></pre>
<h2>depends_on</h2>
<p>サービス間の依存関係を表す.
<code node="[object Object]">docker-compose up</code> は依存関係順にサービスを起動する.</p>
<p>以下の場合では, db と Redis を起動したあとに web を起動する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.8&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  web:</span><span>
</span><span></span><span style="color:#bf79db">    build:</span><span> .
</span><span></span><span style="color:#bf79db">    depends_on:</span><span>
</span>      - db
<!-- -->      - redis
<span></span><span style="color:#bf79db">  redis:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> redis
</span><span></span><span style="color:#bf79db">  db:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> postgres</span></code></div></pre>
<h2>environment</h2>
<p>環境変数を追加する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">environment:</span><span>
</span><span></span><span style="color:#bf79db">  RACK_ENV:</span><span> development
</span><span></span><span style="color:#bf79db">  SHOW:</span><span> </span><span style="color:#a6e22e">&#x27;true&#x27;</span></code></div></pre>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>environment:
</span><span>  - </span><span class="hljs-attr">RACK_ENV</span><span>=development
</span><span>  - </span><span class="hljs-attr">SHOW</span><span>=</span><span style="color:#a6e22e">&#x27;true&#x27;</span></code></div></pre>
<h2>expose</h2>
<p>ホストマシンにはポートを公開せずにポートを expose する.
リンクされたサービスのみアクセス可能になる.内部のポートのみ指定可能.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>expose:
</span><span>  -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;3000&quot;</span><span class="ruby">
</span><span class="ruby"></span><span>  -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;8000&quot;</span></code></div></pre>
<h2>ports</h2>
<p>公開用のポートを指定する.</p>
<p>ホスト側とコンテナ側のポートを指定する( <code node="[object Object]">HOST:CONTAINER</code> ).
もしくは,コンテナ側のポートを指定する.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">ports</span><span>:
</span><span>  - &quot;</span><span style="color:#bf79db">3000</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">3000</span><span>-</span><span class="hljs-number">3005</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">8000</span><span>:</span><span class="hljs-number">8000</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">9090</span><span>-</span><span class="hljs-number">9091</span><span>:</span><span class="hljs-number">8080</span><span>-</span><span class="hljs-number">8081</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">49100</span><span>:</span><span class="hljs-number">22</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">127.0.0.1:8001</span><span>:</span><span class="hljs-number">8001</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">127.0.0.1:5000</span><span>-</span><span class="hljs-number">5010</span><span>:</span><span class="hljs-number">5000</span><span>-</span><span class="hljs-number">5010</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">6060</span><span>:</span><span class="hljs-number">6060</span><span>/udp</span><span style="color:#a6e22e">&quot;
</span><span style="color:#a6e22e">  - &quot;</span><span class="hljs-number">12400</span><span>-</span><span class="hljs-number">12500</span><span>:</span><span class="hljs-number">1240</span><span style="color:#a6e22e">&quot;</span></code></div></pre>
<p>追加項目がある場合.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span class="hljs-attr">ports:</span><span>
</span><span>  </span><span style="color:#a6e22e">-</span><span> </span><span class="hljs-attr">target:</span><span> </span><span class="hljs-number">80</span><span>
</span><span>    </span><span class="hljs-attr">published:</span><span> </span><span class="hljs-number">8080</span><span>
</span><span>    </span><span class="hljs-attr">protocol:</span><span> </span><span style="color:#a6e22e">tcp</span><span>
</span><span>    </span><span class="hljs-attr">mode:</span><span> </span><span style="color:#a6e22e">host</span></code></div></pre>
<h2>links</h2>
<p>他のサービスのコンテナをリンクさせる.
リンクされたコンテナは,ホスト名より到達可能になる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>web:
</span>  links:
<span>    -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;db&quot;</span><span class="ruby">
</span><span class="ruby"></span><span>    -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;db:database&quot;</span><span class="ruby">
</span><span class="ruby"></span><span>    -</span><span class="ruby"> </span><span class="ruby" style="color:#a6e22e">&quot;redis&quot;</span></code></div></pre>
<h2>volumes</h2>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">version:</span><span> </span><span style="color:#a6e22e">&quot;3.8&quot;</span><span>
</span><span></span><span style="color:#bf79db">services:</span><span>
</span><span></span><span style="color:#bf79db">  web:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> nginx:alpine
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span>      - type: volume
<span></span><span style="color:#bf79db">        source:</span><span> mydata
</span><span></span><span style="color:#bf79db">        target:</span><span> /data
</span><span></span><span style="color:#bf79db">        volume:</span><span>
</span><span></span><span style="color:#bf79db">          nocopy:</span><span> true
</span>      - type: bind
<span></span><span style="color:#bf79db">        source:</span><span> ./static
</span><span></span><span style="color:#bf79db">        target:</span><span> </span><span class="hljs-meta-keyword">/opt/</span><span>app/static
</span><span></span><span style="color:#bf79db">  db:</span><span>
</span><span></span><span style="color:#bf79db">    image:</span><span> postgres:latest
</span><span></span><span style="color:#bf79db">    volumes:</span><span>
</span><span>      - </span><span style="color:#a6e22e">&quot;/var/run/postgres.sock:/var/run/postgres/postgres.sock&quot;</span><span>
</span><span>      - </span><span style="color:#a6e22e">&quot;dbdata:/var/lib/postgresql/data&quot;</span><span>
</span><span></span><span style="color:#bf79db">volumes:</span><span>
</span><span></span><span style="color:#bf79db">  mydata:</span><span>
</span><span></span><span style="color:#bf79db">  database:</span></code></div></pre>
<p>短い書き方では <code node="[object Object]">[SOURCE:]TARGET[:MODE]</code> と書ける.</p>
<p>ro は readonly .</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span>- ./cache:</span><span style="color:#bf79db">/tmp/</span><span>cache:ro</span></code></div></pre>
<h2>変数の置換</h2>
<p>シェル環境に <code node="[object Object]">POSTGRES_VERSION=9.3</code> が定義されていると postgres のバージョンは 9.3 になる.</p>
<pre><div node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-yml" style="white-space:pre"><span style="color:#bf79db">db:</span><span>
</span><span></span><span style="color:#bf79db">  image:</span><span> </span><span style="color:#a6e22e">&quot;postgres:${POSTGRES_VERSION}&quot;</span></code></div></pre>
<p>環境変数が何も設定されていない場合は空文字になる.
環境変数のデフォルト値は <code node="[object Object]">.env</code> ファイルに設定しておくことができる.</p>
<ul>
<li>${VARIABLE:-default} は VARIABLE がセットされていないか空文字のときに <code node="[object Object]">default</code> として評価される</li>
<li>${VARIABLE-default} は VARIABLE がセットされていないときのみ <code node="[object Object]">default</code> として評価される</li>
</ul></div><br/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"docBody":{"id":"20210306225218","title":"Docker と docker-compose のまとめ","content":"\n## Docker\n## build\nDockerfile が存在するディレクトリで実行.\n```bash\n$ docker build .\n```\n\n`-f` オプションを付けることでパスを指定できる.\n```bash\n$ docker build -f /path/to/Dockerfile .\n```\n\n`-t` オプションを付けることでリポジトリとタグを指定できる.\n```bash\n$ docker build -t shukes/myapp .\n```\n\n## FROM\nベースイメージを指定.\n```Dockerfile\nFROM \u003cimage\u003e[:\u003ctag\u003e][AS \u003cname\u003e]\n```\n\n## RUN\nシェルとして実行される.\n```Dockerfile\nRUN /bin/bash -c 'source $HOME/.bashrc;' \\\necho $HOME\n```\n\n1 行で書く場合.\n```Dockerfile\nRUN /bin/bash -c 'source $HOME/.bashrc; echo $HOME'\n```\n\n`/bash/sh` 以外の別のシェルを使う場合は exec 形式でシェルに引数を渡す.\n```Dockerfile\nRUN [\"/bin/bash\", \"-c\", \"echo hello\"]\n```\n\nexec 形式で書く場合は json 配列として扱われるので `\"\"` で囲む必要がある.\n\n## CMD\nDockerfile 内で CMD 命令は 1 つのみ.\n複数あっても最後の CMD 命令のみが実行される.\n\n**CMD の主目的はコンテナ実行時のデフォルト処理を指定する**\n```Dockerfile\nFROM ubuntu\nCMD [\"/usr/bin/wc\", \"--help\"]\n```\n\n## ADD / COPY\n`\u003csrc\u003e` で指定したファイル,ディレクトリをコンテナ内の `\u003cdest\u003e` にコピーする.\n\nADD はリモートファイルをコピー可能で圧縮ファイルの解凍する.\n```bash\nADD \u003csrc\u003e \u003cdest\u003e\nCOPY \u003csrc\u003e \u003cdest\u003e\n```\n\n## docker-compose\n## build\n構築時のオプションを指定.\n```yml\nversion: \"3.8\"\nservices:\n  webapp:\n  build: ./dir\n```\n\n`context` で `Dockerfile` や `args` を指定できる.\n```yml\nversion: \"3.8\"\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1\n```\n\n`image` を指定してイメージ名とタグをアタッチできる.\n\nイメージ名は webapp で, タグが tag の場合.\n```yml\nbuild: ./dir\nimage: webapp:tag\n```\n\n### context\nDockerfile を含むディレクトリかリポジトリ URL を指定する.\n```yml\nbuild:\n  context: ./dir\n```\n\n### dockerfile\n別の Dockerfile を指定する.ビルドパスと同時に指定する必要がある.\n```yml\nbuild:\n  context: .\n  dockerfile: Dockerfile-alternate\n```\n\n### args\nビルド引数を追加する.環境変数となりビルド処理の間のみ使用される.\nDockerfile 内ではじめにビルド引数を指定する.\n```yml\nARG buildno\nARG gitcommithash\n\nRUN echo \"Build number: $buildno\"\nRUN echo \"Based on commit: $gitcommithash\"\n```\n\n`build` キーをもとにその引数を指定する.\n\n個々をマッピングするか,リスト形式で書く.\nブール値の場合はクォートで囲む必要がある.\n```yml\nbuild:\n  context: .\n  args:\n    build: 1\n    gitcommithash: cdc3b19\n```\n\n```yml\nbuild:\n  context: .\n  args:\n    - buildno=1\n    - gitcommithash=cdc3b19\n```\n\n## command\nデフォルトコマンドを上書きする.\n```yml\ncommand: build exec thin -p 3000\n```\n\nDockerfile と同じリスト形式でも書ける.\n```yml\ncommand: [\"build\", \"exec\", \"thin\", \"-p\", \"3000\"]\n```\n\n## depends_on\nサービス間の依存関係を表す.\n`docker-compose up` は依存関係順にサービスを起動する.\n\n以下の場合では, db と Redis を起動したあとに web を起動する.\n```yml\nversion: \"3.8\"\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n  redis:\n    image: redis\n  db:\n    image: postgres\n```\n\n## environment\n環境変数を追加する.\n```yml\nenvironment:\n  RACK_ENV: development\n  SHOW: 'true'\n```\n\n```yml\nenvironment:\n  - RACK_ENV=development\n  - SHOW='true'\n```\n\n## expose\nホストマシンにはポートを公開せずにポートを expose する.\nリンクされたサービスのみアクセス可能になる.内部のポートのみ指定可能.\n```yml\nexpose:\n  - \"3000\"\n  - \"8000\"\n```\n\n## ports\n公開用のポートを指定する.\n\nホスト側とコンテナ側のポートを指定する( `HOST:CONTAINER` ).\nもしくは,コンテナ側のポートを指定する.\n```yml\nports:\n  - \"3000\"\n  - \"3000-3005\"\n  - \"8000:8000\"\n  - \"9090-9091:8080-8081\"\n  - \"49100:22\"\n  - \"127.0.0.1:8001:8001\"\n  - \"127.0.0.1:5000-5010:5000-5010\"\n  - \"6060:6060/udp\"\n  - \"12400-12500:1240\"\n```\n\n追加項目がある場合.\n```yml\nports:\n  - target: 80\n    published: 8080\n    protocol: tcp\n    mode: host\n```\n\n## links\n他のサービスのコンテナをリンクさせる.\nリンクされたコンテナは,ホスト名より到達可能になる.\n```yml\nweb:\n  links:\n    - \"db\"\n    - \"db:database\"\n    - \"redis\"\n```\n\n## volumes\n```yml\nversion: \"3.8\"\nservices:\n  web:\n    image: nginx:alpine\n    volumes:\n      - type: volume\n        source: mydata\n        target: /data\n        volume:\n          nocopy: true\n      - type: bind\n        source: ./static\n        target: /opt/app/static\n  db:\n    image: postgres:latest\n    volumes:\n      - \"/var/run/postgres.sock:/var/run/postgres/postgres.sock\"\n      - \"dbdata:/var/lib/postgresql/data\"\nvolumes:\n  mydata:\n  database:\n```\n\n短い書き方では `[SOURCE:]TARGET[:MODE]` と書ける.\n\nro は readonly .\n```yml\n- ./cache:/tmp/cache:ro\n```\n\n## 変数の置換\nシェル環境に `POSTGRES_VERSION=9.3` が定義されていると postgres のバージョンは 9.3 になる.\n```yml\ndb:\n  image: \"postgres:${POSTGRES_VERSION}\"\n```\n\n環境変数が何も設定されていない場合は空文字になる.\n環境変数のデフォルト値は `.env` ファイルに設定しておくことができる.\n- ${VARIABLE:-default} は VARIABLE がセットされていないか空文字のときに `default` として評価される\n- ${VARIABLE-default} は VARIABLE がセットされていないときのみ `default` として評価される\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20210306225218"},"buildId":"jMPZ-oWD6b9SVbil7VCD9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>