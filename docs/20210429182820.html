<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>MyDocs</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/a58c9bb1e05a64ba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a58c9bb1e05a64ba.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-d38be8d96a62f950.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-4c0bfde4693f048b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/996-96c017f2628f3a7d.js" defer=""></script><script src="/_next/static/chunks/238-6c9572b4a47f3e2a.js" defer=""></script><script src="/_next/static/chunks/pages/docs/%5Bid%5D-11871a0dd3bce32a.js" defer=""></script><script src="/_next/static/WO88-BZ4H50Eu4wzY2ZqE/_buildManifest.js" defer=""></script><script src="/_next/static/WO88-BZ4H50Eu4wzY2ZqE/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><a style="text-decoration:none" href="/"><div style="color:black;font-size:22px;cursor:pointer">MyDocs</div></a></div><p></p><h1><b># <!-- -->Golang の 並列 / 並行 処理でいろいろ</b></h1><h2>並列 / 並行 処理</h2>
<ul>
<li>並列処理<!-- -->
<ul>
<li>Parallelism<!-- -->
<ul>
<li>同時に同じ処理が複数走る</li>
</ul>
</li>
</ul>
</li>
<li>並行処理<!-- -->
<ul>
<li>Concurrency<!-- -->
<ul>
<li>同時に色々な処理が走る</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>channel を使う</h2>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">process</span><span class="hljs-function hljs-params">(num </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, str </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; num; i++ {
</span><span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span>		fmt.Println(i, str)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Start&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;A&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;B&quot;</span><span>)
</span><span>	process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;C&quot;</span><span>)
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Finish&quot;</span><span>)
</span>}
<!-- -->
<span></span><span style="color:#75715e">// Start</span><span>
</span><span></span><span style="color:#75715e">// 0 A</span><span>
</span><span></span><span style="color:#75715e">// 1 A</span><span>
</span><span></span><span style="color:#75715e">// 0 B</span><span>
</span><span></span><span style="color:#75715e">// 1 B</span><span>
</span><span></span><span style="color:#75715e">// 0 C</span><span>
</span><span></span><span style="color:#75715e">// 1 C</span><span>
</span><span></span><span style="color:#75715e">// Finish</span><span>
</span><span></span><span style="color:#75715e">// </span><span>
</span><span></span><span style="color:#75715e">// ________________________________________________________</span><span>
</span><span></span><span style="color:#75715e">// Executed in    6.30 secs      fish           external</span><span>
</span><span></span><span style="color:#75715e">//    usr time  192.00 millis  172.00 micros  191.83 millis</span><span>
</span><span></span><span style="color:#75715e">//    sys time  201.91 millis  759.00 micros  201.15 millis</span></code></pre></div></pre>
<p>process の処理を並列化する。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">process</span><span class="hljs-function hljs-params">(num </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">int</span><span class="hljs-function hljs-params">, str </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; num; i++ {
</span><span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span>		fmt.Println(i, str)
<!-- -->	}
<!-- -->}
<!-- -->
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	chA := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	chB := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	chC := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">bool</span><span>)
</span><span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Start&quot;</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;A&quot;</span><span>)
</span><span>		chA &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;B&quot;</span><span>)
</span><span>		chB &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		process(</span><span class="hljs-number">2</span><span>, </span><span style="color:#a6e22e">&quot;C&quot;</span><span>)
</span><span>		chC &lt;- </span><span style="color:#f92672;font-weight:bold">true</span><span>
</span>	}()
<!-- -->
<!-- -->	&lt;-chA
<!-- -->	&lt;-chB
<!-- -->	&lt;-chC
<!-- -->
<span>	fmt.Println(</span><span style="color:#a6e22e">&quot;Finish&quot;</span><span>)
</span>}
<!-- -->
<span></span><span style="color:#75715e">// Start</span><span>
</span><span></span><span style="color:#75715e">// 0 B</span><span>
</span><span></span><span style="color:#75715e">// 0 A</span><span>
</span><span></span><span style="color:#75715e">// 0 C</span><span>
</span><span></span><span style="color:#75715e">// 1 C</span><span>
</span><span></span><span style="color:#75715e">// 1 A</span><span>
</span><span></span><span style="color:#75715e">// 1 B</span><span>
</span><span></span><span style="color:#75715e">// Finish</span><span>
</span><span></span><span style="color:#75715e">// </span><span>
</span><span></span><span style="color:#75715e">// ________________________________________________________</span><span>
</span><span></span><span style="color:#75715e">// Executed in    2.29 secs      fish           external</span><span>
</span><span></span><span style="color:#75715e">//    usr time  194.02 millis  178.00 micros  193.84 millis</span><span>
</span><span></span><span style="color:#75715e">//    sys time  207.43 millis  862.00 micros  206.57 millis</span></code></pre></div></pre>
<h2>sync.WaitGroup を使う</h2>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Item </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	Id   </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Name </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">execLoop</span><span class="hljs-function hljs-params">(list []Item)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, item := </span><span style="color:#f92672;font-weight:bold">range</span><span> list {
</span>		doSomething(item)
<!-- -->	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">doSomething</span><span class="hljs-function hljs-params">(item Item)</span><span> {
</span><span>	item.Id += </span><span class="hljs-number">10</span><span>
</span>	fmt.Println(item)
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span>	list := []Item{
<span>		{Id: </span><span class="hljs-number">1</span><span>, Name: </span><span style="color:#a6e22e">&quot;item1&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">2</span><span>, Name: </span><span style="color:#a6e22e">&quot;item2&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">3</span><span>, Name: </span><span style="color:#a6e22e">&quot;item3&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">4</span><span>, Name: </span><span style="color:#a6e22e">&quot;item4&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">5</span><span>, Name: </span><span style="color:#a6e22e">&quot;item5&quot;</span><span>},
</span>	}
<!-- -->
<!-- -->	execLoop(list)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// {11 item1}</span><span>
</span><span></span><span style="color:#75715e">// {12 item2}</span><span>
</span><span></span><span style="color:#75715e">// {13 item3}</span><span>
</span><span></span><span style="color:#75715e">// {14 item4}</span><span>
</span><span></span><span style="color:#75715e">// {15 item5}</span></code></pre></div></pre>
<p>ループ内の処理を並列化する。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> Item </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	Id   </span><span style="color:#f92672;font-weight:bold">int</span><span>
</span><span>	Name </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">execLoop</span><span class="hljs-function hljs-params">(list []Item)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, item := </span><span style="color:#f92672;font-weight:bold">range</span><span> list {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(item2 Item)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span>			doSomething(item2)
<!-- -->		}(item)
<!-- -->	}
<!-- -->	wg.Wait()
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">doSomething</span><span class="hljs-function hljs-params">(item Item)</span><span> {
</span><span>	item.Id += </span><span class="hljs-number">10</span><span>
</span>	fmt.Println(item)
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span>	list := []Item{
<span>		{Id: </span><span class="hljs-number">1</span><span>, Name: </span><span style="color:#a6e22e">&quot;item1&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">2</span><span>, Name: </span><span style="color:#a6e22e">&quot;item2&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">3</span><span>, Name: </span><span style="color:#a6e22e">&quot;item3&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">4</span><span>, Name: </span><span style="color:#a6e22e">&quot;item4&quot;</span><span>},
</span><span>		{Id: </span><span class="hljs-number">5</span><span>, Name: </span><span style="color:#a6e22e">&quot;item5&quot;</span><span>},
</span>	}
<!-- -->
<!-- -->	execLoop(list)
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// {15 item5}</span><span>
</span><span></span><span style="color:#75715e">// {11 item1}</span><span>
</span><span></span><span style="color:#75715e">// {14 item4}</span><span>
</span><span></span><span style="color:#75715e">// {13 item3}</span><span>
</span><span></span><span style="color:#75715e">// {12 item2}</span></code></pre></div></pre>
<h2>sync.Mutex を使う</h2>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> </span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span>
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>		tmpObj.AttributeName = myObj.AttributeName
<span>		destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>	}
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 100</span></code></pre></div></pre>
<p>sync.WaitGroup を使う。 ( ダメな例 )
append はスレッドセーフではないので件数が減る。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(myObj2 myClass)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span><span>			</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>			tmpObj.AttributeName = myObj2.AttributeName
<span>			destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>		}(myObj)
<!-- -->	}
<!-- -->	wg.Wait()
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 75</span></code></pre></div></pre>
<p><code>-race</code> を付けることで競合のチェックができる。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">bash</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-shell" style="white-space:pre"><span style="color:#75715e">$</span><span class="bash"> go run -race main.go</span><span>
</span>
<!-- -->~~ 省略 ~~
<!-- -->==================
<!-- -->97</code></pre></div></pre>
<p>sync.Mutex を使う。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span>)
<!-- -->
<span></span><span style="color:#f92672;font-weight:bold">type</span><span> myClass </span><span style="color:#f92672;font-weight:bold">struct</span><span> {
</span><span>	AttributeName </span><span style="color:#f92672;font-weight:bold">string</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	sourceSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">100</span><span>)
</span><span>	destSlice := </span><span style="color:#a6e22e">make</span><span>([]myClass, </span><span class="hljs-number">0</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span>	mu := &amp;sync.Mutex{}
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> _, myObj := </span><span style="color:#f92672;font-weight:bold">range</span><span> sourceSlice {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">(myObj2 myClass)</span><span> {
</span><span>			</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span><span>			</span><span style="color:#f92672;font-weight:bold">var</span><span> tmpObj myClass
</span>			tmpObj.AttributeName = myObj2.AttributeName
<!-- -->			mu.Lock()
<span>			destSlice = </span><span style="color:#a6e22e">append</span><span>(destSlice, tmpObj)
</span>			mu.Unlock()
<!-- -->		}(myObj)
<!-- -->	}
<!-- -->	wg.Wait()
<span>	fmt.Println(</span><span style="color:#a6e22e">len</span><span>(destSlice))
</span>}
<!-- -->
<span></span><span style="color:#75715e">// 100</span></code></pre></div></pre>
<h2>ポーリング</h2>
<p><code>len(q)</code> は溜まったバッファ数を返す。
<code>make</code> で作るときはバッファ数を 2 以上で作らないと <code>len(q)</code> は常に 0 を返す。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	q := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">struct</span><span>{}, </span><span class="hljs-number">2</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">go</span><span> </span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>		</span><span style="color:#75715e">// 重たい処理</span><span>
</span><span>		time.Sleep(</span><span class="hljs-number">3</span><span> * time.Second)
</span><span>		q &lt;- </span><span style="color:#f92672;font-weight:bold">struct</span><span>{}{}
</span>	}()
<!-- -->
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span><span>		</span><span style="color:#f92672;font-weight:bold">if</span><span> </span><span style="color:#a6e22e">len</span><span>(q) &gt; </span><span class="hljs-number">0</span><span> {
</span><span>			fmt.Println(</span><span style="color:#a6e22e">&quot;完了&quot;</span><span>)
</span><span>			</span><span style="color:#f92672;font-weight:bold">break</span><span>
</span>		}
<span>		time.Sleep(</span><span class="hljs-number">1</span><span> * time.Second)
</span><span>		fmt.Println(</span><span style="color:#a6e22e">&quot;実行中&quot;</span><span>)
</span>	}
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 実行中</span><span>
</span><span></span><span style="color:#75715e">// 完了</span></code></pre></div></pre>
<h2>ワーカー</h2>
<p><code>close(q)</code> されたら <code>str, ok := &lt;- q</code> の <code>ok</code> が <code>false</code> になる。</p>
<pre><div class="sc-bgqQcB dzTJyN"><div class="sc-gTRrQi bBvEVj">go</div><pre node="[object Object]" style="display:block;overflow-x:auto;padding:0.5em;background:#272822;color:#ddd"><code class="language-go" style="white-space:pre"><span style="color:#f92672;font-weight:bold">package</span><span> main
</span>
<span></span><span style="color:#f92672;font-weight:bold">import</span><span> (
</span><span>	</span><span style="color:#a6e22e">&quot;fmt&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;sync&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">&quot;time&quot;</span><span>
</span>)
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">printString</span><span class="hljs-function hljs-params">(wg *sync.WaitGroup, q </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">chan</span><span class="hljs-function hljs-params"> </span><span class="hljs-function hljs-params" style="color:#f92672;font-weight:bold">string</span><span class="hljs-function hljs-params">)</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">defer</span><span> wg.Done()
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> {
</span>		str, ok := &lt;-q
<span>		</span><span style="color:#f92672;font-weight:bold">if</span><span> !ok {
</span><span>			</span><span style="color:#f92672;font-weight:bold">return</span><span>
</span>		}
<!-- -->
<!-- -->		fmt.Println(str)
<span>		time.Sleep(</span><span class="hljs-number">3</span><span> * time.Second)
</span>	}
<!-- -->}
<!-- -->
<span></span><span class="hljs-function" style="color:#f92672;font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#a6e22e;font-weight:bold">main</span><span class="hljs-function hljs-params">()</span><span> {
</span><span>	</span><span style="color:#f92672;font-weight:bold">const</span><span> workerNum = </span><span class="hljs-number">3</span><span>
</span><span>	</span><span style="color:#f92672;font-weight:bold">var</span><span> wg sync.WaitGroup
</span><span>	q := </span><span style="color:#a6e22e">make</span><span>(</span><span style="color:#f92672;font-weight:bold">chan</span><span> </span><span style="color:#f92672;font-weight:bold">string</span><span>, </span><span class="hljs-number">5</span><span>)
</span>
<span>	</span><span style="color:#f92672;font-weight:bold">for</span><span> i := </span><span class="hljs-number">0</span><span>; i &lt; workerNum; i++ {
</span><span>		wg.Add(</span><span class="hljs-number">1</span><span>)
</span><span>		</span><span style="color:#f92672;font-weight:bold">go</span><span> printString(&amp;wg, q)
</span>	}
<!-- -->
<span>	q &lt;- </span><span style="color:#a6e22e">&quot;test1&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test2&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test3&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test4&quot;</span><span>
</span><span>	q &lt;- </span><span style="color:#a6e22e">&quot;test5&quot;</span><span>
</span><span>	</span><span style="color:#a6e22e">close</span><span>(q)
</span>	wg.Wait()
<!-- -->}
<!-- -->
<span></span><span style="color:#75715e">// test2</span><span>
</span><span></span><span style="color:#75715e">// test1</span><span>
</span><span></span><span style="color:#75715e">// test3</span><span>
</span><span></span><span style="color:#75715e">// test5</span><span>
</span><span></span><span style="color:#75715e">// test4</span></code></pre></div></pre></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"contents":{"id":"20210429182820","title":"Golang の 並列 / 並行 処理でいろいろ","body":"\n## 並列 / 並行 処理\n- 並列処理\n  - Parallelism\n    - 同時に同じ処理が複数走る\n- 並行処理\n  - Concurrency\n    - 同時に色々な処理が走る\n\n## channel を使う\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc process(num int, str string) {\n\tfor i := 0; i \u003c num; i++ {\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(i, str)\n\t}\n}\n\nfunc main() {\n\tfmt.Println(\"Start\")\n\tprocess(2, \"A\")\n\tprocess(2, \"B\")\n\tprocess(2, \"C\")\n\tfmt.Println(\"Finish\")\n}\n\n// Start\n// 0 A\n// 1 A\n// 0 B\n// 1 B\n// 0 C\n// 1 C\n// Finish\n// \n// ________________________________________________________\n// Executed in    6.30 secs      fish           external\n//    usr time  192.00 millis  172.00 micros  191.83 millis\n//    sys time  201.91 millis  759.00 micros  201.15 millis\n```\n\nprocess の処理を並列化する。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc process(num int, str string) {\n\tfor i := 0; i \u003c num; i++ {\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(i, str)\n\t}\n}\n\n\nfunc main() {\n\tchA := make(chan bool)\n\tchB := make(chan bool)\n\tchC := make(chan bool)\n\tfmt.Println(\"Start\")\n\n\tgo func() {\n\t\tprocess(2, \"A\")\n\t\tchA \u003c- true\n\t}()\n\n\tgo func() {\n\t\tprocess(2, \"B\")\n\t\tchB \u003c- true\n\t}()\n\n\tgo func() {\n\t\tprocess(2, \"C\")\n\t\tchC \u003c- true\n\t}()\n\n\t\u003c-chA\n\t\u003c-chB\n\t\u003c-chC\n\n\tfmt.Println(\"Finish\")\n}\n\n// Start\n// 0 B\n// 0 A\n// 0 C\n// 1 C\n// 1 A\n// 1 B\n// Finish\n// \n// ________________________________________________________\n// Executed in    2.29 secs      fish           external\n//    usr time  194.02 millis  178.00 micros  193.84 millis\n//    sys time  207.43 millis  862.00 micros  206.57 millis\n```\n\n## sync.WaitGroup を使う\n```go\npackage main\n\nimport \"fmt\"\n\ntype Item struct {\n\tId   int\n\tName string\n}\n\nfunc execLoop(list []Item) {\n\tfor _, item := range list {\n\t\tdoSomething(item)\n\t}\n}\n\nfunc doSomething(item Item) {\n\titem.Id += 10\n\tfmt.Println(item)\n}\n\nfunc main() {\n\tlist := []Item{\n\t\t{Id: 1, Name: \"item1\"},\n\t\t{Id: 2, Name: \"item2\"},\n\t\t{Id: 3, Name: \"item3\"},\n\t\t{Id: 4, Name: \"item4\"},\n\t\t{Id: 5, Name: \"item5\"},\n\t}\n\n\texecLoop(list)\n}\n\n// {11 item1}\n// {12 item2}\n// {13 item3}\n// {14 item4}\n// {15 item5}\n```\n\nループ内の処理を並列化する。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype Item struct {\n\tId   int\n\tName string\n}\n\nfunc execLoop(list []Item) {\n\tvar wg sync.WaitGroup\n\tfor _, item := range list {\n\t\twg.Add(1)\n\t\tgo func(item2 Item) {\n\t\t\tdefer wg.Done()\n\t\t\tdoSomething(item2)\n\t\t}(item)\n\t}\n\twg.Wait()\n}\n\nfunc doSomething(item Item) {\n\titem.Id += 10\n\tfmt.Println(item)\n}\n\nfunc main() {\n\tlist := []Item{\n\t\t{Id: 1, Name: \"item1\"},\n\t\t{Id: 2, Name: \"item2\"},\n\t\t{Id: 3, Name: \"item3\"},\n\t\t{Id: 4, Name: \"item4\"},\n\t\t{Id: 5, Name: \"item5\"},\n\t}\n\n\texecLoop(list)\n}\n\n// {15 item5}\n// {11 item1}\n// {14 item4}\n// {13 item3}\n// {12 item2}\n```\n\n## sync.Mutex を使う\n```go\npackage main\n\nimport \"fmt\"\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tfor _, myObj := range sourceSlice {\n\t\tvar tmpObj myClass\n\t\ttmpObj.AttributeName = myObj.AttributeName\n\t\tdestSlice = append(destSlice, tmpObj)\n\t}\n\tfmt.Println(len(destSlice))\n}\n\n// 100\n```\n\nsync.WaitGroup を使う。 ( ダメな例 )\nappend はスレッドセーフではないので件数が減る。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tvar wg sync.WaitGroup\n\tfor _, myObj := range sourceSlice {\n\t\twg.Add(1)\n\t\tgo func(myObj2 myClass) {\n\t\t\tdefer wg.Done()\n\t\t\tvar tmpObj myClass\n\t\t\ttmpObj.AttributeName = myObj2.AttributeName\n\t\t\tdestSlice = append(destSlice, tmpObj)\n\t\t}(myObj)\n\t}\n\twg.Wait()\n\tfmt.Println(len(destSlice))\n}\n\n// 75\n```\n\n`-race` を付けることで競合のチェックができる。\n```bash\n$ go run -race main.go\n\n~~ 省略 ~~\n==================\n97\n```\n\nsync.Mutex を使う。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\ntype myClass struct {\n\tAttributeName string\n}\n\nfunc main() {\n\tsourceSlice := make([]myClass, 100)\n\tdestSlice := make([]myClass, 0)\n\n\tvar wg sync.WaitGroup\n\tmu := \u0026sync.Mutex{}\n\tfor _, myObj := range sourceSlice {\n\t\twg.Add(1)\n\t\tgo func(myObj2 myClass) {\n\t\t\tdefer wg.Done()\n\t\t\tvar tmpObj myClass\n\t\t\ttmpObj.AttributeName = myObj2.AttributeName\n\t\t\tmu.Lock()\n\t\t\tdestSlice = append(destSlice, tmpObj)\n\t\t\tmu.Unlock()\n\t\t}(myObj)\n\t}\n\twg.Wait()\n\tfmt.Println(len(destSlice))\n}\n\n// 100\n```\n\n## ポーリング\n`len(q)` は溜まったバッファ数を返す。\n`make` で作るときはバッファ数を 2 以上で作らないと `len(q)` は常に 0 を返す。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"time\"\n)\n\nfunc main() {\n\tq := make(chan struct{}, 2)\n\n\tgo func() {\n\t\t// 重たい処理\n\t\ttime.Sleep(3 * time.Second)\n\t\tq \u003c- struct{}{}\n\t}()\n\n\tfor {\n\t\tif len(q) \u003e 0 {\n\t\t\tfmt.Println(\"完了\")\n\t\t\tbreak\n\t\t}\n\t\ttime.Sleep(1 * time.Second)\n\t\tfmt.Println(\"実行中\")\n\t}\n}\n\n// 実行中\n// 実行中\n// 実行中\n// 完了\n```\n\n## ワーカー\n`close(q)` されたら `str, ok := \u003c- q` の `ok` が `false` になる。\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n\t\"time\"\n)\n\nfunc printString(wg *sync.WaitGroup, q chan string) {\n\tdefer wg.Done()\n\n\tfor {\n\t\tstr, ok := \u003c-q\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\n\t\tfmt.Println(str)\n\t\ttime.Sleep(3 * time.Second)\n\t}\n}\n\nfunc main() {\n\tconst workerNum = 3\n\tvar wg sync.WaitGroup\n\tq := make(chan string, 5)\n\n\tfor i := 0; i \u003c workerNum; i++ {\n\t\twg.Add(1)\n\t\tgo printString(\u0026wg, q)\n\t}\n\n\tq \u003c- \"test1\"\n\tq \u003c- \"test2\"\n\tq \u003c- \"test3\"\n\tq \u003c- \"test4\"\n\tq \u003c- \"test5\"\n\tclose(q)\n\twg.Wait()\n}\n\n// test2\n// test1\n// test3\n// test5\n// test4\n```\n"}},"__N_SSG":true},"page":"/docs/[id]","query":{"id":"20210429182820"},"buildId":"WO88-BZ4H50Eu4wzY2ZqE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>